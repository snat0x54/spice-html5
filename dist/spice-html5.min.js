"use strict";
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  SpiceArrayBufferSlice
**    This function is a work around for IE 10, which has no slice()
**    method in it's subclass.
**--------------------------------------------------------------------------*/function SpiceArrayBufferSlice(e,t){e=e||0,(t=t||this.byteLength)<0&&(t=this.byteLength+t),e<0&&(e=this.byteLength+e),e<0&&(e=0),t<0&&(t=0),t>this.byteLength&&(t=this.byteLength),t<e&&(e=t);var i,s=new ArrayBuffer(t-e),r=new Uint8Array(this,e,t-e),_=new Uint8Array(s);for(i=0;i<t-e;i++)_[i]=r[i];return s}ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=SpiceArrayBufferSlice,console.log("WARNING:  ArrayBuffer.slice() is missing; we are extending ArrayBuffer to compensate"));
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  enums.js
**      'constants' for Spice
**--------------------------------------------------------------------------*/
var SPICE_MAGIC="REDQ",SPICE_VERSION_MAJOR=2,SPICE_VERSION_MINOR=2,SPICE_CONNECT_TIMEOUT=3e4,SPICE_COMMON_CAP_PROTOCOL_AUTH_SELECTION=0,SPICE_COMMON_CAP_AUTH_SPICE=1,SPICE_COMMON_CAP_AUTH_SASL=2,SPICE_COMMON_CAP_MINI_HEADER=3,SPICE_TICKET_KEY_PAIR_LENGTH=1024,SPICE_TICKET_PUBKEY_BYTES=SPICE_TICKET_KEY_PAIR_LENGTH/8+34,SPICE_LINK_ERR_OK=0,SPICE_LINK_ERR_ERROR=1,SPICE_LINK_ERR_INVALID_MAGIC=2,SPICE_LINK_ERR_INVALID_DATA=3,SPICE_LINK_ERR_VERSION_MISMATCH=4,SPICE_LINK_ERR_NEED_SECURED=5,SPICE_LINK_ERR_NEED_UNSECURED=6,SPICE_LINK_ERR_PERMISSION_DENIED=7,SPICE_LINK_ERR_BAD_CONNECTION_ID=8,SPICE_LINK_ERR_CHANNEL_NOT_AVAILABLE=9,SPICE_MSG_MIGRATE=1,SPICE_MSG_MIGRATE_DATA=2,SPICE_MSG_SET_ACK=3,SPICE_MSG_PING=4,SPICE_MSG_WAIT_FOR_CHANNELS=5,SPICE_MSG_DISCONNECTING=6,SPICE_MSG_NOTIFY=7,SPICE_MSG_LIST=8,SPICE_MSG_MAIN_MIGRATE_BEGIN=101,SPICE_MSG_MAIN_MIGRATE_CANCEL=102,SPICE_MSG_MAIN_INIT=103,SPICE_MSG_MAIN_CHANNELS_LIST=104,SPICE_MSG_MAIN_MOUSE_MODE=105,SPICE_MSG_MAIN_MULTI_MEDIA_TIME=106,SPICE_MSG_MAIN_AGENT_CONNECTED=107,SPICE_MSG_MAIN_AGENT_DISCONNECTED=108,SPICE_MSG_MAIN_AGENT_DATA=109,SPICE_MSG_MAIN_AGENT_TOKEN=110,SPICE_MSG_MAIN_MIGRATE_SWITCH_HOST=111,SPICE_MSG_MAIN_MIGRATE_END=112,SPICE_MSG_MAIN_NAME=113,SPICE_MSG_MAIN_UUID=114,SPICE_MSG_MAIN_AGENT_CONNECTED_TOKENS=115,SPICE_MSG_MAIN_MIGRATE_BEGIN_SEAMLESS=116,SPICE_MSG_MAIN_MIGRATE_DST_SEAMLESS_ACK=117,SPICE_MSG_MAIN_MIGRATE_DST_SEAMLESS_NACK=118,SPICE_MSG_END_MAIN=119,SPICE_MSGC_ACK_SYNC=1,SPICE_MSGC_ACK=2,SPICE_MSGC_PONG=3,SPICE_MSGC_MIGRATE_FLUSH_MARK=4,SPICE_MSGC_MIGRATE_DATA=5,SPICE_MSGC_DISCONNECTING=6,SPICE_MSGC_MAIN_CLIENT_INFO=101,SPICE_MSGC_MAIN_MIGRATE_CONNECTED=102,SPICE_MSGC_MAIN_MIGRATE_CONNECT_ERROR=103,SPICE_MSGC_MAIN_ATTACH_CHANNELS=104,SPICE_MSGC_MAIN_MOUSE_MODE_REQUEST=105,SPICE_MSGC_MAIN_AGENT_START=106,SPICE_MSGC_MAIN_AGENT_DATA=107,SPICE_MSGC_MAIN_AGENT_TOKEN=108,SPICE_MSGC_MAIN_MIGRATE_END=109,SPICE_MSGC_END_MAIN=110,SPICE_MSG_DISPLAY_MODE=101,SPICE_MSG_DISPLAY_MARK=102,SPICE_MSG_DISPLAY_RESET=103,SPICE_MSG_DISPLAY_COPY_BITS=104,SPICE_MSG_DISPLAY_INVAL_LIST=105,SPICE_MSG_DISPLAY_INVAL_ALL_PIXMAPS=106,SPICE_MSG_DISPLAY_INVAL_PALETTE=107,SPICE_MSG_DISPLAY_INVAL_ALL_PALETTES=108,SPICE_MSG_DISPLAY_STREAM_CREATE=122,SPICE_MSG_DISPLAY_STREAM_DATA=123,SPICE_MSG_DISPLAY_STREAM_CLIP=124,SPICE_MSG_DISPLAY_STREAM_DESTROY=125,SPICE_MSG_DISPLAY_STREAM_DESTROY_ALL=126,SPICE_MSG_DISPLAY_DRAW_FILL=302,SPICE_MSG_DISPLAY_DRAW_OPAQUE=303,SPICE_MSG_DISPLAY_DRAW_COPY=304,SPICE_MSG_DISPLAY_DRAW_BLEND=305,SPICE_MSG_DISPLAY_DRAW_BLACKNESS=306,SPICE_MSG_DISPLAY_DRAW_WHITENESS=307,SPICE_MSG_DISPLAY_DRAW_INVERS=308,SPICE_MSG_DISPLAY_DRAW_ROP3=309,SPICE_MSG_DISPLAY_DRAW_STROKE=310,SPICE_MSG_DISPLAY_DRAW_TEXT=311,SPICE_MSG_DISPLAY_DRAW_TRANSPARENT=312,SPICE_MSG_DISPLAY_DRAW_ALPHA_BLEND=313,SPICE_MSG_DISPLAY_SURFACE_CREATE=314,SPICE_MSG_DISPLAY_SURFACE_DESTROY=315,SPICE_MSG_DISPLAY_STREAM_DATA_SIZED=316,SPICE_MSG_DISPLAY_MONITORS_CONFIG=317,SPICE_MSG_DISPLAY_DRAW_COMPOSITE=318,SPICE_MSG_DISPLAY_STREAM_ACTIVATE_REPORT=319,SPICE_MSGC_DISPLAY_INIT=101,SPICE_MSGC_DISPLAY_STREAM_REPORT=102,SPICE_MSG_INPUTS_INIT=101,SPICE_MSG_INPUTS_KEY_MODIFIERS=102,SPICE_MSG_INPUTS_MOUSE_MOTION_ACK=111,SPICE_MSGC_INPUTS_KEY_DOWN=101,SPICE_MSGC_INPUTS_KEY_UP=102,SPICE_MSGC_INPUTS_KEY_MODIFIERS=103,SPICE_MSGC_INPUTS_MOUSE_MOTION=111,SPICE_MSGC_INPUTS_MOUSE_POSITION=112,SPICE_MSGC_INPUTS_MOUSE_PRESS=113,SPICE_MSGC_INPUTS_MOUSE_RELEASE=114,SPICE_MSG_CURSOR_INIT=101,SPICE_MSG_CURSOR_RESET=102,SPICE_MSG_CURSOR_SET=103,SPICE_MSG_CURSOR_MOVE=104,SPICE_MSG_CURSOR_HIDE=105,SPICE_MSG_CURSOR_TRAIL=106,SPICE_MSG_CURSOR_INVAL_ONE=107,SPICE_MSG_CURSOR_INVAL_ALL=108,SPICE_MSG_PLAYBACK_DATA=101,SPICE_MSG_PLAYBACK_MODE=102,SPICE_MSG_PLAYBACK_START=103,SPICE_MSG_PLAYBACK_STOP=104,SPICE_MSG_PLAYBACK_VOLUME=105,SPICE_MSG_PLAYBACK_MUTE=106,SPICE_MSG_PLAYBACK_LATENCY=107,SPICE_MSG_SPICEVMC_DATA=101,SPICE_MSG_PORT_INIT=201,SPICE_MSG_PORT_EVENT=202,SPICE_MSG_END_PORT=203,SPICE_MSGC_SPICEVMC_DATA=101,SPICE_MSGC_PORT_EVENT=201,SPICE_MSGC_END_PORT=202,SPICE_PLAYBACK_CAP_CELT_0_5_1=0,SPICE_PLAYBACK_CAP_VOLUME=1,SPICE_PLAYBACK_CAP_LATENCY=2,SPICE_PLAYBACK_CAP_OPUS=3,SPICE_MAIN_CAP_SEMI_SEAMLESS_MIGRATE=0,SPICE_MAIN_CAP_NAME_AND_UUID=1,SPICE_MAIN_CAP_AGENT_CONNECTED_TOKENS=2,SPICE_MAIN_CAP_SEAMLESS_MIGRATE=3,SPICE_DISPLAY_CAP_SIZED_STREAM=0,SPICE_DISPLAY_CAP_MONITORS_CONFIG=1,SPICE_DISPLAY_CAP_COMPOSITE=2,SPICE_DISPLAY_CAP_A8_SURFACE=3,SPICE_DISPLAY_CAP_STREAM_REPORT=4,SPICE_DISPLAY_CAP_LZ4_COMPRESSION=5,SPICE_DISPLAY_CAP_PREF_COMPRESSION=6,SPICE_DISPLAY_CAP_GL_SCANOUT=7,SPICE_DISPLAY_CAP_MULTI_CODEC=8,SPICE_DISPLAY_CAP_CODEC_MJPEG=9,SPICE_DISPLAY_CAP_CODEC_VP8=10,SPICE_AUDIO_DATA_MODE_INVALID=0,SPICE_AUDIO_DATA_MODE_RAW=1,SPICE_AUDIO_DATA_MODE_CELT_0_5_1=2,SPICE_AUDIO_DATA_MODE_OPUS=3,SPICE_AUDIO_FMT_INVALID=0,SPICE_AUDIO_FMT_S16=1,SPICE_CHANNEL_MAIN=1,SPICE_CHANNEL_DISPLAY=2,SPICE_CHANNEL_INPUTS=3,SPICE_CHANNEL_CURSOR=4,SPICE_CHANNEL_PLAYBACK=5,SPICE_CHANNEL_RECORD=6,SPICE_CHANNEL_TUNNEL=7,SPICE_CHANNEL_SMARTCARD=8,SPICE_CHANNEL_USBREDIR=9,SPICE_CHANNEL_PORT=10,SPICE_CHANNEL_WEBDAV=11,SPICE_SURFACE_FLAGS_PRIMARY=1,SPICE_NOTIFY_SEVERITY_INFO=0,SPICE_NOTIFY_SEVERITY_WARN=1,SPICE_NOTIFY_SEVERITY_ERROR=2,SPICE_MOUSE_MODE_SERVER=1,SPICE_MOUSE_MODE_CLIENT=2,SPICE_MOUSE_MODE_MASK=3,SPICE_CLIP_TYPE_NONE=0,SPICE_CLIP_TYPE_RECTS=1,SPICE_IMAGE_TYPE_BITMAP=0,SPICE_IMAGE_TYPE_QUIC=1,SPICE_IMAGE_TYPE_RESERVED=2,SPICE_IMAGE_TYPE_LZ_PLT=100,SPICE_IMAGE_TYPE_LZ_RGB=101,SPICE_IMAGE_TYPE_GLZ_RGB=102,SPICE_IMAGE_TYPE_FROM_CACHE=103,SPICE_IMAGE_TYPE_SURFACE=104,SPICE_IMAGE_TYPE_JPEG=105,SPICE_IMAGE_TYPE_FROM_CACHE_LOSSLESS=106,SPICE_IMAGE_TYPE_ZLIB_GLZ_RGB=107,SPICE_IMAGE_TYPE_JPEG_ALPHA=108,SPICE_IMAGE_FLAGS_CACHE_ME=1,SPICE_IMAGE_FLAGS_HIGH_BITS_SET=2,SPICE_IMAGE_FLAGS_CACHE_REPLACE_ME=4,SPICE_BITMAP_FLAGS_PAL_CACHE_ME=1,SPICE_BITMAP_FLAGS_PAL_FROM_CACHE=2,SPICE_BITMAP_FLAGS_TOP_DOWN=4,SPICE_BITMAP_FLAGS_MASK=7,SPICE_BITMAP_FMT_INVALID=0,SPICE_BITMAP_FMT_1BIT_LE=1,SPICE_BITMAP_FMT_1BIT_BE=2,SPICE_BITMAP_FMT_4BIT_LE=3,SPICE_BITMAP_FMT_4BIT_BE=4,SPICE_BITMAP_FMT_8BIT=5,SPICE_BITMAP_FMT_16BIT=6,SPICE_BITMAP_FMT_24BIT=7,SPICE_BITMAP_FMT_32BIT=8,SPICE_BITMAP_FMT_RGBA=9,SPICE_CURSOR_FLAGS_NONE=1,SPICE_CURSOR_FLAGS_CACHE_ME=2,SPICE_CURSOR_FLAGS_FROM_CACHE=4,SPICE_CURSOR_FLAGS_MASK=7,SPICE_MOUSE_BUTTON_MASK_LEFT=1,SPICE_MOUSE_BUTTON_MASK_MIDDLE=2,SPICE_MOUSE_BUTTON_MASK_RIGHT=4,SPICE_MOUSE_BUTTON_MASK_MASK=7,SPICE_MOUSE_BUTTON_INVALID=0,SPICE_MOUSE_BUTTON_LEFT=1,SPICE_MOUSE_BUTTON_MIDDLE=2,SPICE_MOUSE_BUTTON_RIGHT=3,SPICE_MOUSE_BUTTON_UP=4,SPICE_MOUSE_BUTTON_DOWN=5,SPICE_BRUSH_TYPE_NONE=0,SPICE_BRUSH_TYPE_SOLID=1,SPICE_BRUSH_TYPE_PATTERN=2,SPICE_SURFACE_FMT_INVALID=0,SPICE_SURFACE_FMT_1_A=1,SPICE_SURFACE_FMT_8_A=8,SPICE_SURFACE_FMT_16_555=16,SPICE_SURFACE_FMT_32_xRGB=32,SPICE_SURFACE_FMT_16_565=80,SPICE_SURFACE_FMT_32_ARGB=96,SPICE_ROPD_INVERS_SRC=1,SPICE_ROPD_INVERS_BRUSH=2,SPICE_ROPD_INVERS_DEST=4,SPICE_ROPD_OP_PUT=8,SPICE_ROPD_OP_OR=16,SPICE_ROPD_OP_AND=32,SPICE_ROPD_OP_XOR=64,SPICE_ROPD_OP_BLACKNESS=128,SPICE_ROPD_OP_WHITENESS=256,SPICE_ROPD_OP_INVERS=512,SPICE_ROPD_INVERS_RES=1024,SPICE_ROPD_MASK=2047,LZ_IMAGE_TYPE_INVALID=0,LZ_IMAGE_TYPE_PLT1_LE=1,LZ_IMAGE_TYPE_PLT1_BE=2,// PLT stands for palette
LZ_IMAGE_TYPE_PLT4_LE=3,LZ_IMAGE_TYPE_PLT4_BE=4,LZ_IMAGE_TYPE_PLT8=5,LZ_IMAGE_TYPE_RGB16=6,LZ_IMAGE_TYPE_RGB24=7,LZ_IMAGE_TYPE_RGB32=8,LZ_IMAGE_TYPE_RGBA=9,LZ_IMAGE_TYPE_XXXA=10,QUIC_IMAGE_TYPE_INVALID=0,QUIC_IMAGE_TYPE_GRAY=1,QUIC_IMAGE_TYPE_RGB16=2,QUIC_IMAGE_TYPE_RGB24=3,QUIC_IMAGE_TYPE_RGB32=4,QUIC_IMAGE_TYPE_RGBA=5,SPICE_INPUT_MOTION_ACK_BUNCH=4,SPICE_CURSOR_TYPE_ALPHA=0,SPICE_CURSOR_TYPE_MONO=1,SPICE_CURSOR_TYPE_COLOR4=2,SPICE_CURSOR_TYPE_COLOR8=3,SPICE_CURSOR_TYPE_COLOR16=4,SPICE_CURSOR_TYPE_COLOR24=5,SPICE_CURSOR_TYPE_COLOR32=6,SPICE_VIDEO_CODEC_TYPE_MJPEG=1,SPICE_VIDEO_CODEC_TYPE_VP8=2,VD_AGENT_PROTOCOL=1,VD_AGENT_MAX_DATA_SIZE=2048,VD_AGENT_MOUSE_STATE=1,VD_AGENT_MONITORS_CONFIG=2,VD_AGENT_REPLY=3,VD_AGENT_CLIPBOARD=4,VD_AGENT_DISPLAY_CONFIG=5,VD_AGENT_ANNOUNCE_CAPABILITIES=6,VD_AGENT_CLIPBOARD_GRAB=7,VD_AGENT_CLIPBOARD_REQUEST=8,VD_AGENT_CLIPBOARD_RELEASE=9,VD_AGENT_FILE_XFER_START=10,VD_AGENT_FILE_XFER_STATUS=11,VD_AGENT_FILE_XFER_DATA=12,VD_AGENT_CLIENT_DISCONNECTED=13,VD_AGENT_MAX_CLIPBOARD=14,VD_AGENT_CAP_MOUSE_STATE=0,VD_AGENT_CAP_MONITORS_CONFIG=1,VD_AGENT_CAP_REPLY=2,VD_AGENT_CAP_CLIPBOARD=3,VD_AGENT_CAP_DISPLAY_CONFIG=4,VD_AGENT_CAP_CLIPBOARD_BY_DEMAND=5,VD_AGENT_CAP_CLIPBOARD_SELECTION=6,VD_AGENT_CAP_SPARSE_MONITORS_CONFIG=7,VD_AGENT_CAP_GUEST_LINEEND_LF=8,VD_AGENT_CAP_GUEST_LINEEND_CRLF=9,VD_AGENT_CAP_MAX_CLIPBOARD=10,VD_AGENT_END_CAP=11,VD_AGENT_FILE_XFER_STATUS_CAN_SEND_DATA=0,VD_AGENT_FILE_XFER_STATUS_CANCELLED=1,VD_AGENT_FILE_XFER_STATUS_ERROR=2,VD_AGENT_FILE_XFER_STATUS_SUCCESS=3,KEY_Escape=/* Escape                0x01  */1,KEY_1=/* 1           !         0x02  */2,KEY_2=/* 2           @         0x03  */3,KEY_3=/* 3           #         0x04  */4,KEY_4=/* 4           $         0x05  */5,KEY_5=/* 5           %         0x06  */6,KEY_6=/* 6           ^         0x07  */7,KEY_7=/* 7           &         0x08  */8,KEY_8=/* 8           *         0x09  */9,KEY_9=/* 9           (         0x0a  */10,KEY_0=/* 0           )         0x0b  */11,KEY_Minus=/* - (Minus)   _ (Under) 0x0c  */12,KEY_Equal=/* = (Equal)   +         0x0d  */13,KEY_BackSpace=/* Back Space            0x0e  */14,KEY_Tab=/* Tab                   0x0f  */15,KEY_Q=/* Q                     0x10  */16,KEY_W=/* W                     0x11  */17,KEY_E=/* E                     0x12  */18,KEY_R=/* R                     0x13  */19,KEY_T=/* T                     0x14  */20,KEY_Y=/* Y                     0x15  */21,KEY_U=/* U                     0x16  */22,KEY_I=/* I                     0x17  */23,KEY_O=/* O                     0x18  */24,KEY_P=/* P                     0x19  */25,KEY_LBrace=/* [           {         0x1a  */26,KEY_RBrace=/* ]           }         0x1b  */27,KEY_Enter=/* Enter                 0x1c  */28,KEY_LCtrl=/* Ctrl(left)            0x1d  */29,KEY_A=/* A                     0x1e  */30,KEY_S=/* S                     0x1f  */31,KEY_D=/* D                     0x20  */32,KEY_F=/* F                     0x21  */33,KEY_G=/* G                     0x22  */34,KEY_H=/* H                     0x23  */35,KEY_J=/* J                     0x24  */36,KEY_K=/* K                     0x25  */37,KEY_L=/* L                     0x26  */38,KEY_SemiColon=/* ;(SemiColon) :(Colon) 0x27  */39,KEY_Quote=/* ' (Apostr)  " (Quote) 0x28  */40,KEY_Tilde=/* ` (Accent)  ~ (Tilde) 0x29  */41,KEY_ShiftL=/* Shift(left)           0x2a  */42,KEY_BSlash=/* \(BckSlash) |(VertBar)0x2b  */43,KEY_Z=/* Z                     0x2c  */44,KEY_X=/* X                     0x2d  */45,KEY_C=/* C                     0x2e  */46,KEY_V=/* V                     0x2f  */47,KEY_B=/* B                     0x30  */48,KEY_N=/* N                     0x31  */49,KEY_M=/* M                     0x32  */50,KEY_Comma=/* , (Comma)   < (Less)  0x33  */51,KEY_Period=/* . (Period)  >(Greater)0x34  */52,KEY_Slash=/* / (Slash)   ?         0x35  */53,KEY_ShiftR=/* Shift(right)          0x36  */54,KEY_KP_Multiply=/* *                     0x37  */55,KEY_Alt=/* Alt(left)             0x38  */56,KEY_Space=/*   (SpaceBar)          0x39  */57,KEY_CapsLock=/* CapsLock              0x3a  */58,KEY_F1=/* F1                    0x3b  */59,KEY_F2=/* F2                    0x3c  */60,KEY_F3=/* F3                    0x3d  */61,KEY_F4=/* F4                    0x3e  */62,KEY_F5=/* F5                    0x3f  */63,KEY_F6=/* F6                    0x40  */64,KEY_F7=/* F7                    0x41  */65,KEY_F8=/* F8                    0x42  */66,KEY_F9=/* F9                    0x43  */67,KEY_F10=/* F10                   0x44  */68,KEY_NumLock=/* NumLock               0x45  */69,KEY_ScrollLock=/* ScrollLock            0x46  */70,KEY_KP_7=/* 7           Home      0x47  */71,KEY_KP_8=/* 8           Up        0x48  */72,KEY_KP_9=/* 9           PgUp      0x49  */73,KEY_KP_Minus=/* - (Minus)             0x4a  */74,KEY_KP_4=/* 4           Left      0x4b  */75,KEY_KP_5=/* 5                     0x4c  */76,KEY_KP_6=/* 6           Right     0x4d  */77,KEY_KP_Plus=/* + (Plus)              0x4e  */78,KEY_KP_1=/* 1           End       0x4f  */79,KEY_KP_2=/* 2           Down      0x50  */80,KEY_KP_3=/* 3           PgDown    0x51  */81,KEY_KP_0=/* 0           Insert    0x52  */82,KEY_KP_Decimal=/* . (Decimal) Delete    0x53  */83,KEY_SysReqest=/* SysReqest             0x54  */84
/* NOTUSED               0x55  */,KEY_Less=/* < (Less)   >(Greater) 0x56  */86,KEY_F11=/* F11                   0x57  */87,KEY_F12=/* F12                   0x58  */88,KEY_Prefix0=/* special               0x60  */96,KEY_Prefix1=/* specail               0x61  */97,DEBUG=0,PLAYBACK_DEBUG=0,STREAM_DEBUG=0,DUMP_DRAWS=!1,DUMP_CANVASES=!1,EMPTY_GIF_IMAGE="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
/*----------------------------------------------------------------------------
**  combine_array_buffers
**      Combine two array buffers.
**      FIXME - this can't be optimal.  See wire.js about eliminating the need.
**--------------------------------------------------------------------------*/
function combine_array_buffers(e,t){var i,s=new Uint8Array(e),r=new Uint8Array(t),_=new ArrayBuffer(e.byteLength+t.byteLength),n=new Uint8Array(_),a=0;for(i=0;i<s.length;i++)n[a++]=s[i];for(i=0;i<r.length;i++)n[a++]=r[i];return _}
/*----------------------------------------------------------------------------
**  hexdump_buffer
**--------------------------------------------------------------------------*/function hexdump_buffer(e){for(var t=new Uint8Array(e),i="",s="",r=0,_=0;_<t.length;_++){var n=Number(t[_]).toString(16);if(1==n.length&&(i+="0"),i+=n+" ",10==t[_]||13==t[_]||8==t[_]?s+=".":s+=String.fromCharCode(t[_]),_%16==15||_==t.length-1){for(;_%16!=15;)i+="   ",_++;0==r&&console.log(i+" | "+s),"00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 "==i?1==r?(console.log("."),r++):0==r&&r++:r=0,i=s=""}}}
/*----------------------------------------------------------------------------
**  Convert arraybuffer to string
**--------------------------------------------------------------------------*/function arraybuffer_to_str(e){return String.fromCharCode.apply(null,new Uint16Array(e))}
/*----------------------------------------------------------------------------
** Converting keycodes to AT scancodes is very hard.
** luckly there are some resources on the web and in the Xorg driver that help
** us figure out what browser dependent keycodes match to what scancodes.
**
** This will most likely not work for non US keyboard and browsers other than
** modern Chrome and FireFox.
**--------------------------------------------------------------------------*/var common_scanmap=[];common_scanmap["Q".charCodeAt(0)]=KEY_Q,common_scanmap["W".charCodeAt(0)]=KEY_W,common_scanmap["E".charCodeAt(0)]=KEY_E,common_scanmap["R".charCodeAt(0)]=KEY_R,common_scanmap["T".charCodeAt(0)]=KEY_T,common_scanmap["Y".charCodeAt(0)]=KEY_Y,common_scanmap["U".charCodeAt(0)]=KEY_U,common_scanmap["I".charCodeAt(0)]=KEY_I,common_scanmap["O".charCodeAt(0)]=KEY_O,common_scanmap["P".charCodeAt(0)]=KEY_P,common_scanmap["A".charCodeAt(0)]=KEY_A,common_scanmap["S".charCodeAt(0)]=KEY_S,common_scanmap["D".charCodeAt(0)]=KEY_D,common_scanmap["F".charCodeAt(0)]=KEY_F,common_scanmap["G".charCodeAt(0)]=KEY_G,common_scanmap["H".charCodeAt(0)]=KEY_H,common_scanmap["J".charCodeAt(0)]=KEY_J,common_scanmap["K".charCodeAt(0)]=KEY_K,common_scanmap["L".charCodeAt(0)]=KEY_L,common_scanmap["Z".charCodeAt(0)]=KEY_Z,common_scanmap["X".charCodeAt(0)]=KEY_X,common_scanmap["C".charCodeAt(0)]=KEY_C,common_scanmap["V".charCodeAt(0)]=KEY_V,common_scanmap["B".charCodeAt(0)]=KEY_B,common_scanmap["N".charCodeAt(0)]=KEY_N,common_scanmap["M".charCodeAt(0)]=KEY_M,common_scanmap[" ".charCodeAt(0)]=KEY_Space,common_scanmap[13]=KEY_Enter,common_scanmap[27]=KEY_Escape,common_scanmap[8]=KEY_BackSpace,common_scanmap[9]=KEY_Tab,common_scanmap[16]=KEY_ShiftL,common_scanmap[17]=KEY_LCtrl,common_scanmap[18]=KEY_Alt,common_scanmap[20]=KEY_CapsLock,common_scanmap[144]=KEY_NumLock,common_scanmap[112]=KEY_F1,common_scanmap[113]=KEY_F2,common_scanmap[114]=KEY_F3,common_scanmap[115]=KEY_F4,common_scanmap[116]=KEY_F5,common_scanmap[117]=KEY_F6,common_scanmap[118]=KEY_F7,common_scanmap[119]=KEY_F8,common_scanmap[120]=KEY_F9,common_scanmap[121]=KEY_F10,common_scanmap[122]=KEY_F11,common_scanmap[123]=KEY_F12,
/* These extended scancodes do not line up with values from atKeynames */
common_scanmap[42]=99,common_scanmap[19]=101,// Break
common_scanmap[111]=57397,// KP_Divide
common_scanmap[106]=57399,// KP_Multiply
common_scanmap[36]=57415,// Home
common_scanmap[38]=57416,// Up
common_scanmap[33]=57417,// PgUp
common_scanmap[37]=57419,// Left
common_scanmap[39]=57421,// Right
common_scanmap[35]=57423,// End
common_scanmap[40]=57424,// Down
common_scanmap[34]=57425,// PgDown
common_scanmap[45]=57426,// Insert
common_scanmap[46]=57427,// Delete
common_scanmap[44]=10807,// Print
/* These are not common between ALL browsers but are between Firefox and DOM3 */
common_scanmap["1".charCodeAt(0)]=KEY_1,common_scanmap["2".charCodeAt(0)]=KEY_2,common_scanmap["3".charCodeAt(0)]=KEY_3,common_scanmap["4".charCodeAt(0)]=KEY_4,common_scanmap["5".charCodeAt(0)]=KEY_5,common_scanmap["6".charCodeAt(0)]=KEY_6,common_scanmap["7".charCodeAt(0)]=KEY_7,common_scanmap["8".charCodeAt(0)]=KEY_8,common_scanmap["9".charCodeAt(0)]=KEY_9,common_scanmap["0".charCodeAt(0)]=KEY_0,common_scanmap[145]=KEY_ScrollLock,common_scanmap[103]=KEY_KP_7,common_scanmap[104]=KEY_KP_8,common_scanmap[105]=KEY_KP_9,common_scanmap[100]=KEY_KP_4,common_scanmap[101]=KEY_KP_5,common_scanmap[102]=KEY_KP_6,common_scanmap[107]=KEY_KP_Plus,common_scanmap[97]=KEY_KP_1,common_scanmap[98]=KEY_KP_2,common_scanmap[99]=KEY_KP_3,common_scanmap[96]=KEY_KP_0,common_scanmap[110]=KEY_KP_Decimal,common_scanmap[191]=KEY_Slash,common_scanmap[190]=KEY_Period,common_scanmap[188]=KEY_Comma,common_scanmap[220]=KEY_BSlash,common_scanmap[192]=KEY_Tilde,common_scanmap[222]=KEY_Quote,common_scanmap[219]=KEY_LBrace,common_scanmap[221]=KEY_RBrace,common_scanmap[91]=57435,//KEY_LMeta
common_scanmap[92]=57436,//KEY_RMeta
common_scanmap[93]=57437;//KEY_Menu
/* Firefox/Mozilla codes */
var firefox_scanmap=[];firefox_scanmap[173]=KEY_Minus,firefox_scanmap[109]=KEY_Minus,firefox_scanmap[61]=KEY_Equal,firefox_scanmap[59]=KEY_SemiColon;
/* DOM3 codes */
var DOM_scanmap=[];function get_scancode(e){return void 0===common_scanmap[e]?-1!=navigator.userAgent.indexOf("Firefox")?firefox_scanmap[e]:DOM_scanmap[e]:common_scanmap[e]}function keycode_to_start_scan(e){var t=get_scancode(e);return void 0===t?(alert("no map for "+e),0):t<256?t:224|t-256<<8}function keycode_to_end_scan(e){var t=get_scancode(e);return void 0===t?0:t<256?128|t:32992|t-256<<8}function dump_media_element(e){return"[networkState "+e.networkState+"|readyState "+e.readyState+"|error "+e.error+"|seeking "+e.seeking+"|duration "+e.duration+"|paused "+e.paused+"|ended "+e.error+"|buffered "+dump_timerange(e.buffered)+"]"}function dump_media_source(e){return"[duration "+e.duration+"|readyState "+e.readyState+"]"}function dump_source_buffer(e){return"[appendWindowStart "+e.appendWindowStart+"|appendWindowEnd "+e.appendWindowEnd+"|buffered "+dump_timerange(e.buffered)+"|timeStampOffset "+e.timeStampOffset+"|updating "+e.updating+"]"}function dump_timerange(e){var t;if(e){var i=e.length;t="{len "+i,0<i&&(t+="; start "+e.start(0)+"; end "+e.end(i-1)),t+="}"}else t="N/A";return t}DOM_scanmap[189]=KEY_Minus,DOM_scanmap[187]=KEY_Equal,DOM_scanmap[186]=KEY_SemiColon;
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  crc logic from rfc2083 ported to Javascript
**--------------------------------------------------------------------------*/
var encoder,rfc2083_crc_table=Array(256),rfc2083_crc_table_computed=0;
/* Make the table for a fast CRC. */
function rfc2083_make_crc_table(){var e,t,i;for(t=0;t<256;t++){for(e=t,i=0;i<8;i++)1&e?e=(3988292384^e>>>1)>>>0&4294967295:e>>>=1;rfc2083_crc_table[t]=e}rfc2083_crc_table_computed=1}
/* Update a running CRC with the bytes buf[0..len-1]--the CRC
     should be initialized to all 1's, and the transmitted value
     is the 1's complement of the final running CRC (see the
     crc() routine below)). */function rfc2083_update_crc(e,t,i,s){var r,_=e;for(rfc2083_crc_table_computed||rfc2083_make_crc_table(),r=0;r<s;r++)_=rfc2083_crc_table[255&(_^t[i+r])]^_>>>8;return _}function rfc2083_crc(e,t,i){return 4294967295^rfc2083_update_crc(4294967295,e,t,i)}function crc32(e,t,i){return rfc2083_crc(new Uint8Array(e),t,i)}function PngIHDR(e,t){this.width=e,this.height=t,this.depth=8,this.type=6,this.compression=0,this.filter=0,this.interlace=0}function adler(){this.s1=1,this.s2=0}function PngIDAT(e,t,i){if(65535<i.byteLength)throw new Error("Cannot handle more than 64K");this.data=i,this.width=e,this.height=t}function PngIEND(){}function create_rgba_png(e,t,i){var s,r=new PngIHDR(e,t),_=new PngIDAT(e,t,i),n=new PngIEND,a=new ArrayBuffer(r.buffer_size()+_.buffer_size()+n.buffer_size()),o=r.to_buffer(a);o=_.to_buffer(a,o),o=n.to_buffer(a,o);var c=new Uint8Array(a),h="";for(s=0;s<o;s++)h+="%",c[s]<16&&(h+="0"),h+=c[s].toString(16);return"%89PNG%0D%0A%1A%0A"+h}
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  lz.js
**      Functions for handling SPICE_IMAGE_TYPE_LZ_RGB
**  Adapted from lz.c .
**--------------------------------------------------------------------------*/
function lz_rgb32_decompress(e,t,s,r,_){var n,a=t,o=0;for(n=e[a++];4*o<s.length;n=e[a++]){var c=o,h=n>>5,p=(31&n)<<8;
//if (type == LZ_IMAGE_TYPE_RGBA)
//console.log(ctr++ + ": from " + (encoder + 28) + ", ctrl " + ctrl + ", len " + len + ", ofs " + ofs + ", op " + op);
if(32<=n){var u;if(6==--h)for(;h+=u=e[a++],255==u;);if(p+=u=e[a++],255==u&&p-u==7936&&(p=e[a++]<<8,p+=e[a++],p+=8191),h+=1,r==LZ_IMAGE_TYPE_RGBA&&(h+=2),(c-=p+=1)==o-1)
//if (type == LZ_IMAGE_TYPE_RGBA) console.log("alpha " + out_buf[(b*4)+3] + " dupped into pixel " + op + " through pixel " + (op + len));
for(var d=c;h;--h){if(r==LZ_IMAGE_TYPE_RGBA)s[4*o+3]=s[4*d+3];else for(i=0;i<4;i++)s[4*o+i]=s[4*d+i];o++}else
//if (type == LZ_IMAGE_TYPE_RGBA) console.log("alpha copied to pixel " + op + " through " + (op + len) + " from " + ref);
for(;h;--h){if(r==LZ_IMAGE_TYPE_RGBA)s[4*o+3]=s[4*c+3];else for(i=0;i<4;i++)s[4*o+i]=s[4*c+i];o++,c++}}else for(n++,r==LZ_IMAGE_TYPE_RGBA?
//console.log("alpha " + in_buf[encoder] + " set into pixel " + op);
s[4*o+3]=e[a++]:(s[4*o+0]=e[a+2],s[4*o+1]=e[a+1],s[4*o+2]=e[a+0],_&&(s[4*o+3]=255),a+=3),o++,--n;n;n--)r==LZ_IMAGE_TYPE_RGBA?
//console.log("alpha " + in_buf[encoder] + " set into pixel " + op);
s[4*o+3]=e[a++]:(s[4*o+0]=e[a+2],s[4*o+1]=e[a+1],s[4*o+2]=e[a+0],_&&(s[4*o+3]=255),a+=3),o++}return a-1}function flip_image_data(e){for(var t=4*e.width,i=e.height,s=i,r=new Uint8Array(e.width*e.height*4);s--;)r.set(e.data.subarray(s*t,(s+1)*t),(i-s-1)*t);e.data.set(r)}function convert_spice_lz_to_web(e,t){var i;if(t.type===LZ_IMAGE_TYPE_RGB32||t.type===LZ_IMAGE_TYPE_RGBA){i=lz_rgb32_decompress(s=new Uint8Array(t.data),0,(r=e.createImageData(t.width,t.height)).data,LZ_IMAGE_TYPE_RGB32,t.type!=LZ_IMAGE_TYPE_RGBA),t.top_down||flip_image_data(r),t.type==LZ_IMAGE_TYPE_RGBA&&lz_rgb32_decompress(s,i,r.data,LZ_IMAGE_TYPE_RGBA,!1)}else{if(t.type!==LZ_IMAGE_TYPE_XXXA)return;var s,r;lz_rgb32_decompress(s=new Uint8Array(t.data),0,(r=e.createImageData(t.width,t.height)).data,LZ_IMAGE_TYPE_RGBA,!1)}return r}PngIHDR.prototype={to_buffer:function(e,t){var i=t=t||0,s=new SpiceDataView(e);return s.setUint32(t,this.buffer_size()-12),t+=4,s.setUint8(t,"I".charCodeAt(0)),t++,s.setUint8(t,"H".charCodeAt(0)),t++,s.setUint8(t,"D".charCodeAt(0)),t++,s.setUint8(t,"R".charCodeAt(0)),t++,s.setUint32(t,this.width),t+=4,s.setUint32(t,this.height),t+=4,s.setUint8(t,this.depth),t++,s.setUint8(t,this.type),t++,s.setUint8(t,this.compression),t++,s.setUint8(t,this.filter),t++,s.setUint8(t,this.interlace),t++,s.setUint32(t,crc32(e,i+4,this.buffer_size()-8)),t+=4},buffer_size:function(){return 25}},adler.prototype.update=function(e){this.s1+=e,this.s1%=65521,this.s2+=this.s1,this.s2%=65521},PngIDAT.prototype={to_buffer:function(e,t){var i,s,r,_=t=t||0,n=new SpiceDataView(e),a=new adler;n.setUint32(t,this.buffer_size()-12),t+=4,n.setUint8(t,"I".charCodeAt(0)),t++,n.setUint8(t,"D".charCodeAt(0)),t++,n.setUint8(t,"A".charCodeAt(0)),t++,n.setUint8(t,"T".charCodeAt(0)),t++,
/* zlib header.  */
n.setUint8(t,120),t++,n.setUint8(t,1),t++,
/* Deflate header.  Specifies uncompressed, final bit */
n.setUint8(t,128),t++,n.setUint16(t,this.data.byteLength+this.height),t+=2,n.setUint16(t,~(this.data.byteLength+this.height)),t+=2;var o=new Uint8Array(this.data);for(s=r=0;s<this.height;s++)for(
/* Filter type 0 - uncompressed */
n.setUint8(t,0),t++,a.update(0),i=0;i<this.width&&r<this.data.byteLength;i++)a.update(o[r]),n.setUint8(t,o[r++]),t++,a.update(o[r]),n.setUint8(t,o[r++]),t++,a.update(o[r]),n.setUint8(t,o[r++]),t++,a.update(o[r]),n.setUint8(t,o[r++]),t++;
/* zlib checksum.   */return n.setUint16(t,a.s2),t+=2,n.setUint16(t,a.s1),t+=2,
/* FIXME - something is not quite right with the zlib code;
                   you get an error from libpng if you open the image in
                   gimp.  But it works, so it's good enough for now... */
n.setUint32(t,crc32(e,_+4,this.buffer_size()-8)),t+=4},buffer_size:function(){return 12+this.data.byteLength+this.height+4+2+1+2+2}},PngIEND.prototype={to_buffer:function(e,t){var i=t=t||0,s=new SpiceDataView(e);return s.setUint32(t,this.buffer_size()-12),t+=4,s.setUint8(t,"I".charCodeAt(0)),t++,s.setUint8(t,"E".charCodeAt(0)),t++,s.setUint8(t,"N".charCodeAt(0)),t++,s.setUint8(t,"D".charCodeAt(0)),t++,s.setUint32(t,crc32(e,i+4,this.buffer_size()-8)),t+=4},buffer_size:function(){return 12}};QUIC_IMAGE_TYPE_INVALID=0,QUIC_IMAGE_TYPE_GRAY=1,QUIC_IMAGE_TYPE_RGB16=2,QUIC_IMAGE_TYPE_RGB24=3,QUIC_IMAGE_TYPE_RGB32=4,QUIC_IMAGE_TYPE_RGBA=5;var DEFevol=3,DEFwmimax=6,DEFwminext=2048,need_init=!0,DEFmaxclen=26,evol=DEFevol,wmimax=DEFwmimax,wminext=DEFwminext,family_5bpc={nGRcodewords:[0,0,0,0,0,0,0,0],notGRcwlen:[0,0,0,0,0,0,0,0],notGRprefixmask:[0,0,0,0,0,0,0,0],notGRsuffixlen:[0,0,0,0,0,0,0,0],xlatU2L:[0,0,0,0,0,0,0,0],xlatL2U:[0,0,0,0,0,0,0,0]},family_8bpc={nGRcodewords:[0,0,0,0,0,0,0,0],notGRcwlen:[0,0,0,0,0,0,0,0],notGRprefixmask:[0,0,0,0,0,0,0,0],notGRsuffixlen:[0,0,0,0,0,0,0,0],xlatU2L:[0,0,0,0,0,0,0,0],xlatL2U:[0,0,0,0,0,0,0,0]},bppmask=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535,131071,262143,524287,1048575,2097151,4194303,8388607,16777215,33554431,67108863,134217727,268435455,536870911,1073741823,2147483647,4294967295],zeroLUT=[],besttrigtab=[[550,900,800,700,500,350,300,200,180,180,160],[110,550,900,800,550,400,350,250,140,160,140],[100,120,550,900,700,500,400,300,220,250,160]],J=[0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,5,5,6,6,7,7,8,9,10,11,12,13,14,15],lzeroes=[8,7,6,6,5,5,5,5,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],tabrand_chaos=[46495042,893548311,794435923,2453991765,2077388039,894197842,1462934312,697534094,1826128012,343623392,2581292719,3811265708,459739748,2638427270,1654964626,101227083,2654850628,3668700691,572794346,2758751005,3445133904,2344099199,3367450297,898927923,3618406352,1606297603,754696453,20823118,2050458127,972590750,3990194068,3305596553,4239238564,1690498157,3015324227,2306127097,1510321853,548392192,971157512,2292288069,1611390505,4086766286,4084927083,1883326811,1891043243,113180603,1107690783,3778825955,3248980775,2443839100,2190866218,1932072870,495393613,1078522166,4051963518,1784694977,1768732442,2146763203,264646923,1474361405,2361552500,296035746,2489922759,2094565616,2409465348,1334241083,72483606,3740181004,4057920662,1734898312,4114662834,574624900,880305546,3258472262,26713132,1571648456,52557195,4043234286,2458021343,676064371,1528437109,64953873,546717185,2709319979,1947039598,2812723004,28691684,286829174,4235176970,3465707163,12526951,2154766700,3165032534,2036061161,3386656087,2301212354,2023576300,1061142336,3105452904,2743866805,3283373992,3397596080,3085489552,3196092395,3210707808,3651022684,925444321,2088074316,230011220,3223248386,533229176,523863486,3028311159,13140218,2538347282,900399636,3000796173,1526771255,3541282854,2992674461,2135722105,389334227,1225164337,3119947809,1803959919,3471171263,704170491,1407019136,1924534819,526887421,168782227,333811993,298623278,4268451686,381087740,2542899140,3266880867,2498950977,200969370,3511909096,3252303004,2268881098,2499828613,2606499854,3163208665,3790254546,1840025712,1319758833,3771674836,519421307,3512796222,1563402978,4284300462,2263719815,715250337,3178437172,2660191010,2982332026,3256309961,2709659997,3434092872,2367065591,69438718,915160508,183164069,3134331940,175242981,2680543346,1421955782,4231173251,1736652874,3990568476,1710820912,2286604440,3464587098,1261907837,1757387321,1128554270,1090050251,2429922486,1288729218,882830086,211637042,1376462063,2147615815,1737974929,798170275,4271572277,4241687072,1638524620,2760366295,1065115089,2097227717,1224023317,1625204849,3383303351,1488272307,2640186157,1649047732,819719707,2615091943,502645401,760628135,4108137983,63606742,1404337880,1865161130,4272996852,1239761976,790984678,3213322601,1917062825,4195069880,1962259360,2111002573,2311983960,1861406170,511141875,2797510619,1331661048,3130608186,147483493,3767089176,2650841450,4096523407,2574446300,1956416337,851468126,3607527519,1811658703,3642821136,832691095,2453312857,933732854,94341217,3393797730,1695907457,2405722077,2877685663,2469507058,2249636341,3988608661,4001245617,825934927,3103985967,1127151177,3691656896,1640967098,2168932645,2830550957,3998822878,3002602893,1509651465,775813869,2599574079,3791574229],rgb32_pixel_pad=3,rgb32_pixel_r=2,rgb32_pixel_g=1,rgb32_pixel_b=0,rgb32_pixel_size=4;
/* Helper Functions */
function ceil_log_2(e){if(1===e)return 0;var t=1;for(e-=1;e>>>=1;)t++;return t}function family_init(e,t,i){var s;for(s=0;s<t;s++){var r,_;(r=i-t)>bppmask[t-s]&&(r=bppmask[t-s]),_=bppmask[t]+1-(r<<s),e.nGRcodewords[s]=r<<s,e.notGRcwlen[s]=r+ceil_log_2(_),e.notGRprefixmask[s]=bppmask[32-r]>>>0,e.notGRsuffixlen[s]=ceil_log_2(_)}
/* decorelate_init */var n,a=bppmask[t],o=a>>>1;for(n=0;n<=a;n++)e.xlatU2L[n]=n<=o?n<<1:1+(a-n<<1);
/* corelate_init */for(n=0;n<=a;n++)e.xlatL2U[n]=1&n?a-(n>>>1):n>>>1}function quic_image_bpc(e){switch(e){case QUIC_IMAGE_TYPE_GRAY:return 8;case QUIC_IMAGE_TYPE_RGB16:return 5;case QUIC_IMAGE_TYPE_RGB24:case QUIC_IMAGE_TYPE_RGB32:case QUIC_IMAGE_TYPE_RGBA:return 8;case QUIC_IMAGE_TYPE_INVALID:default:return console.log("quic: bad image type\n"),0}}function cnt_l_zeroes(e){return 4286578688&e?lzeroes[e>>>24]:4294934528&e?8+lzeroes[e>>>16&255]:4294967168&e?16+lzeroes[e>>>8&255]:24+lzeroes[255&e]}function golomb_decoding_8bpc(e,t){var i,s;if(t<0||t>family_8bpc.notGRprefixmask[e]){var r=cnt_l_zeroes(t);i=r<<e|t>>32-(s=r+1+e)&bppmask[e]}else s=family_8bpc.notGRcwlen[e],i=family_8bpc.nGRcodewords[e]+(t>>32-s&bppmask[family_8bpc.notGRsuffixlen[e]]);return{codewordlen:s,rc:i}}function golomb_code_len_8bpc(e,t){return e<family_8bpc.nGRcodewords[t]?1+(e>>>t)+t:family_8bpc.notGRcwlen[t]}function QuicModel(e){var t,i=0;switch(this.levels=1<<e,this.n_buckets_ptrs=0,evol){case 1:this.repfirst=3,this.firstsize=1,this.repnext=2,this.mulsize=2;break;case 3:this.repfirst=1,this.firstsize=1,this.repnext=1,this.mulsize=2;break;case 5:this.repfirst=1,this.firstsize=1,this.repnext=1,this.mulsize=4;break;case 0:case 2:case 4:console.log("quic: findmodelparams(): evol value obsolete!!!\n");break;default:console.log("quic: findmodelparams(): evol out of range!!!\n")}this.n_buckets=0;for(var s=this.repfirst+1,r=this.firstsize;t=this.n_buckets?i+1:0,--s||(s=this.repnext,r*=this.mulsize),(i=t+r-1)+r>=this.levels&&(i=this.levels-1),this.n_buckets_ptrs||(this.n_buckets_ptrs=this.levels),this.n_buckets++,i<this.levels-1;);}function QuicBucket(){this.counters=[0,0,0,0,0,0,0,0]}function QuicFamilyStat(){this.buckets_ptrs=[],this.buckets_buf=[]}function QuicChannel(e,t){this.state=new CommonState,this.family_stat_8bpc=new QuicFamilyStat,this.family_stat_5bpc=new QuicFamilyStat,this.correlate_row={zero:0,row:[]},this.model_8bpc=e,this.model_5bpc=t,this.buckets_ptrs=[],this.family_stat_8bpc.fill_model_structures(this.model_8bpc)&&this.family_stat_5bpc.fill_model_structures(this.model_5bpc)}function CommonState(){}function QuicEncoder(){var e;for(this.rgb_state=new CommonState,this.model_8bpc=new QuicModel(8),this.model_5bpc=new QuicModel(5),this.channels=[],e=0;e<4;e++)if(this.channels[e]=new QuicChannel(this.model_8bpc,this.model_5bpc),!this.channels[e])return void console.log("quic: failed to create channel")}function SpiceQuic(){}function convert_spice_quic_to_web(e,t){var i,s=e.createImageData(t.width,t.height);for(i=0;i<s.width*s.height*4;i+=4)s.data[i+0]=t.outptr[i+2],s.data[i+1]=t.outptr[i+1],s.data[i+2]=t.outptr[i+0],t.type!==QUIC_IMAGE_TYPE_RGBA?s.data[i+3]=255:s.data[i+3]=255-t.outptr[i+3];return s}
/* Module initialization */if(QuicModel.prototype={n_buckets:0,n_buckets_ptrs:0,repfirst:0,firstsize:0,repnext:0,mulsize:0,levels:0},QuicBucket.prototype={bestcode:0,reste:function(e){this.bestcode=e,this.counters=[0,0,0,0,0,0,0,0]},update_model_8bpc:function(e,t,i){var s,r=i-1,_=this.counters[r]+=golomb_code_len_8bpc(t,r);for(s=i-2;0<=s;s--){var n=this.counters[s]+=golomb_code_len_8bpc(t,s);n<_&&(r=s,_=n)}if(this.bestcode=r,_>e.wm_trigger)for(s=0;s<i;s++)this.counters[s]=this.counters[s]>>>1}},QuicFamilyStat.prototype={fill_model_structures:function(e){var t,i=0,s=0,r=e.repfirst+1,_=e.firstsize;do{var n;for(t=s?i+1:0,--r||(r=e.repnext,_*=e.mulsize),(i=t+_-1)+_>=e.levels&&(i=e.levels-1),this.buckets_buf[s]=new QuicBucket,n=t;n<=i;n++)this.buckets_ptrs[n]=this.buckets_buf[s];s++}while(i<e.levels-1);return!0}},QuicChannel.prototype={reste:function(e){var t;if(this.correlate_row={zero:0,row:[]},8==e){for(t=0;t<this.model_8bpc.n_buckets;t++)this.family_stat_8bpc.buckets_buf[t].reste(7);this.buckets_ptrs=this.family_stat_8bpc.buckets_ptrs}else{if(5!=e)return console.log("quic: %s: bad bpc %d\n",__FUNCTION__,e),!1;for(t=0;t<this.model_5bpc.n_buckets;t++)this.family_stat_8bpc.buckets_buf[t].reste(4);this.buckets_ptrs=this.family_stat_5bpc.buckets_ptrs}return this.state.reste(),!0}},CommonState.prototype={waitcnt:0,tabrand_seed:255,wm_trigger:0,wmidx:0,wmileft:wminext,melcstate:0,melclen:0,melcorder:0,set_wm_trigger:function(){var e=this.wmidx;10<e&&(e=10),this.wm_trigger=besttrigtab[Math.floor(evol/2)][e]},reste:function(){this.waitcnt=0,this.tabrand_seed=255,this.wmidx=0,this.wmileft=wminext,this.set_wm_trigger(),this.melcstate=0,this.melclen=J[0],this.melcorder=1<<this.melclen},tabrand:function(){return this.tabrand_seed++,tabrand_chaos[255&this.tabrand_seed]}},QuicEncoder.prototype={type:0,width:0,height:0,io_idx:0,io_available_bits:0,io_word:0,io_next_word:0,io_now:0,io_end:0,rows_completed:0},QuicEncoder.prototype.reste=function(e){return this.rgb_state.reste(),this.io_now=e,this.io_end=this.io_now.length,this.io_idx=0,!(this.rows_completed=0)},QuicEncoder.prototype.read_io_word=function(){if(this.io_idx>=this.io_end)throw"quic: out of data";this.io_next_word=this.io_now[this.io_idx++]|this.io_now[this.io_idx++]<<8|this.io_now[this.io_idx++]<<16|this.io_now[this.io_idx++]<<24},QuicEncoder.prototype.decode_eatbits=function(e){this.io_word=this.io_word<<e;var t=this.io_available_bits-e;this.io_available_bits=0<=t?t:(t*=-1,this.io_word|=this.io_next_word<<t,this.read_io_word(),32-t),this.io_word|=this.io_next_word>>>this.io_available_bits},QuicEncoder.prototype.decode_eat32bits=function(){this.decode_eatbits(16),this.decode_eatbits(16)},QuicEncoder.prototype.reste_channels=function(e){var t;for(t=0;t<4;t++)if(!this.channels[t].reste(e))return!1;return!0},QuicEncoder.prototype.quic_decode_begin=function(e){if(!this.reste(e))return!1;this.io_idx=0,this.io_next_word=this.io_now[this.io_idx++]|this.io_now[this.io_idx++]<<8|this.io_now[this.io_idx++]<<16|this.io_now[this.io_idx++]<<24,this.io_word=this.io_next_word,this.io_available_bits=0;var t=this.io_word;if(this.decode_eat32bits(),1128879441!=t)return console.log("quic: bad magic "+t.toString(16)),!1;var i=this.io_word;if(this.decode_eat32bits(),0!=i)return console.log("quic: bad version "+i.toString(16)),!1;this.type=this.io_word,this.decode_eat32bits(),this.width=this.io_word,this.decode_eat32bits(),this.height=this.io_word,this.decode_eat32bits();var s=quic_image_bpc(this.type);return!!this.reste_channels(s)},QuicEncoder.prototype.quic_rgb32_uncompress_row0_seg=function(e,t,i,s,r,_){var n,a,o;if(e)n=e+this.rgb_state.waitcnt;else{for(a=t[rgb32_pixel_pad]=0;o=golomb_decoding_8bpc(this.channels[a].buckets_ptrs[this.channels[a].correlate_row.zero].bestcode,this.io_word),this.channels[a].correlate_row.row[0]=o.rc,t[2-a]=255&family_8bpc.xlatL2U[o.rc],this.decode_eatbits(o.codewordlen),++a<3;);if(this.rgb_state.waitcnt)--this.rgb_state.waitcnt;else for(this.rgb_state.waitcnt=this.rgb_state.tabrand()&s,a=0;this.channels[a].buckets_ptrs[this.channels[a].correlate_row.zero].update_model_8bpc(this.rgb_state,this.channels[a].correlate_row.row[0],r),++a<3;);n=++e+this.rgb_state.waitcnt}for(;n<i;){for(;e<=n;e++)for(a=t[e*rgb32_pixel_size+rgb32_pixel_pad]=0;o=golomb_decoding_8bpc(this.channels[a].buckets_ptrs[this.channels[a].correlate_row.row[e-1]].bestcode,this.io_word),this.channels[a].correlate_row.row[e]=o.rc,t[e*rgb32_pixel_size+(2-a)]=family_8bpc.xlatL2U[o.rc]+t[(e-1)*rgb32_pixel_size+(2-a)]&_,this.decode_eatbits(o.codewordlen),++a<3;);for(a=0;this.channels[a].buckets_ptrs[this.channels[a].correlate_row.row[n-1]].update_model_8bpc(this.rgb_state,this.channels[a].correlate_row.row[n],r),++a<3;);n=e+(this.rgb_state.tabrand()&s)}for(;e<i;e++)for(a=t[e*rgb32_pixel_size+rgb32_pixel_pad]=0;o=golomb_decoding_8bpc(this.channels[a].buckets_ptrs[this.channels[a].correlate_row.row[e-1]].bestcode,this.io_word),this.channels[a].correlate_row.row[e]=o.rc,t[e*rgb32_pixel_size+(2-a)]=family_8bpc.xlatL2U[o.rc]+t[(e-1)*rgb32_pixel_size+(2-a)]&_,this.decode_eatbits(o.codewordlen),++a<3;);this.rgb_state.waitcnt=n-i},QuicEncoder.prototype.quic_rgb32_uncompress_row0=function(e){for(var t=0,i=this.width;wmimax>this.rgb_state.wmidx&&this.rgb_state.wmileft<=i;)this.rgb_state.wmileft&&(this.quic_rgb32_uncompress_row0_seg(t,e,t+this.rgb_state.wmileft,bppmask[this.rgb_state.wmidx],8,255),t+=this.rgb_state.wmileft,i-=this.rgb_state.wmileft),this.rgb_state.wmidx++,this.rgb_state.set_wm_trigger(),this.rgb_state.wmileft=wminext;i&&(this.quic_rgb32_uncompress_row0_seg(t,e,t+i,bppmask[this.rgb_state.wmidx],8,255),wmimax>this.rgb_state.wmidx&&(this.rgb_state.wmileft-=i))},QuicEncoder.prototype.quic_rgb32_uncompress_row_seg=function(e,t,i,s,r,_){var n,a,o=bppmask[this.rgb_state.wmidx],c=0,h=0,p=0;if(i)h=i+this.rgb_state.waitcnt;else{for(a=t[rgb32_pixel_pad]=0;n=golomb_decoding_8bpc(this.channels[a].buckets_ptrs[this.channels[a].correlate_row.zero].bestcode,this.io_word),this.channels[a].correlate_row.row[0]=n.rc,t[2-a]=family_8bpc.xlatL2U[this.channels[a].correlate_row.row[0]]+e[2-a]&_,this.decode_eatbits(n.codewordlen),++a<3;);if(this.rgb_state.waitcnt)--this.rgb_state.waitcnt;else for(this.rgb_state.waitcnt=this.rgb_state.tabrand()&o,a=0;this.channels[a].buckets_ptrs[this.channels[a].correlate_row.zero].update_model_8bpc(this.rgb_state,this.channels[a].correlate_row.row[0],r),++a<3;);h=++i+this.rgb_state.waitcnt}for(;;){for(var u=0;h<s&&!u;){for(;i<=h&&!u;i++){var d=i*rgb32_pixel_size,l=(i-2)*rgb32_pixel_size;if(e[(f=(i-1)*rgb32_pixel_size)+rgb32_pixel_r]==e[d+rgb32_pixel_r]&&e[f+rgb32_pixel_g]==e[d+rgb32_pixel_g]&&e[f+rgb32_pixel_b]==e[d+rgb32_pixel_b]&&c!=i&&2<i&&t[f+rgb32_pixel_r]==t[l+rgb32_pixel_r]&&t[f+rgb32_pixel_g]==t[l+rgb32_pixel_g]&&t[f+rgb32_pixel_b]==t[l+rgb32_pixel_b]){for(
/* do run */
this.rgb_state.waitcnt=h-i,p=(c=i)+this.decode_run(this.rgb_state);i<p;i++){var f=(i-1)*rgb32_pixel_size;t[(d=i*rgb32_pixel_size)+rgb32_pixel_pad]=0,t[d+rgb32_pixel_r]=t[f+rgb32_pixel_r],t[d+rgb32_pixel_g]=t[f+rgb32_pixel_g],t[d+rgb32_pixel_b]=t[f+rgb32_pixel_b]}if(i==s)return;h=i+this.rgb_state.waitcnt,u=1;break}a=0,t[d+rgb32_pixel_pad]=0;do{var E=this.channels[a],m=E.correlate_row;n=golomb_decoding_8bpc(E.buckets_ptrs[m.row[i-1]].bestcode,this.io_word),m.row[i]=n.rc,t[d+(2-a)]=family_8bpc.xlatL2U[n.rc]+(t[f+(2-a)]+e[d+(2-a)]>>1)&_,this.decode_eatbits(n.codewordlen)}while(++a<3)}if(u)break;for(a=0;this.channels[a].buckets_ptrs[this.channels[a].correlate_row.row[h-1]].update_model_8bpc(this.rgb_state,this.channels[a].correlate_row.row[h],r),++a<3;);h=i+(this.rgb_state.tabrand()&o)}for(;i<s&&!u;i++){d=i*rgb32_pixel_size,l=(i-2)*rgb32_pixel_size;if(e[(f=(i-1)*rgb32_pixel_size)+rgb32_pixel_r]==e[d+rgb32_pixel_r]&&e[f+rgb32_pixel_g]==e[d+rgb32_pixel_g]&&e[f+rgb32_pixel_b]==e[d+rgb32_pixel_b]&&c!=i&&2<i&&t[f+rgb32_pixel_r]==t[l+rgb32_pixel_r]&&t[f+rgb32_pixel_g]==t[l+rgb32_pixel_g]&&t[f+rgb32_pixel_b]==t[l+rgb32_pixel_b]){for(
/* do run */
this.rgb_state.waitcnt=h-i,p=(c=i)+this.decode_run(this.rgb_state);i<p;i++){f=(i-1)*rgb32_pixel_size;t[(d=i*rgb32_pixel_size)+rgb32_pixel_pad]=0,t[d+rgb32_pixel_r]=t[f+rgb32_pixel_r],t[d+rgb32_pixel_g]=t[f+rgb32_pixel_g],t[d+rgb32_pixel_b]=t[f+rgb32_pixel_b]}if(i==s)return;h=i+this.rgb_state.waitcnt,u=1;break}for(a=t[d+rgb32_pixel_pad]=0;n=golomb_decoding_8bpc(this.channels[a].buckets_ptrs[this.channels[a].correlate_row.row[i-1]].bestcode,this.io_word),this.channels[a].correlate_row.row[i]=n.rc,t[d+(2-a)]=family_8bpc.xlatL2U[n.rc]+(t[f+(2-a)]+e[d+(2-a)]>>1)&_,this.decode_eatbits(n.codewordlen),++a<3;);}if(!u)return void(this.rgb_state.waitcnt=h-s)}},QuicEncoder.prototype.decode_run=function(e){for(var t=0;;){var i,s=~(this.io_word>>>24)>>>0&255,r=zeroLUT[s];for(i=1;i<=r;i++)t+=e.melcorder,e.melcstate<32&&(e.melclen=J[++e.melcstate],e.melcorder=1<<e.melclen);if(8!=r){this.decode_eatbits(r+1);break}this.decode_eatbits(8)}return e.melclen&&(t+=this.io_word>>>32-e.melclen,this.decode_eatbits(e.melclen)),e.melcstate&&(e.melclen=J[--e.melcstate],e.melcorder=1<<e.melclen),t},QuicEncoder.prototype.quic_rgb32_uncompress_row=function(e,t){for(var i=0,s=this.width;wmimax>this.rgb_state.wmidx&&this.rgb_state.wmileft<=s;)this.rgb_state.wmileft&&(this.quic_rgb32_uncompress_row_seg(e,t,i,i+this.rgb_state.wmileft,8,255),i+=this.rgb_state.wmileft,s-=this.rgb_state.wmileft),this.rgb_state.wmidx++,this.rgb_state.set_wm_trigger(),this.rgb_state.wmileft=wminext;s&&(this.quic_rgb32_uncompress_row_seg(e,t,i,i+s,8,255),wmimax>this.rgb_state.wmidx&&(this.rgb_state.wmileft-=s))},QuicEncoder.prototype.quic_four_uncompress_row0_seg=function(e,t,i,s,r,_,n,a){var o,c;for(o=0==t?(c=golomb_decoding_8bpc(e.buckets_ptrs[i.zero].bestcode,this.io_word),i.row[0]=c.rc,s[rgb32_pixel_pad]=family_8bpc.xlatL2U[c.rc],this.decode_eatbits(c.codewordlen),e.state.waitcnt?--e.state.waitcnt:(e.state.waitcnt=e.state.tabrand()&_,e.buckets_ptrs[i.zero].update_model_8bpc(e.state,i.row[0],n)),++t+e.state.waitcnt):t+e.state.waitcnt;o<r;){for(var h;t<=o;t++)c=golomb_decoding_8bpc((h=e.buckets_ptrs[i.row[t-1]]).bestcode,this.io_word),i.row[t]=c.rc,s[t*rgb32_pixel_size+rgb32_pixel_pad]=family_8bpc.xlatL2U[c.rc]+s[(t-1)*rgb32_pixel_size+rgb32_pixel_pad]&a,this.decode_eatbits(c.codewordlen);h.update_model_8bpc(e.state,i.row[o],n),o=t+(e.state.tabrand()&_)}for(;t<r;t++)c=golomb_decoding_8bpc(e.buckets_ptrs[i.row[t-1]].bestcode,this.io_word),i.row[t]=c.rc,s[t*rgb32_pixel_size+rgb32_pixel_pad]=family_8bpc.xlatL2U[c.rc]+s[(t-1)*rgb32_pixel_size+rgb32_pixel_pad]&a,this.decode_eatbits(c.codewordlen);e.state.waitcnt=o-r},QuicEncoder.prototype.quic_four_uncompress_row0=function(e,t){for(var i=e.correlate_row,s=0,r=this.width;wmimax>e.state.wmidx&&e.state.wmileft<=r;)e.state.wmileft&&(this.quic_four_uncompress_row0_seg(e,s,i,t,s+e.state.wmileft,bppmask[e.state.wmidx],8,255),s+=e.state.wmileft,r-=e.state.wmileft),e.state.wmidx++,e.state.set_wm_trigger(),e.state.wmileft=wminext;r&&(this.quic_four_uncompress_row0_seg(e,s,i,t,s+r,bppmask[e.state.wmidx],8,255),wmimax>e.state.wmidx&&(e.state.wmileft-=r))},QuicEncoder.prototype.quic_four_uncompress_row_seg=function(e,t,i,s,r,_,n,a){var o,c,h,p=bppmask[e.state.wmidx],u=0;for(o=0==r?(h=golomb_decoding_8bpc(e.buckets_ptrs[t.zero].bestcode,this.io_word),t.row[0]=h.rc,s[rgb32_pixel_pad]=family_8bpc.xlatL2U[h.rc]+i[rgb32_pixel_pad]&a,this.decode_eatbits(h.codewordlen),e.state.waitcnt?--e.state.waitcnt:(e.state.waitcnt=e.state.tabrand()&p,e.buckets_ptrs[t.zero].update_model_8bpc(e.state,t.row[0],n)),++r+e.state.waitcnt):r+e.state.waitcnt;;){for(var d=0;o<_&&!d;){for(var l;r<=o&&!d;r++){var f=r*rgb32_pixel_size,E=(r-2)*rgb32_pixel_size;if(i[(m=(r-1)*rgb32_pixel_size)+rgb32_pixel_pad]==i[f+rgb32_pixel_pad]&&u!=r&&2<r&&s[m+rgb32_pixel_pad]==s[E+rgb32_pixel_pad]){for(
/* do run */
e.state.waitcnt=o-r,c=(u=r)+this.decode_run(e.state);r<c;r++){var m=(r-1)*rgb32_pixel_size;s[(f=r*rgb32_pixel_size)+rgb32_pixel_pad]=s[m+rgb32_pixel_pad]}if(r==_)return;o=r+e.state.waitcnt,d=1;break}h=golomb_decoding_8bpc((l=e.buckets_ptrs[t.row[r-1]]).bestcode,this.io_word),t.row[r]=h.rc,s[f+rgb32_pixel_pad]=family_8bpc.xlatL2U[h.rc]+(s[m+rgb32_pixel_pad]+i[f+rgb32_pixel_pad]>>1)&a,this.decode_eatbits(h.codewordlen)}if(d)break;l.update_model_8bpc(e.state,t.row[o],n),o=r+(e.state.tabrand()&p)}for(;r<_&&!d;r++){f=r*rgb32_pixel_size,E=(r-2)*rgb32_pixel_size;if(i[(m=(r-1)*rgb32_pixel_size)+rgb32_pixel_pad]==i[f+rgb32_pixel_pad]&&u!=r&&2<r&&s[m+rgb32_pixel_pad]==s[E+rgb32_pixel_pad]){for(
/* do run */
e.state.waitcnt=o-r,c=(u=r)+this.decode_run(e.state);r<c;r++){m=(r-1)*rgb32_pixel_size;s[(f=r*rgb32_pixel_size)+rgb32_pixel_pad]=s[m+rgb32_pixel_pad]}if(r==_)return;o=r+e.state.waitcnt,d=1;break}h=golomb_decoding_8bpc(e.buckets_ptrs[t.row[r-1]].bestcode,this.io_word),t.row[r]=h.rc,s[f+rgb32_pixel_pad]=family_8bpc.xlatL2U[h.rc]+(s[m+rgb32_pixel_pad]+i[f+rgb32_pixel_pad]>>1)&a,this.decode_eatbits(h.codewordlen)}if(!d)return void(e.state.waitcnt=o-_)}},QuicEncoder.prototype.quic_four_uncompress_row=function(e,t,i){for(var s=e.correlate_row,r=0,_=this.width;wmimax>e.state.wmidx&&e.state.wmileft<=_;)e.state.wmileft&&(this.quic_four_uncompress_row_seg(e,s,t,i,r,r+e.state.wmileft,8,255),r+=e.state.wmileft,_-=e.state.wmileft),e.state.wmidx++,e.state.set_wm_trigger(),e.state.wmileft=wminext;_&&(this.quic_four_uncompress_row_seg(e,s,t,i,r,r+_,8,255),wmimax>e.state.wmidx&&(e.state.wmileft-=_))}
/* We need to be generating rgb32 or rgba */,QuicEncoder.prototype.quic_decode=function(e,t){var i;switch(this.type){case QUIC_IMAGE_TYPE_RGB32:case QUIC_IMAGE_TYPE_RGB24:for(this.channels[0].correlate_row.zero=0,this.channels[1].correlate_row.zero=0,this.channels[2].correlate_row.zero=0,this.quic_rgb32_uncompress_row0(e),this.rows_completed++,i=1;i<this.height;i++){e=(s=e).subarray(t),this.channels[0].correlate_row.zero=this.channels[0].correlate_row.row[0],this.channels[1].correlate_row.zero=this.channels[1].correlate_row.row[0],this.channels[2].correlate_row.zero=this.channels[2].correlate_row.row[0],this.quic_rgb32_uncompress_row(s,e),this.rows_completed++}break;case QUIC_IMAGE_TYPE_RGB16:return console.log("quic: unsupported output format\n"),!1;case QUIC_IMAGE_TYPE_RGBA:for(this.channels[0].correlate_row.zero=0,this.channels[1].correlate_row.zero=0,this.channels[2].correlate_row.zero=0,this.quic_rgb32_uncompress_row0(e),this.channels[3].correlate_row.zero=0,this.quic_four_uncompress_row0(this.channels[3],e),this.rows_completed++,i=1;i<this.height;i++){var s;e=(s=e).subarray(t),this.channels[0].correlate_row.zero=this.channels[0].correlate_row.row[0],this.channels[1].correlate_row.zero=this.channels[1].correlate_row.row[0],this.channels[2].correlate_row.zero=this.channels[2].correlate_row.row[0],this.quic_rgb32_uncompress_row(s,e),this.channels[3].correlate_row.zero=this.channels[3].correlate_row.row[0],this.quic_four_uncompress_row(encoder.channels[3],s,e),this.rows_completed++}break;case QUIC_IMAGE_TYPE_GRAY:return console.log("quic: unsupported output format\n"),!1;case QUIC_IMAGE_TYPE_INVALID:default:return console.log("quic: bad image type\n"),!1}return!0},QuicEncoder.prototype.simple_quic_decode=function(e){/* FIXME - proper stride calc please */
if(this.quic_decode_begin(e)&&(this.type==QUIC_IMAGE_TYPE_RGB32||this.type==QUIC_IMAGE_TYPE_RGB24||this.type==QUIC_IMAGE_TYPE_RGBA)){var t=new Uint8Array(this.width*this.height*4);return t[0]=69,this.quic_decode(t,4*this.width)?t:void 0}},SpiceQuic.prototype={from_dv:function(e,t,i){if(!encoder)throw"quic: no quic encoder";this.data_size=e.getUint32(t,!0),t+=4;var s=new Uint8Array(i.slice(t));return this.outptr=encoder.simple_quic_decode(s),this.outptr&&(this.type=encoder.type,this.width=encoder.width,this.height=encoder.height),t+=s.length}},need_init){
/* init_zeroLUT */
var i,j,k,l;for(need_init=!1,family_init(family_8bpc,8,DEFmaxclen),family_init(family_5bpc,5,DEFmaxclen),j=k=1,l=8,i=0;i<256;++i)zeroLUT[i]=l,0==--k&&(k=j,--l,j*=2);if(!(encoder=new QuicEncoder))throw"quic: failed to create encoder"}
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  bitmap.js
**      Handle SPICE_IMAGE_TYPE_BITMAP
**--------------------------------------------------------------------------*/
function convert_spice_bitmap_to_web(e,t){var i,s,r,_=0,n=0,a=new Uint8Array(t.data);if(t.format==SPICE_BITMAP_FMT_32BIT||t.format==SPICE_BITMAP_FMT_RGBA){for(t.flags&SPICE_BITMAP_FLAGS_TOP_DOWN||(_=(t.y-1)*t.stride,n=2*t.stride),i=e.createImageData(t.x,t.y),s=0;s<t.y*t.stride;_-=n)for(r=0;r<t.x;r++,s+=4,_+=4)i.data[s+0]=a[_+2],i.data[s+1]=a[_+1],i.data[s+2]=a[_+0],
// FIXME - We effectively treat all images as having SPICE_IMAGE_FLAGS_HIGH_BITS_SET
t.format==SPICE_BITMAP_FMT_32BIT?i.data[s+3]=255:i.data[s+3]=a[_];return i}}
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  SpiceDataView
** FIXME FIXME
**    This is used because Firefox does not have DataView yet.
**    We should use DataView if we have it, because it *has* to
**    be faster than this code
**--------------------------------------------------------------------------*/
function SpiceDataView(e,t,i){this.u8=void 0!==t?void 0!==i?new Uint8Array(e,t,i):new Uint8Array(e,t):new Uint8Array(e)}
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  Spice types
**      This file contains classes for common spice types.
**  Generally, they are used as helpers in reading and writing messages
**  to and from the server.
**--------------------------------------------------------------------------*/
function SpiceChannelId(){}function SpiceRect(){}function SpiceClipRects(){}function SpiceClip(){}function SpiceImageDescriptor(){}function SpicePalette(){}function SpiceBitmap(){}function SpiceImage(){}function SpiceQMask(){}function SpicePattern(){}function SpiceBrush(){}function SpiceFill(){}function SpiceCopy(){}function SpicePoint16(){}function SpicePoint(){}function SpiceCursorHeader(){}function SpiceCursor(){}function SpiceSurface(){}
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  Spice messages
**      This file contains classes for passing messages to and from
**  a spice server.  This file should arguably be generated from
**  spice.proto, but it was instead put together by hand.
**--------------------------------------------------------------------------*/
function SpiceLinkHeader(e,t){this.magic=SPICE_MAGIC,this.major_version=SPICE_VERSION_MAJOR,this.minor_version=SPICE_VERSION_MINOR,void(this.size=0)!==e&&this.from_buffer(e,t)}function SpiceLinkMess(e,t){this.connection_id=0,this.channel_type=0,this.channel_id=0,this.common_caps=[],this.channel_caps=[],void 0!==e&&this.from_buffer(e,t)}function SpiceLinkReply(e,t){this.error=0,this.pub_key=void 0,this.common_caps=[],this.channel_caps=[],void 0!==e&&this.from_buffer(e,t)}function SpiceLinkAuthTicket(e,t){this.auth_mechanism=0,this.encrypted_data=void 0}function SpiceLinkAuthReply(e,t){void(this.auth_code=0)!==e&&this.from_buffer(e,t)}function SpiceMiniData(e,t){this.type=0,this.size=0,(this.data=void 0)!==e&&this.from_buffer(e,t)}function SpiceMsgChannels(e,t){this.num_of_channels=0,this.channels=[],void 0!==e&&this.from_buffer(e,t)}function SpiceMsgMainInit(e,t){this.from_buffer(e,t)}function SpiceMsgMainMouseMode(e,t){this.from_buffer(e,t)}function SpiceMsgMainAgentData(e,t){this.from_buffer(e,t)}function SpiceMsgMainAgentTokens(e,t){this.from_buffer(e,t)}function SpiceMsgSetAck(e,t){this.from_buffer(e,t)}function SpiceMsgcAckSync(e){this.generation=e.generation}function SpiceMsgcMainMouseModeRequest(e){this.mode=e}function SpiceMsgcMainAgentStart(e){this.num_tokens=e}function SpiceMsgcMainAgentData(e,t){this.protocol=VD_AGENT_PROTOCOL,this.type=e,this.opaque=0,this.size=t.buffer_size(),this.data=t}function VDAgentAnnounceCapabilities(e,t){t?(this.request=e,this.caps=t):this.from_buffer(e)}function VDAgentMonitorsConfig(e,t,i,s,r,_){this.num_mon=1,this.flags=e,this.width=t,this.height=i,this.depth=s,this.x=r,this.y=_}function VDAgentFileXferStatusMessage(e,t){t?(this.id=e,this.result=t):this.from_buffer(e)}function VDAgentFileXferStartMessage(e,t,i){this.id=e,this.string="[vdagent-file-xfer]\nname="+t+"\nsize="+i+"\n"}function VDAgentFileXferDataMessage(e,t,i){this.id=e,this.size=t,this.data=i}function SpiceMsgNotify(e,t){this.from_buffer(e,t)}function SpiceMsgcDisplayInit(){this.pixmap_cache_id=1,this.glz_dictionary_id=0,this.pixmap_cache_size=10485760,this.glz_dictionary_window_size=0}function SpiceMsgDisplayBase(){}function SpiceMsgDisplayDrawCopy(e,t){this.from_buffer(e,t)}function SpiceMsgDisplayDrawFill(e,t){this.from_buffer(e,t)}function SpiceMsgDisplayCopyBits(e,t){this.from_buffer(e,t)}function SpiceMsgSurfaceCreate(e,t){this.from_buffer(e,t)}function SpiceMsgSurfaceDestroy(e,t){this.from_buffer(e,t)}function SpiceMsgInputsInit(e,t){this.from_buffer(e,t)}function SpiceMsgInputsKeyModifiers(e,t){this.from_buffer(e,t)}function SpiceMsgCursorInit(e,t){this.from_buffer(e,t)}function SpiceMsgPlaybackData(e,t){this.from_buffer(e,t)}function SpiceMsgPlaybackMode(e,t){this.from_buffer(e,t)}function SpiceMsgPlaybackStart(e,t){this.from_buffer(e,t)}function SpiceMsgCursorSet(e,t){this.from_buffer(e,t)}function SpiceMsgcMousePosition(e,t){if(
// FIXME - figure out how to correctly compute display_id
this.display_id=0,this.buttons_state=e.buttons_state,t){var i=document.body.scrollTop||document.documentElement.scrollTop,s=document.body.scrollLeft||document.documentElement.scrollLeft;this.x=t.clientX-e.display.surfaces[e.display.primary_surface].canvas.offsetLeft+s,this.y=t.clientY-e.display.surfaces[e.display.primary_surface].canvas.offsetTop+i,e.mousex=this.x,e.mousey=this.y}else this.x=this.y=this.buttons_state=0}function SpiceMsgcMouseMotion(e,t){
// FIXME - figure out how to correctly compute display_id
this.display_id=0,this.buttons_state=e.buttons_state,t?(this.x=t.clientX-e.display.surfaces[e.display.primary_surface].canvas.offsetLeft,this.y=t.clientY-e.display.surfaces[e.display.primary_surface].canvas.offsetTop,void 0!==e.mousex&&(this.x-=e.mousex,this.y-=e.mousey),e.mousex=t.clientX-e.display.surfaces[e.display.primary_surface].canvas.offsetLeft,e.mousey=t.clientY-e.display.surfaces[e.display.primary_surface].canvas.offsetTop):this.x=this.y=this.buttons_state=0}
/* Use the same functions as for MousePosition */function SpiceMsgcMousePress(e,t){t?(this.button=t.button+1,this.buttons_state=1<<t.button,e.buttons_state=this.buttons_state):(this.button=SPICE_MOUSE_BUTTON_LEFT,this.buttons_state=SPICE_MOUSE_BUTTON_MASK_LEFT)}function SpiceMsgcMouseRelease(e,t){t?(this.button=t.button+1,this.buttons_state=0,e.buttons_state=this.buttons_state):(this.button=SPICE_MOUSE_BUTTON_LEFT,this.buttons_state=0)}
/* Use the same functions as for MousePress */function SpiceMsgcKeyDown(e){this.code=e?keycode_to_start_scan(e.keyCode):0}function SpiceMsgcKeyUp(e){this.code=e?keycode_to_end_scan(e.keyCode):0}
/* Use the same functions as for KeyDown */function SpiceMsgDisplayStreamCreate(e,t){this.from_buffer(e,t)}function SpiceStreamDataHeader(e,t){}function SpiceMsgDisplayStreamData(e,t){this.from_buffer(e,t)}function SpiceMsgDisplayStreamDataSized(e,t){this.from_buffer(e,t)}function SpiceMsgDisplayStreamClip(e,t){this.from_buffer(e,t)}function SpiceMsgDisplayStreamDestroy(e,t){this.from_buffer(e,t)}function SpiceMsgDisplayStreamActivateReport(e,t){this.from_buffer(e,t)}function SpiceMsgcDisplayStreamReport(e,t){this.stream_id=e,this.unique_id=t,this.start_frame_mm_time=0,this.end_frame_mm_time=0,this.num_frames=0,this.num_drops=0,this.last_frame_delay=0,
// TODO - Implement audio delay
this.audio_delay=-1}function SpiceMsgDisplayInvalList(e,t){this.count=0,this.resources=[],this.from_buffer(e,t)}function SpiceMsgPortInit(e,t){this.from_buffer(e,t)}
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*--------------------------------------------------------------------------------------
**  SpiceWireReader
**      This class will receive messages from a WebSocket and relay it to a given
**  callback.  It will optionally save and pass along a header, useful in processing
**  the mini message format.
**--------------------------------------------------------------------------------------*/
function SpiceWireReader(e,t){this.sc=e,this.callback=t,this.needed=0,this.buffers=[],(this.sc.ws.wire_reader=this).sc.ws.binaryType="arraybuffer",this.sc.ws.addEventListener("message",wire_blob_catcher)}function wire_blob_catcher(e){1<DEBUG&&console.log(">> WebSockets.onmessage"),1<DEBUG&&console.log("id "+this.wire_reader.sc.connection_id+"; type "+this.wire_reader.sc.type),SpiceWireReader.prototype.inbound.call(this.wire_reader,e.data)}
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  SpiceConn
**      This is the base Javascript class for establishing and
**  managing a connection to a Spice Server.
**  It is used to provide core functionality to the Spice main,
**  display, inputs, and cursor channels.  See main.js for
**  usage.
**--------------------------------------------------------------------------*/
function SpiceConn(e){if(void 0===e||void 0===e.uri||!e.uri)throw new Error("You must specify a uri");if(this.ws=new WebSocket(e.uri,"binary"),!this.ws.binaryType)throw new Error("WebSocket doesn't support binaryType.  Try a different browser.");if(this.connection_id=void 0!==e.connection_id?e.connection_id:0,this.type=void 0!==e.type?e.type:SPICE_CHANNEL_MAIN,this.chan_id=void 0!==e.chan_id?e.chan_id:0,void 0!==e.parent&&(this.parent=e.parent,this.message_id=e.parent.message_id,this.password=e.parent.password),void 0!==e.screen_id&&(this.screen_id=e.screen_id),void 0!==e.dump_id&&(this.dump_id=e.dump_id),void 0!==e.message_id&&(this.message_id=e.message_id),void 0!==e.password&&(this.password=e.password),void 0!==e.onerror&&(this.onerror=e.onerror),void 0!==e.onsuccess&&(this.onsuccess=e.onsuccess),void 0!==e.onagent&&(this.onagent=e.onagent),this.state="connecting",(this.ws.parent=this).wire_reader=new SpiceWireReader(this,this.process_inbound),this.messages_sent=0,this.warnings=[],this.ws.addEventListener("open",function(e){0<DEBUG&&console.log(">> WebSockets.onopen"),0<DEBUG&&console.log("id "+this.parent.connection_id+"; type "+this.parent.type),
/***********************************************************************
        **          WHERE IT ALL REALLY BEGINS
        ***********************************************************************/
this.parent.send_hdr(),this.parent.wire_reader.request(SpiceLinkHeader.prototype.buffer_size()),this.parent.state="start"}),this.ws.addEventListener("error",function(e){"url"in e.target&&this.parent.log_err("WebSocket error: Can't connect to websocket on URL: "+e.target.url),this.parent.report_error(e)}),this.ws.addEventListener("close",function(e){(0<DEBUG&&console.log(">> WebSockets.onclose"),0<DEBUG&&console.log("id "+this.parent.connection_id+"; type "+this.parent.type),0<DEBUG&&console.log(e),"closing"!=this.parent.state&&"error"!=this.parent.state&&void 0!==this.parent.onerror)&&(e="connecting"==this.parent.state?new Error("Connection refused."):"start"==this.parent.state||"link"==this.parent.state?new Error("Unexpected protocol mismatch."):"ticket"==this.parent.state?new Error("Bad password."):new Error("Unexpected close while "+this.parent.state),this.parent.onerror(e),this.parent.log_err(e.toString()))}),2==this.ws.readyState||3==this.ws.readyState)throw new Error("Unable to connect to "+e.uri);this.timeout=window.setTimeout(spiceconn_timeout,SPICE_CONNECT_TIMEOUT,this)}function spiceconn_timeout(e){SpiceConn.prototype.handle_timeout.call(e)}
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  FIXME: putImageData  does not support Alpha blending
**           or compositing.  So if we have data in an ImageData
**           format, we have to draw it onto a context,
**           and then use drawImage to put it onto the target,
**           as drawImage does alpha.
**--------------------------------------------------------------------------*/
function putImageDataWithAlpha(e,t,i,s){var r=document.createElement("canvas"),_=r.getContext("2d");r.setAttribute("width",t.width),r.setAttribute("height",t.height),_.putImageData(t,0,0),e.drawImage(r,i,s,t.width,t.height)}
/*----------------------------------------------------------------------------
**  FIXME: Spice will send an image with '0' alpha when it is intended to
**           go on a surface w/no alpha.  So in that case, we have to strip
**           out the alpha.  The test case for this was flux box; in a Xspice
**           server, right click on the desktop to get the menu; the top bar
**           doesn't paint/highlight correctly w/out this change.
**--------------------------------------------------------------------------*/function stripAlpha(e){var t;for(t=0;t<e.width*e.height*4;t+=4)e.data[t+3]=255}
/*----------------------------------------------------------------------------
**  SpiceDisplayConn
**      Drive the Spice Display Channel
**--------------------------------------------------------------------------*/function SpiceDisplayConn(){SpiceConn.apply(this,arguments)}function handle_mouseover(e){this.focus()}function handle_mouseout(e){this.sc&&this.sc.cursor&&this.sc.cursor.spice_simulated_cursor&&(this.sc.cursor.spice_simulated_cursor.style.display="none"),this.blur()}function handle_draw_jpeg_onload(){var e,t=null;if(this.o.sc.streams[this.o.id]&&this.o.sc.streams[this.o.id].frames_loading--
/*------------------------------------------------------------
    ** FIXME:
    **  The helper should be extended to be able to handle actual HtmlImageElements
    **  ...and the cache should be modified to do so as well
    **----------------------------------------------------------*/,e=void 0===this.o.sc.surfaces[this.o.base.surface_id]?(
// This can happen; if the jpeg image loads after our surface
//  has been destroyed (e.g. open a menu, close it quickly),
//  we'll find we have no surface.
2<DEBUG&&this.o.sc.log_info("Discarding jpeg; presumed lost surface "+this.o.base.surface_id),(t=document.createElement("canvas")).setAttribute("width",this.o.base.box.right),t.setAttribute("height",this.o.base.box.bottom),t.getContext("2d")):this.o.sc.surfaces[this.o.base.surface_id].canvas.context,this.alpha_img){var i=document.createElement("canvas"),s=i.getContext("2d");i.setAttribute("width",this.alpha_img.width),i.setAttribute("height",this.alpha_img.height),s.putImageData(this.alpha_img,0,0),s.globalCompositeOperation="source-in",s.drawImage(this,0,0),e.drawImage(i,this.o.base.box.left,this.o.base.box.top),this.o.descriptor&&this.o.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in this.o.sc||(this.o.sc.cache={}),this.o.sc.cache[this.o.descriptor.id]=s.getImageData(0,0,this.alpha_img.width,this.alpha_img.height))}else e.drawImage(this,this.o.base.box.left,this.o.base.box.top),
// Give the Garbage collector a clue to recycle this; avoids
//  fairly massive memory leaks during video playback
this.onload=void 0,this.src=EMPTY_GIF_IMAGE,this.o.descriptor&&this.o.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in this.o.sc||(this.o.sc.cache={}),this.o.sc.cache[this.o.descriptor.id]=e.getImageData(this.o.base.box.left,this.o.base.box.top,this.o.base.box.right-this.o.base.box.left,this.o.base.box.bottom-this.o.base.box.top));if(null==t){if(DUMP_DRAWS&&this.o.sc.parent.dump_id){var r=document.createElement("canvas");r.setAttribute("id",this.o.tag+"."+this.o.sc.surfaces[this.o.base.surface_id].draw_count+"."+this.o.base.surface_id+"@"+this.o.base.box.left+"x"+this.o.base.box.top),r.getContext("2d").drawImage(this,0,0),document.getElementById(this.o.sc.parent.dump_id).appendChild(r)}this.o.sc.surfaces[this.o.base.surface_id].draw_count++}this.o.sc.streams[this.o.id]&&"report"in this.o.sc.streams[this.o.id]&&process_stream_data_report(this.o.sc,this.o.id,this.o.msg_mmtime,this.o.msg_mmtime-this.o.sc.parent.relative_now())}function process_mjpeg_stream_data(e,t,i){
/* If we are currently processing an mjpeg frame when a new one arrives,
       and the new one is 'late', drop the new frame.  This helps the browsers
       keep up, and provides rate control feedback as well */
if(i<0&&0<e.streams[t.base.id].frames_loading)"report"in e.streams[t.base.id]&&e.streams[t.base.id].report.num_drops++;else{var s,r="data:image/jpeg,",_=new Image;for(s=0;s<t.data.length;s++)r+="%",t.data[s]<16&&(r+="0"),r+=t.data[s].toString(16);var n=new SpiceMsgDisplayBase;n.surface_id=e.streams[t.base.id].surface_id,n.box=t.dest||e.streams[t.base.id].dest,n.clip=e.streams[t.base.id].clip,_.o={base:n,tag:"mjpeg."+t.base.id,descriptor:null,sc:e,id:t.base.id,msg_mmtime:t.base.multi_media_time},_.onload=handle_draw_jpeg_onload,_.src=r,e.streams[t.base.id].frames_loading++}}function process_stream_data_report(e,t,i,s){if(e.streams[t].report.num_frames++,0==e.streams[t].report.start_frame_mm_time&&(e.streams[t].report.start_frame_mm_time=i),e.streams[t].report.num_frames>e.streams[t].max_window_size||i-e.streams[t].report.start_frame_mm_time>e.streams[t].timeout_ms){e.streams[t].report.end_frame_mm_time=i,e.streams[t].report.last_frame_delay=s;var r=new SpiceMiniData;r.build_msg(SPICE_MSGC_DISPLAY_STREAM_REPORT,e.streams[t].report),e.send_msg(r),e.streams[t].report.start_frame_mm_time=0,e.streams[t].report.num_frames=0,e.streams[t].report.num_drops=0}}function handle_video_source_open(e){var t=this.stream,i=this.spiceconn;if(!t.source_buffer){var s=this.addSourceBuffer(SPICE_VP8_CODEC);if(s){(t.source_buffer=s).spiceconn=i,listen_for_video_events(s.stream=t);var r=new webm_Header,_=new webm_Tracks(new webm_VideoTrackEntry(this.stream.stream_width,this.stream.stream_height)),n=new ArrayBuffer(r.buffer_size()+_.buffer_size()),a=r.to_buffer(n);_.to_buffer(n,a),s.addEventListener("error",handle_video_buffer_error,!1),s.addEventListener("updateend",handle_append_video_buffer_done,!1),append_video_buffer(s,n)}else i.log_err("Codec "+SPICE_VP8_CODEC+" not available.")}}function handle_video_source_ended(e){this.spiceconn.log_err("Video source unexpectedly ended.")}function handle_video_source_closed(e){this.spiceconn.log_err("Video source unexpectedly closed.")}function append_video_buffer(t,e){try{t.stream.append_okay=!1,t.appendBuffer(e)}catch(e){t.spiceconn.log_err("Error invoking appendBuffer: "+e.message)}}function handle_append_video_buffer_done(e){var t=this.stream;if(t.current_frame&&"report"in t){var i=this.stream.media.spiceconn,s=this.stream.current_frame.msg_mmtime;process_stream_data_report(i,t.id,s,s-i.parent.relative_now())}0<t.queue.length?(t.current_frame=t.queue.shift(),append_video_buffer(t.source_buffer,t.current_frame.mb)):t.append_okay=!0,t.video?(0<t.video.buffered.length&&t.video.currentTime<t.video.buffered.start(t.video.buffered.length-1)&&(console.log("Video appears to have fallen behind; advancing to "+t.video.buffered.start(t.video.buffered.length-1)),t.video.currentTime=t.video.buffered.start(t.video.buffered.length-1)),1<STREAM_DEBUG&&console.log(t.video.currentTime+":id "+t.id+" updateend "+dump_media_element(t.video))):0<STREAM_DEBUG&&console.log("Stream id "+t.id+" received updateend after video is gone.")}function handle_video_buffer_error(e){this.spiceconn.log_err("source_buffer error "+e.message)}function push_or_queue(e,t,i){var s={msg_mmtime:t.base.multi_media_time};e.append_okay?(e.current_frame=s,append_video_buffer(e.source_buffer,i)):(s.mb=i,e.queue.push(s))}function video_simple_block(e,t,i){var s=new webm_SimpleBlock(t.base.multi_media_time-e.cluster_time,t.data,i),r=new ArrayBuffer(s.buffer_size());s.to_buffer(r),push_or_queue(e,t,r)}function new_video_cluster(e,t){e.cluster_time=t.base.multi_media_time;var i=new webm_Cluster(e.cluster_time-e.start_time,t.data),s=new ArrayBuffer(i.buffer_size());i.to_buffer(s),push_or_queue(e,t,s),video_simple_block(e,t,!0)}function process_video_stream_data(e,t){0==e.start_time?(e.start_time=t.base.multi_media_time,new_video_cluster(e,t)):t.base.multi_media_time-e.cluster_time>=MAX_CLUSTER_TIME?new_video_cluster(e,t):video_simple_block(e,t,!1)}function video_handle_event_debug(e){var t=this.spice_stream;t.video&&(0<STREAM_DEBUG||1<t.video.buffered.len)&&console.log(t.video.currentTime+":id "+t.id+" event "+e.type+dump_media_element(t.video)),1<STREAM_DEBUG&&t.media&&console.log("  media_source "+dump_media_source(t.media)),1<STREAM_DEBUG&&t.source_buffer&&console.log("  source_buffer "+dump_source_buffer(t.source_buffer)),(1<STREAM_DEBUG||1<t.queue.length)&&console.log("  queue len "+t.queue.length+"; append_okay: "+t.append_okay)}function video_debug_listen_for_one_event(e){this.addEventListener(e,video_handle_event_debug)}function listen_for_video_events(e){["abort","error"].forEach(video_debug_listen_for_one_event,e.video),0<STREAM_DEBUG&&["loadstart","suspend","emptied","stalled","loadedmetadata","loadeddata","canplay","canplaythrough","playing","waiting","seeking","seeked","ended","durationchange","play","pause","ratechange"].forEach(video_debug_listen_for_one_event,e.video),1<STREAM_DEBUG&&["timeupdate","progress","resize","volumechange"].forEach(video_debug_listen_for_one_event,e.video)}
/*
   Copyright (C) 2016 by Oliver Gutierrez <ogutsua@gmail.com>
                         Miroslav Chodil <mchodil@redhat.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  SpicePortConn
**      Drive the Spice Port Channel
**--------------------------------------------------------------------------*/
function SpicePortConn(){0<DEBUG&&console.log("SPICE port: created SPICE port channel. Args:",arguments),SpiceConn.apply(this,arguments),this.port_name=null}
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  SpiceMainConn
**      This is the master Javascript class for establishing and
**  managing a connection to a Spice Server.
**
**      Invocation:  You must pass an object with properties as follows:
**          uri         (required)  Uri of a WebSocket listener that is
**                                  connected to a spice server.
**          password    (required)  Password to send to the spice server
**          message_id  (optional)  Identifier of an element in the DOM
**                                  where SpiceConn will write messages.
**                                  It will use classes spice-messages-x,
**                                  where x is one of info, warning, or error.
**          screen_id   (optional)  Identifier of an element in the DOM
**                                  where SpiceConn will create any new
**                                  client screens.  This is the main UI.
**          dump_id     (optional)  If given, an element to use for
**                                  dumping every single image + canvas drawn.
**                                  Sometimes useful for debugging.
**          onerror     (optional)  If given, a function to receive async
**                                  errors.  Note that you should also catch
**                                  errors for ones that occur inline
**          onagent     (optional)  If given, a function to be called when
**                                  a VD agent is connected; a good opportunity
**                                  to request a resize
**
**  Throws error if there are troubles.  Requires a modern (by 2012 standards)
**      browser, including WebSocket and WebSocket.binaryType == arraybuffer
**
**--------------------------------------------------------------------------*/
function SpiceMainConn(){if("undefined"==typeof WebSocket)throw new Error("WebSocket unavailable.  You need to use a different browser.");SpiceConn.apply(this,arguments),this.agent_msg_queue=[],this.file_xfer_tasks={},this.file_xfer_task_id=0,this.file_xfer_read_queue=[],this.ports=[]}SpiceDataView.prototype={getUint8:function(e){return this.u8[e]},getUint16:function(e,t){var i=1,s=0;return t&&(i=0,s=1),this.u8[e+s]<<8|this.u8[e+i]},getUint32:function(e,t){var i=2,s=0;return t&&(i=0,s=2),this.getUint16(e+s,t)<<16|this.getUint16(e+i,t)},getUint64:function(e,t){var i=4,s=0;return t&&(i=0,s=4),this.getUint32(e+s,t)<<32|this.getUint32(e+i,t)},setUint8:function(e,t){this.u8[e]=255&t},setUint16:function(e,t,i){var s=1,r=0;i&&(s=0,r=1),this.u8[e+r]=(65535&t)>>8,this.u8[e+s]=255&t},setUint32:function(e,t,i){var s=2,r=0;i&&(s=0,r=2),this.setUint16(e+r,(4294967295&t)>>16,i),this.setUint16(e+s,65535&t,i)},setUint64:function(e,t,i){var s=4,r=0;i&&(s=0,r=4),this.setUint32(e+r,(0x10000000000000000&t)>>32,i),this.setUint32(e+s,4294967295&t,i)}},SpiceChannelId.prototype={from_dv:function(e,t,i){return this.type=e.getUint8(t,!0),t++,this.id=e.getUint8(t,!0),++t}},SpiceRect.prototype={from_dv:function(e,t,i){return this.top=e.getUint32(t,!0),t+=4,this.left=e.getUint32(t,!0),t+=4,this.bottom=e.getUint32(t,!0),t+=4,this.right=e.getUint32(t,!0),t+=4},is_same_size:function(e){return this.bottom-this.top==e.bottom-e.top&&this.right-this.left==e.right-e.left}},SpiceClipRects.prototype={from_dv:function(e,t,i){var s;for(this.num_rects=e.getUint32(t,!0),t+=4,0<this.num_rects&&(this.rects=[]),s=0;s<this.num_rects;s++)this.rects[s]=new SpiceRect,t=this.rects[s].from_dv(e,t,i);return t}},SpiceClip.prototype={from_dv:function(e,t,i){return this.type=e.getUint8(t,!0),t++,this.type==SPICE_CLIP_TYPE_RECTS&&(this.rects=new SpiceClipRects,t=this.rects.from_dv(e,t,i)),t}},SpiceImageDescriptor.prototype={from_dv:function(e,t,i){return this.id=e.getUint64(t,!0),t+=8,this.type=e.getUint8(t,!0),t++,this.flags=e.getUint8(t,!0),t++,this.width=e.getUint32(t,!0),t+=4,this.height=e.getUint32(t,!0),t+=4}},SpicePalette.prototype={from_dv:function(e,t,i){var s;for(this.unique=e.getUint64(t,!0),t+=8,this.num_ents=e.getUint16(t,!0),t+=2,this.ents=[],s=0;s<this.num_ents;s++)this.ents[s]=e.getUint32(t,!0),t+=4;return t}},SpiceBitmap.prototype={from_dv:function(e,t,i){if(this.format=e.getUint8(t,!0),t++,this.flags=e.getUint8(t,!0),t++,this.x=e.getUint32(t,!0),t+=4,this.y=e.getUint32(t,!0),t+=4,this.stride=e.getUint32(t,!0),t+=4,this.flags&SPICE_BITMAP_FLAGS_PAL_FROM_CACHE)this.palette_id=e.getUint64(t,!0),t+=8;else{var s=e.getUint32(t,!0);t+=4,0==s?this.palette=null:(this.palette=new SpicePalette,this.palette.from_dv(e,s,i))}
// FIXME - should probably constrain this to the offset
//          of palette, if non zero
return this.data=i.slice(t),t+=this.data.byteLength}},SpiceImage.prototype={from_dv:function(e,t,i){if(this.descriptor=new SpiceImageDescriptor,t=this.descriptor.from_dv(e,t,i),this.descriptor.type==SPICE_IMAGE_TYPE_LZ_RGB){this.lz_rgb=new Object,this.lz_rgb.length=e.getUint32(t,!0);var s=t+=4;this.lz_rgb.magic="";for(var r=3;0<=r;r--)this.lz_rgb.magic+=String.fromCharCode(e.getUint8(t+r));t+=4,
// NOTE:  The endian change is *correct*
this.lz_rgb.version=e.getUint32(t),t+=4,this.lz_rgb.type=e.getUint32(t),t+=4,this.lz_rgb.width=e.getUint32(t),t+=4,this.lz_rgb.height=e.getUint32(t),t+=4,this.lz_rgb.stride=e.getUint32(t),t+=4,this.lz_rgb.top_down=e.getUint32(t);var _=(t+=4)-s;this.lz_rgb.data=i.slice(t,this.lz_rgb.length+t-_),t+=this.lz_rgb.data.byteLength}if(this.descriptor.type==SPICE_IMAGE_TYPE_BITMAP&&(this.bitmap=new SpiceBitmap,t=this.bitmap.from_dv(e,t,i)),this.descriptor.type==SPICE_IMAGE_TYPE_SURFACE&&(this.surface_id=e.getUint32(t,!0),t+=4),this.descriptor.type==SPICE_IMAGE_TYPE_JPEG&&(this.jpeg=new Object,this.jpeg.data_size=e.getUint32(t,!0),t+=4,this.jpeg.data=i.slice(t),t+=this.jpeg.data.byteLength),this.descriptor.type==SPICE_IMAGE_TYPE_JPEG_ALPHA){this.jpeg_alpha=new Object,this.jpeg_alpha.flags=e.getUint8(t,!0),t+=1,this.jpeg_alpha.jpeg_size=e.getUint32(t,!0),t+=4,this.jpeg_alpha.data_size=e.getUint32(t,!0),t+=4,this.jpeg_alpha.data=i.slice(t,this.jpeg_alpha.jpeg_size+t),t+=this.jpeg_alpha.data.byteLength,
// Alpha channel is an LZ image
this.jpeg_alpha.alpha=new Object,this.jpeg_alpha.alpha.length=this.jpeg_alpha.data_size-this.jpeg_alpha.jpeg_size;s=t;this.jpeg_alpha.alpha.magic="";for(r=3;0<=r;r--)this.jpeg_alpha.alpha.magic+=String.fromCharCode(e.getUint8(t+r));t+=4,
// NOTE:  The endian change is *correct*
this.jpeg_alpha.alpha.version=e.getUint32(t),t+=4,this.jpeg_alpha.alpha.type=e.getUint32(t),t+=4,this.jpeg_alpha.alpha.width=e.getUint32(t),t+=4,this.jpeg_alpha.alpha.height=e.getUint32(t),t+=4,this.jpeg_alpha.alpha.stride=e.getUint32(t),t+=4,this.jpeg_alpha.alpha.top_down=e.getUint32(t);_=(t+=4)-s;this.jpeg_alpha.alpha.data=i.slice(t,this.jpeg_alpha.alpha.length+t-_),t+=this.jpeg_alpha.alpha.data.byteLength}return this.descriptor.type==SPICE_IMAGE_TYPE_QUIC&&(this.quic=new SpiceQuic,t=this.quic.from_dv(e,t,i)),t}},SpiceQMask.prototype={from_dv:function(e,t,i){this.flags=e.getUint8(t,!0),t++,this.pos=new SpicePoint,t=this.pos.from_dv(e,t,i);var s=e.getUint32(t,!0);return t+=4,0==s?(this.bitmap=null,t):(this.bitmap=new SpiceImage,this.bitmap.from_dv(e,s,i))}},SpicePattern.prototype={from_dv:function(e,t,i){var s=e.getUint32(t,!0);return t+=4,0==s?this.pat=null:(this.pat=new SpiceImage,this.pat.from_dv(e,s,i)),this.pos=new SpicePoint,this.pos.from_dv(e,t,i)}},SpiceBrush.prototype={from_dv:function(e,t,i){return this.type=e.getUint8(t,!0),t++,this.type==SPICE_BRUSH_TYPE_SOLID?(this.color=e.getUint32(t,!0),t+=4):this.type==SPICE_BRUSH_TYPE_PATTERN&&(this.pattern=new SpicePattern,t=this.pattern.from_dv(e,t,i)),t}},SpiceFill.prototype={from_dv:function(e,t,i){return this.brush=new SpiceBrush,t=this.brush.from_dv(e,t,i),this.rop_descriptor=e.getUint16(t,!0),t+=2,this.mask=new SpiceQMask,this.mask.from_dv(e,t,i)}},SpiceCopy.prototype={from_dv:function(e,t,i){var s=e.getUint32(t,!0);return t+=4,0==s?this.src_bitmap=null:(this.src_bitmap=new SpiceImage,this.src_bitmap.from_dv(e,s,i)),this.src_area=new SpiceRect,t=this.src_area.from_dv(e,t,i),this.rop_descriptor=e.getUint16(t,!0),t+=2,this.scale_mode=e.getUint8(t,!0),t++,this.mask=new SpiceQMask,this.mask.from_dv(e,t,i)}},SpicePoint16.prototype={from_dv:function(e,t,i){return this.x=e.getUint16(t,!0),t+=2,this.y=e.getUint16(t,!0),t+=2}},SpicePoint.prototype={from_dv:function(e,t,i){return this.x=e.getUint32(t,!0),t+=4,this.y=e.getUint32(t,!0),t+=4}},SpiceCursorHeader.prototype={from_dv:function(e,t,i){return this.unique=e.getUint64(t,!0),t+=8,this.type=e.getUint8(t,!0),t++,this.width=e.getUint16(t,!0),t+=2,this.height=e.getUint16(t,!0),t+=2,this.hot_spot_x=e.getUint16(t,!0),t+=2,this.hot_spot_y=e.getUint16(t,!0),t+=2}},SpiceCursor.prototype={from_dv:function(e,t,i){return this.flags=e.getUint16(t,!0),t+=2,this.flags&SPICE_CURSOR_FLAGS_NONE?this.header=null:(this.header=new SpiceCursorHeader,t=this.header.from_dv(e,t,i),this.data=i.slice(t),t+=this.data.byteLength),t}},SpiceSurface.prototype={from_dv:function(e,t,i){return this.surface_id=e.getUint32(t,!0),t+=4,this.width=e.getUint32(t,!0),t+=4,this.height=e.getUint32(t,!0),t+=4,this.format=e.getUint32(t,!0),t+=4,this.flags=e.getUint32(t,!0),t+=4}}
/* FIXME - SpiceImage  types lz_plt, jpeg, zlib_glz, and jpeg_alpha are
           completely unimplemented */,SpiceLinkHeader.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.magic="";for(var s=0;s<4;s++)this.magic+=String.fromCharCode(i.getUint8(t+s));t+=4,this.major_version=i.getUint32(t,!0),t+=4,this.minor_version=i.getUint32(t,!0),t+=4,this.size=i.getUint32(t,!0),t+=4},to_buffer:function(e,t){t=t||0;for(var i=new SpiceDataView(e),s=0;s<4;s++)i.setUint8(t+s,this.magic.charCodeAt(s));t+=4,i.setUint32(t,this.major_version,!0),t+=4,i.setUint32(t,this.minor_version,!0),t+=4,i.setUint32(t,this.size,!0),t+=4},buffer_size:function(){return 16}},SpiceLinkMess.prototype={from_buffer:function(e,t){var i,s=t=t||0,r=new SpiceDataView(e);this.connection_id=r.getUint32(t,!0),t+=4,this.channel_type=r.getUint8(t,!0),t++,this.channel_id=r.getUint8(t,!0),t++;var _=r.getUint32(t,!0);t+=4;var n=r.getUint32(t,!0);t+=4;var a=r.getUint32(t,!0);for(t+=4,t=s+a,this.common_caps=[],i=0;i<_;i++)this.common_caps.unshift(r.getUint32(t,!0)),t+=4;for(this.channel_caps=[],i=0;i<n;i++)this.channel_caps.unshift(r.getUint32(t,!0)),t+=4},to_buffer:function(e,t){var i,s=t=t||0,r=new SpiceDataView(e);for(r.setUint32(t,this.connection_id,!0),t+=4,r.setUint8(t,this.channel_type,!0),t++,r.setUint8(t,this.channel_id,!0),t++,r.setUint32(t,this.common_caps.length,!0),t+=4,r.setUint32(t,this.channel_caps.length,!0),t+=4,r.setUint32(t,t-s+4,!0),t+=4,i=0;i<this.common_caps.length;i++)r.setUint32(t,this.common_caps[i],!0),t+=4;for(i=0;i<this.channel_caps.length;i++)r.setUint32(t,this.channel_caps[i],!0),t+=4},buffer_size:function(){return 18+4*this.common_caps.length+4*this.channel_caps.length}},SpiceLinkReply.prototype={from_buffer:function(e,t){var i,s=t=t||0,r=new SpiceDataView(e);this.error=r.getUint32(t,!0),t+=4,this.pub_key=create_rsa_from_mb(e,t),t+=SPICE_TICKET_PUBKEY_BYTES;var _=r.getUint32(t,!0);t+=4;var n=r.getUint32(t,!0);t+=4;var a=r.getUint32(t,!0);for(t+=4,t=s+a,this.common_caps=[],i=0;i<_;i++)this.common_caps.unshift(r.getUint32(t,!0)),t+=4;for(this.channel_caps=[],i=0;i<n;i++)this.channel_caps.unshift(r.getUint32(t,!0)),t+=4}},SpiceLinkAuthTicket.prototype={to_buffer:function(e,t){var i;t=t||0;var s=new SpiceDataView(e);for(s.setUint32(t,this.auth_mechanism,!0),t+=4,i=0;i<SPICE_TICKET_KEY_PAIR_LENGTH/8;i++)this.encrypted_data&&i<this.encrypted_data.length?s.setUint8(t,this.encrypted_data[i],!0):s.setUint8(t,0,!0),t++},buffer_size:function(){return 4+SPICE_TICKET_KEY_PAIR_LENGTH/8}},SpiceLinkAuthReply.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.auth_code=i.getUint32(t,!0),t+=4},buffer_size:function(){return 4}},SpiceMiniData.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.type=i.getUint16(t,!0),t+=2,this.size=i.getUint32(t,!0),t+=4,e.byteLength>t&&(this.data=e.slice(t),t+=this.data.byteLength)},to_buffer:function(e,t){var i;t=t||0;var s=new SpiceDataView(e);if(s.setUint16(t,this.type,!0),t+=2,s.setUint32(t,this.data?this.data.byteLength:0,!0),t+=4,this.data&&0<this.data.byteLength){var r=new Uint8Array(this.data);for(i=0;i<r.length;i++,t++)s.setUint8(t,r[i],!0)}},build_msg:function(e,t){this.type=e,this.size=t.buffer_size(),this.data=new ArrayBuffer(this.size),t.to_buffer(this.data)},buffer_size:function(){return this.data?6+this.data.byteLength:6}},SpiceMsgChannels.prototype={from_buffer:function(e,t){var i;t=t||0;var s=new SpiceDataView(e);for(this.num_of_channels=s.getUint32(t,!0),t+=4,i=0;i<this.num_of_channels;i++){var r=new SpiceChannelId;t=r.from_dv(s,t,e),this.channels.push(r)}}},SpiceMsgMainInit.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.session_id=i.getUint32(t,!0),t+=4,this.display_channels_hint=i.getUint32(t,!0),t+=4,this.supported_mouse_modes=i.getUint32(t,!0),t+=4,this.current_mouse_mode=i.getUint32(t,!0),t+=4,this.agent_connected=i.getUint32(t,!0),t+=4,this.agent_tokens=i.getUint32(t,!0),t+=4,this.multi_media_time=i.getUint32(t,!0),t+=4,this.ram_hint=i.getUint32(t,!0),t+=4}},SpiceMsgMainMouseMode.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.supported_modes=i.getUint16(t,!0),t+=2,this.current_mode=i.getUint16(t,!0),t+=2}},SpiceMsgMainAgentData.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.protocol=i.getUint32(t,!0),t+=4,this.type=i.getUint32(t,!0),t+=4,this.opaque=i.getUint64(t,!0),t+=8,this.size=i.getUint32(t,!0),t+=4,e.byteLength>t&&(this.data=e.slice(t),t+=this.data.byteLength)}},SpiceMsgMainAgentTokens.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.num_tokens=i.getUint32(t,!0),t+=4}},SpiceMsgSetAck.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.generation=i.getUint32(t,!0),t+=4,this.window=i.getUint32(t,!0),t+=4}},SpiceMsgcAckSync.prototype={to_buffer:function(e,t){t=t||0,new SpiceDataView(e).setUint32(t,this.generation,!0),t+=4},buffer_size:function(){return 4}},SpiceMsgcMainMouseModeRequest.prototype={to_buffer:function(e,t){t=t||0,new SpiceDataView(e).setUint16(t,this.mode,!0),t+=2},buffer_size:function(){return 2}},SpiceMsgcMainAgentStart.prototype={to_buffer:function(e,t){t=t||0,new SpiceDataView(e).setUint32(t,this.num_tokens,!0),t+=4},buffer_size:function(){return 4}},SpiceMsgcMainAgentData.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);i.setUint32(t,this.protocol,!0),t+=4,i.setUint32(t,this.type,!0),t+=4,i.setUint64(t,this.opaque,!0),t+=8,i.setUint32(t,this.size,!0),t+=4,this.data.to_buffer(e,t)},buffer_size:function(){return 20+this.data.buffer_size()}},VDAgentAnnounceCapabilities.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);i.setUint32(t,this.request,!0),t+=4,i.setUint32(t,this.caps,!0),t+=4},from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.request=i.getUint32(t,!0),t+=4,this.caps=i.getUint32(t,!0),t+=4},buffer_size:function(){return 8}},VDAgentMonitorsConfig.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);i.setUint32(t,this.num_mon,!0),t+=4,i.setUint32(t,this.flags,!0),t+=4,i.setUint32(t,this.height,!0),t+=4,i.setUint32(t,this.width,!0),t+=4,i.setUint32(t,this.depth,!0),t+=4,i.setUint32(t,this.x,!0),t+=4,i.setUint32(t,this.y,!0),t+=4},buffer_size:function(){return 28}},VDAgentFileXferStatusMessage.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);i.setUint32(t,this.id,!0),t+=4,i.setUint32(t,this.result,!0),t+=4},from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.id=i.getUint32(t,!0),t+=4,this.result=i.getUint32(t,!0),t+=4},buffer_size:function(){return 8}},VDAgentFileXferStartMessage.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);i.setUint32(t,this.id,!0),t+=4;for(var s=0;s<this.string.length;s++,t++)i.setUint8(t,this.string.charCodeAt(s))},buffer_size:function(){return 4+this.string.length+1}},VDAgentFileXferDataMessage.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);if(i.setUint32(t,this.id,!0),t+=4,i.setUint64(t,this.size,!0),t+=8,this.data&&0<this.data.byteLength)for(var s=new Uint8Array(this.data),r=0;r<s.length;r++,t++)i.setUint8(t,s[r])},buffer_size:function(){return 12+this.size}},SpiceMsgNotify.prototype={from_buffer:function(e,t){var i;t=t||0;var s=new SpiceDataView(e);for(this.time_stamp=s.getUint64(t,!0),t+=8,this.severity=s.getUint32(t,!0),t+=4,this.visibility=s.getUint32(t,!0),t+=4,this.what=s.getUint32(t,!0),t+=4,this.message_len=s.getUint32(t,!0),t+=4,this.message="",i=0;i<this.message_len;i++){var r=s.getUint8(t,!0);t++,this.message+=String.fromCharCode(r)}}},SpiceMsgcDisplayInit.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);i.setUint8(t,this.pixmap_cache_id,!0),t++,i.setUint64(t,this.pixmap_cache_size,!0),t+=8,i.setUint8(t,this.glz_dictionary_id,!0),t++,i.setUint32(t,this.glz_dictionary_window_size,!0),t+=4},buffer_size:function(){return 14}},SpiceMsgDisplayBase.prototype={from_dv:function(e,t,i){return this.surface_id=e.getUint32(t,!0),t+=4,this.box=new SpiceRect,t=this.box.from_dv(e,t,i),this.clip=new SpiceClip,this.clip.from_dv(e,t,i)}},SpiceMsgDisplayDrawCopy.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.base=new SpiceMsgDisplayBase,t=this.base.from_dv(i,t,e),this.data=new SpiceCopy,this.data.from_dv(i,t,e)}},SpiceMsgDisplayDrawFill.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.base=new SpiceMsgDisplayBase,t=this.base.from_dv(i,t,e),this.data=new SpiceFill,this.data.from_dv(i,t,e)}},SpiceMsgDisplayCopyBits.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.base=new SpiceMsgDisplayBase,t=this.base.from_dv(i,t,e),this.src_pos=new SpicePoint,this.src_pos.from_dv(i,t,e)}},SpiceMsgSurfaceCreate.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.surface=new SpiceSurface,this.surface.from_dv(i,t,e)}},SpiceMsgSurfaceDestroy.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.surface_id=i.getUint32(t,!0),t+=4}},SpiceMsgInputsInit.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.keyboard_modifiers=i.getUint16(t,!0),t+=2}},SpiceMsgInputsKeyModifiers.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return this.keyboard_modifiers=i.getUint16(t,!0),t+=2}},SpiceMsgCursorInit.prototype={from_buffer:function(e,t,i){t=t||0;var s=new SpiceDataView(e);return this.position=new SpicePoint16,t=this.position.from_dv(s,t,i),this.trail_length=s.getUint16(t,!0),t+=2,this.trail_frequency=s.getUint16(t,!0),t+=2,this.visible=s.getUint8(t,!0),t++,this.cursor=new SpiceCursor,this.cursor.from_dv(s,t,e)}},SpiceMsgPlaybackData.prototype={from_buffer:function(e,t,i){t=t||0;var s=new SpiceDataView(e);return this.time=s.getUint32(t,!0),t+=4,e.byteLength>t&&(this.data=e.slice(t),t+=this.data.byteLength),t}},SpiceMsgPlaybackMode.prototype={from_buffer:function(e,t,i){t=t||0;var s=new SpiceDataView(e);return this.time=s.getUint32(t,!0),t+=4,this.mode=s.getUint16(t,!0),t+=2,e.byteLength>t&&(this.data=e.slice(t),t+=this.data.byteLength),t}},SpiceMsgPlaybackStart.prototype={from_buffer:function(e,t,i){t=t||0;var s=new SpiceDataView(e);return this.channels=s.getUint32(t,!0),t+=4,this.format=s.getUint16(t,!0),t+=2,this.frequency=s.getUint32(t,!0),t+=4,this.time=s.getUint32(t,!0),t+=4}},SpiceMsgCursorSet.prototype={from_buffer:function(e,t,i){t=t||0;var s=new SpiceDataView(e);return this.position=new SpicePoint16,t=this.position.from_dv(s,t,i),this.visible=s.getUint8(t,!0),t++,this.cursor=new SpiceCursor,this.cursor.from_dv(s,t,e)}},SpiceMsgcMousePosition.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return i.setUint32(t,this.x,!0),t+=4,i.setUint32(t,this.y,!0),t+=4,i.setUint16(t,this.buttons_state,!0),t+=2,i.setUint8(t,this.display_id,!0),t+=1},buffer_size:function(){return 11}},SpiceMsgcMouseMotion.prototype.to_buffer=SpiceMsgcMousePosition.prototype.to_buffer,SpiceMsgcMouseMotion.prototype.buffer_size=SpiceMsgcMousePosition.prototype.buffer_size,SpiceMsgcMousePress.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return i.setUint8(t,this.button,!0),t++,i.setUint16(t,this.buttons_state,!0),t+=2},buffer_size:function(){return 3}},SpiceMsgcMouseRelease.prototype.to_buffer=SpiceMsgcMousePress.prototype.to_buffer,SpiceMsgcMouseRelease.prototype.buffer_size=SpiceMsgcMousePress.prototype.buffer_size,SpiceMsgcKeyDown.prototype={to_buffer:function(e,t){return t=t||0,new SpiceDataView(e).setUint32(t,this.code,!0),t+=4},buffer_size:function(){return 4}},SpiceMsgcKeyUp.prototype.to_buffer=SpiceMsgcKeyDown.prototype.to_buffer,SpiceMsgcKeyUp.prototype.buffer_size=SpiceMsgcKeyDown.prototype.buffer_size,SpiceMsgDisplayStreamCreate.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.surface_id=i.getUint32(t,!0),t+=4,this.id=i.getUint32(t,!0),t+=4,this.flags=i.getUint8(t,!0),t+=1,this.codec_type=i.getUint8(t,!0),t+=1,this.stamp=i.getUint64(t,!0),t+=8,this.stream_width=i.getUint32(t,!0),t+=4,this.stream_height=i.getUint32(t,!0),t+=4,this.src_width=i.getUint32(t,!0),t+=4,this.src_height=i.getUint32(t,!0),t+=4,this.dest=new SpiceRect,t=this.dest.from_dv(i,t,e),this.clip=new SpiceClip,this.clip.from_dv(i,t,e)}},SpiceStreamDataHeader.prototype={from_dv:function(e,t,i){return this.id=e.getUint32(t,!0),t+=4,this.multi_media_time=e.getUint32(t,!0),t+=4}},SpiceMsgDisplayStreamData.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.base=new SpiceStreamDataHeader,t=this.base.from_dv(i,t,e),this.data_size=i.getUint32(t,!0),t+=4,this.data=i.u8.subarray(t,t+this.data_size)}},SpiceMsgDisplayStreamDataSized.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.base=new SpiceStreamDataHeader,t=this.base.from_dv(i,t,e),this.width=i.getUint32(t,!0),t+=4,this.height=i.getUint32(t,!0),t+=4,this.dest=new SpiceRect,t=this.dest.from_dv(i,t,e),this.data_size=i.getUint32(t,!0),t+=4,this.data=i.u8.subarray(t,t+this.data_size)}},SpiceMsgDisplayStreamClip.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.id=i.getUint32(t,!0),t+=4,this.clip=new SpiceClip,this.clip.from_dv(i,t,e)}},SpiceMsgDisplayStreamDestroy.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.id=i.getUint32(t,!0),t+=4}},SpiceMsgDisplayStreamActivateReport.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);this.stream_id=i.getUint32(t,!0),t+=4,this.unique_id=i.getUint32(t,!0),t+=4,this.max_window_size=i.getUint32(t,!0),t+=4,this.timeout_ms=i.getUint32(t,!0),t+=4}},SpiceMsgcDisplayStreamReport.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return i.setUint32(t,this.stream_id,!0),t+=4,i.setUint32(t,this.unique_id,!0),t+=4,i.setUint32(t,this.start_frame_mm_time,!0),t+=4,i.setUint32(t,this.end_frame_mm_time,!0),t+=4,i.setUint32(t,this.num_frames,!0),t+=4,i.setUint32(t,this.num_drops,!0),t+=4,i.setUint32(t,this.last_frame_delay,!0),t+=4,i.setUint32(t,this.audio_delay,!0),t+=4},buffer_size:function(){return 32}},SpiceMsgDisplayInvalList.prototype={from_buffer:function(e,t){var i;t=t||0;var s=new SpiceDataView(e);for(this.count=s.getUint16(t,!0),t+=2,i=0;i<this.count;i++)this.resources[i]={},this.resources[i].type=s.getUint8(t,!0),t++,this.resources[i].id=s.getUint64(t,!0),t+=8}},SpiceMsgPortInit.prototype={from_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e),s=i.getUint32(t,!0);t+=4;var r=i.getUint32(t,!0);t+=4,this.opened=i.getUint8(t,!0),t+=1,this.name=e.slice(r,r+s-1)}},SpiceWireReader.prototype={
/*------------------------------------------------------------------------
    **  Process messages coming in from our WebSocket
    **----------------------------------------------------------------------*/
inbound:function(e){
/* Just buffer if we don't need anything yet */
if(0!=this.needed){
/* If we have fragments that add up to what we need, combine them */
/*  FIXME - it would be faster to revise the processing code to handle
        **          multiple fragments directly.  Essentially, we should be
        **          able to do this without any slice() or combine_array_buffers() calls */
for(
/* Optimization - if we have just one inbound block, and it's
            suitable for our needs, just use it.  */
0==this.buffers.length&&e.byteLength>=this.needed?(e.byteLength>this.needed&&(this.buffers.push(e.slice(this.needed)),e=e.slice(0,this.needed)),this.callback.call(this.sc,e,this.saved_msg_header||void 0)):this.buffers.push(e);1<this.buffers.length&&this.buffers[0].byteLength<this.needed;){var t=this.buffers.shift(),i=this.buffers.shift();this.buffers.unshift(combine_array_buffers(t,i))}for(;0<this.buffers.length&&this.buffers[0].byteLength>=this.needed;)(e=this.buffers.shift()).byteLength>this.needed&&(this.buffers.unshift(e.slice(this.needed)),e=e.slice(0,this.needed)),this.callback.call(this.sc,e,this.saved_msg_header||void 0)}else this.buffers.push(e)},request:function(e){this.needed=e},save_header:function(e){this.saved_msg_header=e},clear_header:function(){this.saved_msg_header=void 0}},SpiceConn.prototype={send_hdr:function(){var e=new SpiceLinkHeader,t=new SpiceLinkMess;if(t.connection_id=this.connection_id,t.channel_type=this.type,t.channel_id=this.chan_id,t.common_caps.push(1<<SPICE_COMMON_CAP_PROTOCOL_AUTH_SELECTION|1<<SPICE_COMMON_CAP_MINI_HEADER),t.channel_type==SPICE_CHANNEL_PLAYBACK){var i=0;"MediaSource"in window&&MediaSource.isTypeSupported(SPICE_PLAYBACK_CODEC)&&(i|=1<<SPICE_PLAYBACK_CAP_OPUS),t.channel_caps.push(i)}else if(t.channel_type==SPICE_CHANNEL_MAIN)t.channel_caps.push(1<<SPICE_MAIN_CAP_AGENT_CONNECTED_TOKENS);else if(t.channel_type==SPICE_CHANNEL_DISPLAY){i=1<<SPICE_DISPLAY_CAP_SIZED_STREAM|1<<SPICE_DISPLAY_CAP_STREAM_REPORT|1<<SPICE_DISPLAY_CAP_MULTI_CODEC|1<<SPICE_DISPLAY_CAP_CODEC_MJPEG;"MediaSource"in window&&MediaSource.isTypeSupported(SPICE_VP8_CODEC)&&(i|=1<<SPICE_DISPLAY_CAP_CODEC_VP8),t.channel_caps.push(i)}e.size=t.buffer_size();var s=new ArrayBuffer(e.buffer_size()+t.buffer_size());e.to_buffer(s),t.to_buffer(s,e.buffer_size()),1<DEBUG&&console.log("Sending header:"),2<DEBUG&&hexdump_buffer(s),this.ws.send(s)},send_ticket:function(e){var t=new SpiceLinkAuthTicket;t.auth_mechanism=SPICE_COMMON_CAP_AUTH_SPICE,
// FIXME - we need to implement RSA to make this work right
t.encrypted_data=e;var i=new ArrayBuffer(t.buffer_size());t.to_buffer(i),1<DEBUG&&console.log("Sending ticket:"),2<DEBUG&&hexdump_buffer(i),this.ws.send(i)},send_msg:function(e){var t=new ArrayBuffer(e.buffer_size());e.to_buffer(t),this.messages_sent++,0<DEBUG&&console.log(">> hdr "+this.channel_type()+" type "+e.type+" size "+t.byteLength),2<DEBUG&&hexdump_buffer(t),this.ws.send(t)},process_inbound:function(e,t){if(2<DEBUG&&console.log(this.type+": processing message of size "+e.byteLength+"; state is "+this.state),"ready"==this.state)if(null==t){var i=new SpiceMiniData(e);500<i.type&&0<DEBUG&&alert("Something has gone very wrong; we think we have message of type "+i.type),0==i.size?(this.process_message(i),this.wire_reader.request(SpiceMiniData.prototype.buffer_size())):(this.wire_reader.request(i.size),this.wire_reader.save_header(i))}else t.data=e,this.process_message(t),this.wire_reader.request(SpiceMiniData.prototype.buffer_size()),this.wire_reader.save_header(void 0);else if("start"==this.state)if(this.reply_hdr=new SpiceLinkHeader(e),this.reply_hdr.magic!=SPICE_MAGIC){this.state="error";var s=new Error("Error: magic mismatch: "+this.reply_hdr.magic);this.report_error(s)}else
// FIXME - Determine major/minor version requirements
this.wire_reader.request(this.reply_hdr.size),this.state="link";else if("link"==this.state)
// FIXME - Screen the caps - require minihdr at least, right?
if(this.reply_link=new SpiceLinkReply(e),this.reply_link.error){this.state="error";s=new Error("Error: reply link error "+this.reply_link.error);this.report_error(s)}else this.send_ticket(rsa_encrypt(this.reply_link.pub_key,this.password+String.fromCharCode(0))),this.state="ticket",this.wire_reader.request(SpiceLinkAuthReply.prototype.buffer_size());else if("ticket"==this.state)if(this.auth_reply=new SpiceLinkAuthReply(e),this.auth_reply.auth_code==SPICE_LINK_ERR_OK){if(0<DEBUG&&console.log(this.type+": Connected"),this.type==SPICE_CHANNEL_DISPLAY){
// FIXME - pixmap and glz dictionary config info?
var r=new SpiceMsgcDisplayInit,_=new SpiceMiniData;_.build_msg(SPICE_MSGC_DISPLAY_INIT,r),0<DEBUG&&console.log("Request display init"),this.send_msg(_)}this.state="ready",this.wire_reader.request(SpiceMiniData.prototype.buffer_size()),this.timeout&&(window.clearTimeout(this.timeout),delete this.timeout)}else{if(this.state="error",this.auth_reply.auth_code==SPICE_LINK_ERR_PERMISSION_DENIED)s=new Error("Permission denied.");else s=new Error("Unexpected link error "+this.auth_reply.auth_code);this.report_error(s)}},process_common_messages:function(e){if(e.type==SPICE_MSG_SET_ACK){var t=new SpiceMsgSetAck(e.data);
// FIXME - what to do with generation?
this.ack_window=t.window,1<DEBUG&&console.log(this.type+": set ack to "+t.window),this.msgs_until_ack=this.ack_window;var i=new SpiceMsgcAckSync(t),s=new SpiceMiniData;return s.build_msg(SPICE_MSGC_ACK_SYNC,i),this.send_msg(s),!0}if(e.type==SPICE_MSG_PING){1<DEBUG&&console.log("ping!");var r=new SpiceMiniData;return r.type=SPICE_MSGC_PONG,e.data&&(r.data=e.data.slice(0,12)),r.size=r.buffer_size(),this.send_msg(r),!0}if(e.type!=SPICE_MSG_NOTIFY)return!1;
// FIXME - Visibility + what
var _=new SpiceMsgNotify(e.data);return _.severity==SPICE_NOTIFY_SEVERITY_ERROR?this.log_err(_.message):_.severity==SPICE_NOTIFY_SEVERITY_WARN?this.log_warn(_.message):this.log_info(_.message),!0},process_message:function(e){var t,i=Date.now();if(0<DEBUG&&console.log("<< hdr "+this.channel_type()+" type "+e.type+" size "+(e.data&&e.data.byteLength)),(t=this.process_common_messages(e))||(this.process_channel_message?(t=this.process_channel_message(e))||this.log_warn(this.channel_type()+": Unknown message type "+e.type+"!"):this.log_err(this.channel_type()+": No message handlers for this channel; message "+e.type)),void 0!==this.msgs_until_ack&&this.ack_window&&(this.msgs_until_ack--,this.msgs_until_ack<=0)){this.msgs_until_ack=this.ack_window;var s=new SpiceMiniData;s.type=SPICE_MSGC_ACK,this.send_msg(s),1<DEBUG&&console.log(this.type+": sent ack")}var r=Date.now()-i;return(0<DEBUG||GAP_DETECTION_THRESHOLD<r)&&console.log("delta "+this.channel_type()+":"+e.type+" "+r),t},channel_type:function(){return this.type==SPICE_CHANNEL_MAIN?"main":this.type==SPICE_CHANNEL_DISPLAY?"display":this.type==SPICE_CHANNEL_INPUTS?"inputs":this.type==SPICE_CHANNEL_CURSOR?"cursor":this.type==SPICE_CHANNEL_PLAYBACK?"playback":this.type==SPICE_CHANNEL_RECORD?"record":this.type==SPICE_CHANNEL_TUNNEL?"tunnel":this.type==SPICE_CHANNEL_SMARTCARD?"smartcard":this.type==SPICE_CHANNEL_USBREDIR?"usbredir":this.type==SPICE_CHANNEL_PORT?"port":this.type==SPICE_CHANNEL_WEBDAV?"webdav":"unknown-"+this.type},log_info:function(){var e=Array.prototype.join.call(arguments," ");if(console.log(e),this.message_id){var t=document.createElement("p");t.appendChild(document.createTextNode(e)),t.className+="spice-message-info",document.getElementById(this.message_id).appendChild(t)}},log_warn:function(){var e=Array.prototype.join.call(arguments," ");if(console.log("WARNING: "+e),this.message_id){var t=document.createElement("p");t.appendChild(document.createTextNode(e)),t.className+="spice-message-warning",document.getElementById(this.message_id).appendChild(t)}},log_err:function(){var e=Array.prototype.join.call(arguments," ");if(console.log("ERROR: "+e),this.message_id){var t=document.createElement("p");t.appendChild(document.createTextNode(e)),t.className+="spice-message-error",document.getElementById(this.message_id).appendChild(t)}},known_unimplemented:function(e,t){if(!this.warnings[e]||1<DEBUG){var i="";DEBUG<=1&&(i=" [ further notices suppressed ]"),this.log_warn("Unimplemented function "+e+"("+t+")"+i),this.warnings[e]=!0}},report_error:function(e){if(this.log_err(e.toString()),null==this.onerror)throw e;this.onerror(e)},report_success:function(e){null!=this.onsuccess&&this.onsuccess(e)},cleanup:function(){this.timeout&&(window.clearTimeout(this.timeout),delete this.timeout),this.ws&&(this.ws.close(),this.ws=void 0)},handle_timeout:function(){var e=new Error("Connection timed out.");this.report_error(e)}},SpiceDisplayConn.prototype=Object.create(SpiceConn.prototype),SpiceDisplayConn.prototype.process_channel_message=function(e){if(e.type==SPICE_MSG_DISPLAY_MODE)return this.known_unimplemented(e.type,"Display Mode"),!0;if(e.type==SPICE_MSG_DISPLAY_MARK)
// FIXME - DISPLAY_MARK not implemented (may be hard or impossible)
return this.known_unimplemented(e.type,"Display Mark"),!0;if(e.type==SPICE_MSG_DISPLAY_RESET)return 2<DEBUG&&console.log("Display reset"),this.surfaces[this.primary_surface].canvas.context.restore(),!0;if(e.type==SPICE_MSG_DISPLAY_DRAW_COPY){var t=new SpiceMsgDisplayDrawCopy(e.data);if(1<DEBUG&&this.log_draw("DrawCopy",t),t.base.box.is_same_size(t.data.src_area)||this.log_warn("FIXME: DrawCopy src_area is a different size than base.box; we do not handle that yet."),t.base.clip.type!=SPICE_CLIP_TYPE_NONE&&this.log_warn("FIXME: DrawCopy we don't handle clipping yet"),t.data.rop_descriptor!=SPICE_ROPD_OP_PUT&&this.log_warn("FIXME: DrawCopy we don't handle ropd type: "+t.data.rop_descriptor),t.data.mask.flags&&this.log_warn("FIXME: DrawCopy we don't handle mask flag: "+t.data.mask.flags),t.data.mask.bitmap&&this.log_warn("FIXME: DrawCopy we don't handle mask"),t.data&&t.data.src_bitmap){if(t.data.src_bitmap.descriptor.flags&&t.data.src_bitmap.descriptor.flags!=SPICE_IMAGE_FLAGS_CACHE_ME&&t.data.src_bitmap.descriptor.flags!=SPICE_IMAGE_FLAGS_HIGH_BITS_SET&&(this.log_warn("FIXME: DrawCopy unhandled image flags: "+t.data.src_bitmap.descriptor.flags),DEBUG<=1&&this.log_draw("DrawCopy",t)),t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_QUIC){var i=this.surfaces[t.base.surface_id].canvas;if(!t.data.src_bitmap.quic)return this.log_warn("FIXME: DrawCopy could not handle this QUIC file."),!1;var s=convert_spice_quic_to_web(i.context,t.data.src_bitmap.quic);return this.draw_copy_helper({base:t.base,src_area:t.data.src_area,image_data:s,tag:"copyquic."+t.data.src_bitmap.quic.type,has_alpha:t.data.src_bitmap.quic.type==QUIC_IMAGE_TYPE_RGBA,descriptor:t.data.src_bitmap.descriptor})}if(t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_FROM_CACHE||t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_FROM_CACHE_LOSSLESS)return this.cache&&this.cache[t.data.src_bitmap.descriptor.id]?this.draw_copy_helper({base:t.base,src_area:t.data.src_area,image_data:this.cache[t.data.src_bitmap.descriptor.id],tag:"copycache."+t.data.src_bitmap.descriptor.id,has_alpha:!0,/* FIXME - may want this to be false... */
descriptor:t.data.src_bitmap.descriptor}):(this.log_warn("FIXME: DrawCopy did not find image id "+t.data.src_bitmap.descriptor.id+" in cache."),!1);if(t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_SURFACE){var r=this.surfaces[t.data.src_bitmap.surface_id].canvas.context,_=(this.surfaces[t.base.surface_id].canvas.context,s=r.getImageData(t.data.src_area.left,t.data.src_area.top,t.data.src_area.right-t.data.src_area.left,t.data.src_area.bottom-t.data.src_area.top),new SpiceRect);
/* FIXME - there is a potential optimization here.
                           That is, if the surface is from 0,0, and
                           both surfaces are alpha surfaces, you should
                           be able to just do a drawImage, which should
                           save time.  */
return _.top=_.left=0,_.right=s.width,_.bottom=s.height,this.draw_copy_helper({base:t.base,src_area:_,image_data:s,tag:"copysurf."+t.data.src_bitmap.surface_id,has_alpha:this.surfaces[t.data.src_bitmap.surface_id].format!=SPICE_SURFACE_FMT_32_xRGB,descriptor:t.data.src_bitmap.descriptor})}if(t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_JPEG){if(!t.data.src_bitmap.jpeg)return this.log_warn("FIXME: DrawCopy could not handle this JPEG file."),!1;
// FIXME - how lame is this.  Be have it in binary format, and we have
//         to put it into string to get it back into jpeg.  Blech.
var n="data:image/jpeg,",a=new Image,o=new Uint8Array(t.data.src_bitmap.jpeg.data);for(y=0;y<o.length;y++)n+="%",o[y]<16&&(n+="0"),n+=o[y].toString(16);return a.o={base:t.base,tag:"jpeg."+t.data.src_bitmap.surface_id,descriptor:t.data.src_bitmap.descriptor,sc:this},a.onload=handle_draw_jpeg_onload,a.src=n,!0}if(t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_JPEG_ALPHA){if(!t.data.src_bitmap.jpeg_alpha)return this.log_warn("FIXME: DrawCopy could not handle this JPEG ALPHA file."),!1;
// FIXME - how lame is this.  Be have it in binary format, and we have
//         to put it into string to get it back into jpeg.  Blech.
n="data:image/jpeg,",a=new Image,o=new Uint8Array(t.data.src_bitmap.jpeg_alpha.data);for(y=0;y<o.length;y++)n+="%",o[y]<16&&(n+="0"),n+=o[y].toString(16);if(a.o={base:t.base,tag:"jpeg."+t.data.src_bitmap.surface_id,descriptor:t.data.src_bitmap.descriptor,sc:this},this.surfaces[t.base.surface_id].format==SPICE_SURFACE_FMT_32_ARGB){i=this.surfaces[t.base.surface_id].canvas;a.alpha_img=convert_spice_lz_to_web(i.context,t.data.src_bitmap.jpeg_alpha.alpha)}return a.onload=handle_draw_jpeg_onload,a.src=n,!0}if(t.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_BITMAP){i=this.surfaces[t.base.surface_id].canvas;return t.data.src_bitmap.bitmap?(s=convert_spice_bitmap_to_web(i.context,t.data.src_bitmap.bitmap))?this.draw_copy_helper({base:t.base,src_area:t.data.src_area,image_data:s,tag:"bitmap."+t.data.src_bitmap.bitmap.format,has_alpha:t.data.src_bitmap.bitmap!=SPICE_BITMAP_FMT_32BIT,descriptor:t.data.src_bitmap.descriptor}):(this.log_warn("FIXME: Unable to interpret bitmap of format: "+t.data.src_bitmap.bitmap.format),!1):(this.log_err("null bitmap"),!1)}if(t.data.src_bitmap.descriptor.type!=SPICE_IMAGE_TYPE_LZ_RGB)return this.log_warn("FIXME: DrawCopy unhandled image type: "+t.data.src_bitmap.descriptor.type),this.log_draw("DrawCopy",t),!1;i=this.surfaces[t.base.surface_id].canvas;return t.data.src_bitmap.lz_rgb?(s=convert_spice_lz_to_web(i.context,t.data.src_bitmap.lz_rgb))?this.draw_copy_helper({base:t.base,src_area:t.data.src_area,image_data:s,tag:"lz_rgb."+t.data.src_bitmap.lz_rgb.type,has_alpha:t.data.src_bitmap.lz_rgb.type==LZ_IMAGE_TYPE_RGBA,descriptor:t.data.src_bitmap.descriptor}):(this.log_warn("FIXME: Unable to interpret bitmap of type: "+t.data.src_bitmap.lz_rgb.type),!1):(this.log_err("null lz_rgb "),!1)}return this.log_warn("FIXME: DrawCopy no src_bitmap."),!1}if(e.type==SPICE_MSG_DISPLAY_DRAW_FILL){var c=new SpiceMsgDisplayDrawFill(e.data);if(1<DEBUG&&this.log_draw("DrawFill",c),c.data.rop_descriptor!=SPICE_ROPD_OP_PUT&&this.log_warn("FIXME: DrawFill we don't handle ropd type: "+c.data.rop_descriptor),c.data.mask.flags&&this.log_warn("FIXME: DrawFill we don't handle mask flag: "+c.data.mask.flags),c.data.mask.bitmap&&this.log_warn("FIXME: DrawFill we don't handle mask"),c.data.brush.type==SPICE_BRUSH_TYPE_SOLID){
// FIXME - do brushes ever have alpha?
var h=16777215&c.data.brush.color,p="rgb("+(h>>16)+", "+(h>>8&255)+", "+(255&h)+")";if(this.surfaces[c.base.surface_id].canvas.context.fillStyle=p,this.surfaces[c.base.surface_id].canvas.context.fillRect(c.base.box.left,c.base.box.top,c.base.box.right-c.base.box.left,c.base.box.bottom-c.base.box.top),DUMP_DRAWS&&this.parent.dump_id)(d=document.createElement("canvas")).setAttribute("width",this.surfaces[c.base.surface_id].canvas.width),d.setAttribute("height",this.surfaces[c.base.surface_id].canvas.height),d.setAttribute("id","fillbrush."+c.base.surface_id+"."+this.surfaces[c.base.surface_id].draw_count),d.getContext("2d").fillStyle=p,d.getContext("2d").fillRect(c.base.box.left,c.base.box.top,c.base.box.right-c.base.box.left,c.base.box.bottom-c.base.box.top),document.getElementById(this.parent.dump_id).appendChild(d);this.surfaces[c.base.surface_id].draw_count++}else this.log_warn("FIXME: DrawFill can't handle brush type: "+c.data.brush.type);return!0}if(e.type==SPICE_MSG_DISPLAY_DRAW_OPAQUE)return this.known_unimplemented(e.type,"Display Draw Opaque"),!0;if(e.type==SPICE_MSG_DISPLAY_DRAW_BLEND)return this.known_unimplemented(e.type,"Display Draw Blend"),!0;if(e.type==SPICE_MSG_DISPLAY_DRAW_BLACKNESS)return this.known_unimplemented(e.type,"Display Draw Blackness"),!0;if(e.type==SPICE_MSG_DISPLAY_DRAW_WHITENESS)return this.known_unimplemented(e.type,"Display Draw Whiteness"),!0;if(e.type==SPICE_MSG_DISPLAY_DRAW_INVERS)return this.known_unimplemented(e.type,"Display Draw Invers"),!0;if(e.type==SPICE_MSG_DISPLAY_DRAW_ROP3)return this.known_unimplemented(e.type,"Display Draw ROP3"),!0;if(e.type==SPICE_MSG_DISPLAY_DRAW_STROKE)return this.known_unimplemented(e.type,"Display Draw Stroke"),!0;if(e.type==SPICE_MSG_DISPLAY_DRAW_TRANSPARENT)return this.known_unimplemented(e.type,"Display Draw Transparent"),!0;if(e.type==SPICE_MSG_DISPLAY_DRAW_ALPHA_BLEND)return this.known_unimplemented(e.type,"Display Draw Alpha Blend"),!0;if(e.type==SPICE_MSG_DISPLAY_COPY_BITS){var u=new SpiceMsgDisplayCopyBits(e.data);1<DEBUG&&this.log_draw("CopyBits",u);var d,l=this.surfaces[u.base.surface_id].canvas,f=(r=l.context,l.width-u.src_pos.x),E=l.height-u.src_pos.y;if(f>u.base.box.right-u.base.box.left&&(f=u.base.box.right-u.base.box.left),E>u.base.box.bottom-u.base.box.top&&(E=u.base.box.bottom-u.base.box.top),
//source_context.putImageData(source_img, copy_bits.base.box.left, copy_bits.base.box.top);
putImageDataWithAlpha(r,s=r.getImageData(u.src_pos.x,u.src_pos.y,f,E),u.base.box.left,u.base.box.top),DUMP_DRAWS&&this.parent.dump_id)(d=document.createElement("canvas")).setAttribute("width",f),d.setAttribute("height",E),d.setAttribute("id","copybits"+u.base.surface_id+"."+this.surfaces[u.base.surface_id].draw_count),d.getContext("2d").putImageData(s,0,0),document.getElementById(this.parent.dump_id).appendChild(d);return this.surfaces[u.base.surface_id].draw_count++,!0}if(e.type==SPICE_MSG_DISPLAY_INVAL_ALL_PIXMAPS)return this.known_unimplemented(e.type,"Display Inval All Pixmaps"),!0;if(e.type==SPICE_MSG_DISPLAY_INVAL_PALETTE)return this.known_unimplemented(e.type,"Display Inval Palette"),!0;if(e.type==SPICE_MSG_DISPLAY_INVAL_ALL_PALETTES)return this.known_unimplemented(e.type,"Inval All Palettes"),!0;if(e.type==SPICE_MSG_DISPLAY_SURFACE_CREATE){"surfaces"in this||(this.surfaces=[]);var m=new SpiceMsgSurfaceCreate(e.data);return 1<DEBUG&&console.log(this.type+": MsgSurfaceCreate id "+m.surface.surface_id+"; "+m.surface.width+"x"+m.surface.height+"; format "+m.surface.format+"; flags "+m.surface.flags),m.surface.format!=SPICE_SURFACE_FMT_32_xRGB&&m.surface.format!=SPICE_SURFACE_FMT_32_ARGB?(this.log_warn("FIXME: cannot handle surface format "+m.surface.format+" yet."),!1):((i=document.createElement("canvas")).setAttribute("width",m.surface.width),i.setAttribute("height",m.surface.height),i.setAttribute("id","spice_surface_"+m.surface.surface_id),i.setAttribute("tabindex",m.surface.surface_id),i.context=i.getContext("2d"),DUMP_CANVASES&&this.parent.dump_id&&document.getElementById(this.parent.dump_id).appendChild(i),m.surface.canvas=i,m.surface.draw_count=0,this.surfaces[m.surface.surface_id]=m.surface,m.surface.flags&SPICE_SURFACE_FLAGS_PRIMARY&&(this.primary_surface=m.surface.surface_id,
/* This .save() is done entirely to enable SPICE_MSG_DISPLAY_RESET */
i.context.save(),document.getElementById(this.parent.screen_id).appendChild(i),
/* We're going to leave width dynamic, but correctly set the height */
document.getElementById(this.parent.screen_id).style.height=m.surface.height+"px",this.hook_events()),!0)}if(e.type==SPICE_MSG_DISPLAY_SURFACE_DESTROY){m=new SpiceMsgSurfaceDestroy(e.data);return 1<DEBUG&&console.log(this.type+": MsgSurfaceDestroy id "+m.surface_id),this.delete_surface(m.surface_id),!0}if(e.type==SPICE_MSG_DISPLAY_STREAM_CREATE){m=new SpiceMsgDisplayStreamCreate(e.data);if(0<STREAM_DEBUG&&console.log(this.type+": MsgStreamCreate id"+m.id+"; type "+m.codec_type+"; width "+m.stream_width+"; height "+m.stream_height+"; left "+m.dest.left+"; top "+m.dest.top),this.streams||(this.streams=new Array),this.streams[m.id]?console.log("Stream "+m.id+" already exists"):this.streams[m.id]=m,m.codec_type==SPICE_VIDEO_CODEC_TYPE_VP8){var S=new MediaSource,g=document.createElement("video");g.src=window.URL.createObjectURL(S),g.setAttribute("autoplay",!0),g.setAttribute("width",m.stream_width),g.setAttribute("height",m.stream_height);var b=m.dest.left,C=m.dest.top;void 0!==this.surfaces[m.surface_id]&&(b+=this.surfaces[m.surface_id].canvas.offsetLeft,C+=this.surfaces[m.surface_id].canvas.offsetTop),document.getElementById(this.parent.screen_id).appendChild(g),g.setAttribute("style","position: absolute; top:"+C+"px; left:"+b+"px;"),S.addEventListener("sourceopen",handle_video_source_open,!1),S.addEventListener("sourceended",handle_video_source_ended,!1),S.addEventListener("sourceclosed",handle_video_source_closed,!1);var I=this.streams[m.id];I.video=g,I.media=S,I.queue=new Array,I.start_time=0,I.cluster_time=0,I.append_okay=!1,S.stream=I,S.spiceconn=this,g.spice_stream=I}else m.codec_type==SPICE_VIDEO_CODEC_TYPE_MJPEG?this.streams[m.id].frames_loading=0:console.log("Unhandled stream codec: "+m.codec_type);return!0}if(e.type==SPICE_MSG_DISPLAY_STREAM_DATA||e.type==SPICE_MSG_DISPLAY_STREAM_DATA_SIZED){if(m=e.type==SPICE_MSG_DISPLAY_STREAM_DATA_SIZED?new SpiceMsgDisplayStreamDataSized(e.data):new SpiceMsgDisplayStreamData(e.data),!this.streams[m.base.id])return console.log("no stream for data"),!1;var A=m.base.multi_media_time-this.parent.relative_now();return this.streams[m.base.id].codec_type===SPICE_VIDEO_CODEC_TYPE_MJPEG&&process_mjpeg_stream_data(this,m,A),this.streams[m.base.id].codec_type===SPICE_VIDEO_CODEC_TYPE_VP8&&process_video_stream_data(this.streams[m.base.id],m),!0}if(e.type==SPICE_MSG_DISPLAY_STREAM_ACTIVATE_REPORT){var M=new SpiceMsgcDisplayStreamReport((m=new SpiceMsgDisplayStreamActivateReport(e.data)).stream_id,m.unique_id);return this.streams[m.stream_id]&&(this.streams[m.stream_id].report=M,this.streams[m.stream_id].max_window_size=m.max_window_size,this.streams[m.stream_id].timeout_ms=m.timeout_ms),!0}if(e.type==SPICE_MSG_DISPLAY_STREAM_CLIP){m=new SpiceMsgDisplayStreamClip(e.data);return 1<STREAM_DEBUG&&console.log(this.type+": MsgStreamClip id"+m.id),this.streams[m.id].clip=m.clip,!0}if(e.type==SPICE_MSG_DISPLAY_STREAM_DESTROY){m=new SpiceMsgDisplayStreamDestroy(e.data);return 0<STREAM_DEBUG&&console.log(this.type+": MsgStreamDestroy id"+m.id),this.streams[m.id].codec_type==SPICE_VIDEO_CODEC_TYPE_VP8&&(document.getElementById(this.parent.screen_id).removeChild(this.streams[m.id].video),this.streams[m.id].source_buffer=null,this.streams[m.id].media=null,this.streams[m.id].video=null),!(this.streams[m.id]=void 0)}if(e.type==SPICE_MSG_DISPLAY_STREAM_DESTROY_ALL)return this.known_unimplemented(e.type,"Display Stream Destroy All"),!0;if(e.type!=SPICE_MSG_DISPLAY_INVAL_LIST)return e.type==SPICE_MSG_DISPLAY_MONITORS_CONFIG?(this.known_unimplemented(e.type,"Display Monitors Config"),!0):e.type==SPICE_MSG_DISPLAY_DRAW_COMPOSITE&&(this.known_unimplemented(e.type,"Display Draw Composite"),!0);var y;m=new SpiceMsgDisplayInvalList(e.data);for(1<DEBUG&&console.log(this.type+": MsgInvalList "+m.count+" items"),y=0;y<m.count;y++)null!=this.cache[m.resources[y].id]&&delete this.cache[m.resources[y].id];return!0},SpiceDisplayConn.prototype.delete_surface=function(e){var t=document.getElementById("spice_surface_"+e);DUMP_CANVASES&&this.parent.dump_id&&document.getElementById(this.parent.dump_id).removeChild(t),this.primary_surface==e&&(this.unhook_events(),this.primary_surface=void 0,document.getElementById(this.parent.screen_id).removeChild(t)),delete this.surfaces[e]},SpiceDisplayConn.prototype.draw_copy_helper=function(e){var t=this.surfaces[e.base.surface_id].canvas;if(e.has_alpha?
/* FIXME - This is based on trial + error, not a serious thoughtful
                   analysis of what Spice requires.  See display.js for more. */
this.surfaces[e.base.surface_id].format==SPICE_SURFACE_FMT_32_xRGB?(stripAlpha(e.image_data),t.context.putImageData(e.image_data,e.base.box.left,e.base.box.top)):putImageDataWithAlpha(t.context,e.image_data,e.base.box.left,e.base.box.top):t.context.putImageData(e.image_data,e.base.box.left,e.base.box.top),(0<e.src_area.left||0<e.src_area.top)&&this.log_warn("FIXME: DrawCopy not shifting draw copies just yet..."),e.descriptor&&e.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in this||(this.cache={}),this.cache[e.descriptor.id]=e.image_data),DUMP_DRAWS&&this.parent.dump_id){var i=document.createElement("canvas");i.setAttribute("width",e.image_data.width),i.setAttribute("height",e.image_data.height),i.setAttribute("id",e.tag+"."+this.surfaces[e.base.surface_id].draw_count+"."+e.base.surface_id+"@"+e.base.box.left+"x"+e.base.box.top),i.getContext("2d").putImageData(e.image_data,0,0),document.getElementById(this.parent.dump_id).appendChild(i)}return this.surfaces[e.base.surface_id].draw_count++,!0},SpiceDisplayConn.prototype.log_draw=function(e,t){var i=e+"."+t.base.surface_id+"."+this.surfaces[t.base.surface_id].draw_count+": ";i+="base.box "+t.base.box.left+", "+t.base.box.top+" to "+t.base.box.right+", "+t.base.box.bottom,i+="; clip.type "+t.base.clip.type,t.data&&(t.data.src_area&&(i+="; src_area "+t.data.src_area.left+", "+t.data.src_area.top+" to "+t.data.src_area.right+", "+t.data.src_area.bottom),t.data.src_bitmap&&null!=t.data.src_bitmap?(i+="; src_bitmap id: "+t.data.src_bitmap.descriptor.id,i+="; src_bitmap width "+t.data.src_bitmap.descriptor.width+", height "+t.data.src_bitmap.descriptor.height,i+="; src_bitmap type "+t.data.src_bitmap.descriptor.type+", flags "+t.data.src_bitmap.descriptor.flags,void 0!==t.data.src_bitmap.surface_id&&(i+="; src_bitmap surface_id "+t.data.src_bitmap.surface_id),t.data.src_bitmap.bitmap&&(i+="; BITMAP format "+t.data.src_bitmap.bitmap.format+"; flags "+t.data.src_bitmap.bitmap.flags+"; x "+t.data.src_bitmap.bitmap.x+"; y "+t.data.src_bitmap.bitmap.y+"; stride "+t.data.src_bitmap.bitmap.stride),t.data.src_bitmap.quic&&(i+="; QUIC type "+t.data.src_bitmap.quic.type+"; width "+t.data.src_bitmap.quic.width+"; height "+t.data.src_bitmap.quic.height),t.data.src_bitmap.lz_rgb&&(i+="; LZ_RGB length "+t.data.src_bitmap.lz_rgb.length+"; magic "+t.data.src_bitmap.lz_rgb.magic+"; version 0x"+t.data.src_bitmap.lz_rgb.version.toString(16)+"; type "+t.data.src_bitmap.lz_rgb.type+"; width "+t.data.src_bitmap.lz_rgb.width+"; height "+t.data.src_bitmap.lz_rgb.height+"; stride "+t.data.src_bitmap.lz_rgb.stride+"; top down "+t.data.src_bitmap.lz_rgb.top_down)):i+="; src_bitmap is null",t.data.brush&&(t.data.brush.type==SPICE_BRUSH_TYPE_SOLID&&(i+="; brush.color 0x"+t.data.brush.color.toString(16)),t.data.brush.type==SPICE_BRUSH_TYPE_PATTERN&&(i+="; brush.pat ",null!=t.data.brush.pattern.pat?i+="[SpiceImage]":i+="[null]",i+=" at "+t.data.brush.pattern.pos.x+", "+t.data.brush.pattern.pos.y)),i+="; rop_descriptor "+t.data.rop_descriptor,void 0!==t.data.scale_mode&&(i+="; scale_mode "+t.data.scale_mode),i+="; mask.flags "+t.data.mask.flags,i+="; mask.pos "+t.data.mask.pos.x+", "+t.data.mask.pos.y,null!=t.data.mask.bitmap?(i+="; mask.bitmap width "+t.data.mask.bitmap.descriptor.width+", height "+t.data.mask.bitmap.descriptor.height,i+="; mask.bitmap type "+t.data.mask.bitmap.descriptor.type+", flags "+t.data.mask.bitmap.descriptor.flags):i+="; mask.bitmap is null"),console.log(i)},SpiceDisplayConn.prototype.hook_events=function(){if(void 0!==this.primary_surface){var e=this.surfaces[this.primary_surface].canvas;e.sc=this.parent,e.addEventListener("mousemove",handle_mousemove),e.addEventListener("mousedown",handle_mousedown),e.addEventListener("contextmenu",handle_contextmenu),e.addEventListener("mouseup",handle_mouseup),e.addEventListener("keydown",handle_keydown),e.addEventListener("keyup",handle_keyup),e.addEventListener("mouseout",handle_mouseout),e.addEventListener("mouseover",handle_mouseover),e.addEventListener("wheel",handle_mousewheel),e.focus()}},SpiceDisplayConn.prototype.unhook_events=function(){if(void 0!==this.primary_surface){var e=this.surfaces[this.primary_surface].canvas;e.removeEventListener("mousemove",handle_mousemove),e.removeEventListener("mousedown",handle_mousedown),e.removeEventListener("contextmenu",handle_contextmenu),e.removeEventListener("mouseup",handle_mouseup),e.removeEventListener("keydown",handle_keydown),e.removeEventListener("keyup",handle_keyup),e.removeEventListener("mouseout",handle_mouseout),e.removeEventListener("mouseover",handle_mouseover),e.removeEventListener("wheel",handle_mousewheel)}},SpiceDisplayConn.prototype.destroy_surfaces=function(){for(var e in this.surfaces)this.delete_surface(this.surfaces[e].surface_id);this.surfaces=void 0},SpicePortConn.prototype=Object.create(SpiceConn.prototype),SpicePortConn.prototype.process_channel_message=function(e){if(e.type==SPICE_MSG_PORT_INIT){if(null===this.port_name){var t=new SpiceMsgPortInit(e.data);return this.portName=arraybuffer_to_str(new Uint8Array(t.name)),this.portOpened=t.opened,0<DEBUG&&console.log("SPICE port: Port",this.portName,"initialized"),!0}0<DEBUG&&console.log("SPICE port: Port",this.port_name,"is already initialized.")}else{if(e.type==SPICE_MSG_PORT_EVENT){0<DEBUG&&console.log("SPICE port: Port event received for",this.portName,e);var i=new CustomEvent("spice-port-event",{detail:{channel:this,spiceEvent:new Uint8Array(e.data)},bubbles:!0,cancelable:!0});return window.dispatchEvent(i),!0}if(e.type==SPICE_MSG_SPICEVMC_DATA){0<DEBUG&&console.log("SPICE port: Data received in port",this.portName,e);i=new CustomEvent("spice-port-data",{detail:{channel:this,data:e.data},bubbles:!0,cancelable:!0});return window.dispatchEvent(i),!0}0<DEBUG&&console.log("SPICE port: SPICE message type not recognized:",e)}return!1},SpiceMainConn.prototype=Object.create(SpiceConn.prototype),SpiceMainConn.prototype.process_channel_message=function(e){if(e.type==SPICE_MSG_MAIN_MIGRATE_BEGIN)return this.known_unimplemented(e.type,"Main Migrate Begin"),!0;if(e.type==SPICE_MSG_MAIN_MIGRATE_CANCEL)return this.known_unimplemented(e.type,"Main Migrate Cancel"),!0;if(e.type==SPICE_MSG_MAIN_INIT){this.log_info("Connected to "+this.ws.url),this.report_success("Connected"),this.main_init=new SpiceMsgMainInit(e.data),this.connection_id=this.main_init.session_id,this.agent_tokens=this.main_init.agent_tokens,0<DEBUG&&
// FIXME - there is a lot here we don't handle; mouse modes, agent,
//          ram_hint, multi_media_time
this.log_info("session id "+this.main_init.session_id+" ; display_channels_hint "+this.main_init.display_channels_hint+" ; supported_mouse_modes "+this.main_init.supported_mouse_modes+" ; current_mouse_mode "+this.main_init.current_mouse_mode+" ; agent_connected "+this.main_init.agent_connected+" ; agent_tokens "+this.main_init.agent_tokens+" ; multi_media_time "+this.main_init.multi_media_time+" ; ram_hint "+this.main_init.ram_hint),this.our_mm_time=Date.now(),this.mm_time=this.main_init.multi_media_time,this.handle_mouse_mode(this.main_init.current_mouse_mode,this.main_init.supported_mouse_modes),this.main_init.agent_connected&&this.connect_agent();var t=new SpiceMiniData;return t.type=SPICE_MSGC_MAIN_ATTACH_CHANNELS,t.size=t.buffer_size(),this.send_msg(t),!0}if(e.type==SPICE_MSG_MAIN_MOUSE_MODE){var i=new SpiceMsgMainMouseMode(e.data);return 0<DEBUG&&this.log_info("Mouse supported modes "+i.supported_modes+"; current "+i.current_mode),this.handle_mouse_mode(i.current_mode,i.supported_modes),!0}if(e.type==SPICE_MSG_MAIN_MULTI_MEDIA_TIME)return this.known_unimplemented(e.type,"Main Multi Media Time"),!0;if(e.type==SPICE_MSG_MAIN_CHANNELS_LIST){var s,r;for(0<DEBUG&&console.log("channels"),r=new SpiceMsgChannels(e.data),s=0;s<r.channels.length;s++){var _={uri:this.ws.url,parent:this,connection_id:this.connection_id,type:r.channels[s].type,chan_id:r.channels[s].id};r.channels[s].type==SPICE_CHANNEL_DISPLAY?0==r.channels[s].id?this.display=new SpiceDisplayConn(_):this.log_warn("The spice-html5 client does not handle multiple heads."):r.channels[s].type==SPICE_CHANNEL_INPUTS?(this.inputs=new SpiceInputsConn(_),this.inputs.mouse_mode=this.mouse_mode):r.channels[s].type==SPICE_CHANNEL_CURSOR?this.cursor=new SpiceCursorConn(_):r.channels[s].type==SPICE_CHANNEL_PLAYBACK?this.cursor=new SpicePlaybackConn(_):r.channels[s].type==SPICE_CHANNEL_PORT?this.ports.push(new SpicePortConn(_)):("extra_channels"in this||(this.extra_channels=[]),this.extra_channels[s]=new SpiceConn(_),this.log_err("Channel type "+this.extra_channels[s].channel_type()+" not implemented"))}return!0}if(e.type==SPICE_MSG_MAIN_AGENT_CONNECTED)return this.connect_agent(),!0;if(e.type==SPICE_MSG_MAIN_AGENT_CONNECTED_TOKENS){var n=new SpiceMsgMainAgentTokens(e.data);return this.agent_tokens=n.num_tokens,this.connect_agent(),!0}if(e.type==SPICE_MSG_MAIN_AGENT_TOKEN){var a,o=new SpiceMsgMainAgentTokens(e.data);for(this.agent_tokens+=o.num_tokens,this.send_agent_message_queue(),a=this.agent_tokens;0<a&&0<this.file_xfer_read_queue.length;){var c=this.file_xfer_read_queue.shift();this.file_xfer_read(c,c.read_bytes),a--}return!0}if(e.type==SPICE_MSG_MAIN_AGENT_DISCONNECTED)return!(this.agent_connected=!1);if(e.type!=SPICE_MSG_MAIN_AGENT_DATA)return e.type==SPICE_MSG_MAIN_MIGRATE_SWITCH_HOST?(this.known_unimplemented(e.type,"Main Migrate Switch Host"),!0):e.type==SPICE_MSG_MAIN_MIGRATE_END?(this.known_unimplemented(e.type,"Main Migrate End"),!0):e.type==SPICE_MSG_MAIN_NAME?(this.known_unimplemented(e.type,"Main Name"),!0):e.type==SPICE_MSG_MAIN_UUID?(this.known_unimplemented(e.type,"Main UUID"),!0):e.type==SPICE_MSG_MAIN_MIGRATE_BEGIN_SEAMLESS?(this.known_unimplemented(e.type,"Main Migrate Begin Seamless"),!0):e.type==SPICE_MSG_MAIN_MIGRATE_DST_SEAMLESS_ACK?(this.known_unimplemented(e.type,"Main Migrate Dst Seamless ACK"),!0):e.type==SPICE_MSG_MAIN_MIGRATE_DST_SEAMLESS_NACK&&(this.known_unimplemented(e.type,"Main Migrate Dst Seamless NACK"),!0);var h=new SpiceMsgMainAgentData(e.data);return h.type==VD_AGENT_ANNOUNCE_CAPABILITIES?(new VDAgentAnnounceCapabilities(h.data).request&&this.announce_agent_capabilities(0),!0):h.type==VD_AGENT_FILE_XFER_STATUS&&(this.handle_file_xfer_status(new VDAgentFileXferStatusMessage(h.data)),!0)},SpiceMainConn.prototype.stop=function(e){if(this.state="closing",this.inputs&&(this.inputs.cleanup(),this.inputs=void 0),this.cursor&&(this.cursor.cleanup(),this.cursor=void 0),this.display&&(this.display.cleanup(),this.display.destroy_surfaces(),this.display=void 0),this.cleanup(),"extra_channels"in this)for(var t in this.extra_channels)this.extra_channels[t].cleanup();this.extra_channels=void 0},SpiceMainConn.prototype.send_agent_message_queue=function(e){if(this.agent_connected)for(e&&this.agent_msg_queue.push(e);0<this.agent_tokens&&0<this.agent_msg_queue.length;){var t=this.agent_msg_queue.shift();this.send_msg(t),this.agent_tokens--}},SpiceMainConn.prototype.send_agent_message=function(e,t){var i=new SpiceMsgcMainAgentData(e,t),s=0,r=VD_AGENT_MAX_DATA_SIZE-SpiceMiniData.prototype.buffer_size(),_=new ArrayBuffer(i.buffer_size());for(i.to_buffer(_);s<i.buffer_size();){var n=Math.min(s+r,i.buffer_size()),a=new SpiceMiniData;a.type=SPICE_MSGC_MAIN_AGENT_DATA,a.size=n-s,a.data=_.slice(s,n),this.send_agent_message_queue(a),s=n}},SpiceMainConn.prototype.announce_agent_capabilities=function(e){var t=new VDAgentAnnounceCapabilities(e,1<<VD_AGENT_CAP_MOUSE_STATE|1<<VD_AGENT_CAP_MONITORS_CONFIG|1<<VD_AGENT_CAP_REPLY);this.send_agent_message(VD_AGENT_ANNOUNCE_CAPABILITIES,t)},SpiceMainConn.prototype.resize_window=function(e,t,i,s,r,_){var n=new VDAgentMonitorsConfig(e,t,i,s,r,_);this.send_agent_message(VD_AGENT_MONITORS_CONFIG,n)},SpiceMainConn.prototype.file_xfer_start=function(e){var t,i,s;(s=new SpiceFileXferTask(t=this.file_xfer_task_id++,e)).create_progressbar(),this.file_xfer_tasks[t]=s,i=new VDAgentFileXferStartMessage(t,e.name,e.size),this.send_agent_message(VD_AGENT_FILE_XFER_START,i)},SpiceMainConn.prototype.handle_file_xfer_status=function(e){var t,i;if(this.file_xfer_tasks[e.id]){switch(i=this.file_xfer_tasks[e.id],e.result){case VD_AGENT_FILE_XFER_STATUS_CAN_SEND_DATA:return void this.file_xfer_read(i);case VD_AGENT_FILE_XFER_STATUS_CANCELLED:t="transfer is cancelled by spice agent";break;case VD_AGENT_FILE_XFER_STATUS_ERROR:t="some errors occurred in the spice agent";break;case VD_AGENT_FILE_XFER_STATUS_SUCCESS:break;default:t="unhandled status type: "+e.result}this.file_xfer_completed(i,t)}},SpiceMainConn.prototype.file_xfer_read=function(i,e){var t,s,r,_,n=32*VD_AGENT_MAX_DATA_SIZE,a=this;if(i&&this.file_xfer_tasks[i.id]&&!(0<e&&e==i.file.size)){if(i.cancelled){var o=new VDAgentFileXferStatusMessage(i.id,VD_AGENT_FILE_XFER_STATUS_CANCELLED);return this.send_agent_message(VD_AGENT_FILE_XFER_STATUS,o),void delete this.file_xfer_tasks[i.id]}if(t=e||0,s=Math.min(t+n,i.file.size),!this.agent_tokens)return i.read_bytes=t,void this.file_xfer_read_queue.push(i);(_=new FileReader).onload=function(e){var t=new VDAgentFileXferDataMessage(i.id,e.target.result.byteLength,e.target.result);a.send_agent_message(VD_AGENT_FILE_XFER_DATA,t),a.file_xfer_read(i,s),i.update_progressbar(s)},r=i.file.slice(t,s),_.readAsArrayBuffer(r)}},SpiceMainConn.prototype.file_xfer_completed=function(e,t){t?this.log_err(t):this.log_info("transfer of '"+e.file.name+"' was successful"),e.remove_progressbar(),delete this.file_xfer_tasks[e.id]},SpiceMainConn.prototype.connect_agent=function(){this.agent_connected=!0;var e=new SpiceMsgcMainAgentStart(-1),t=new SpiceMiniData;t.build_msg(SPICE_MSGC_MAIN_AGENT_START,e),this.send_msg(t),this.announce_agent_capabilities(1),void 0!==this.onagent&&this.onagent(this)},SpiceMainConn.prototype.handle_mouse_mode=function(e,t){if((this.mouse_mode=e)!=SPICE_MOUSE_MODE_CLIENT&&t&SPICE_MOUSE_MODE_CLIENT){var i=new SpiceMsgcMainMouseModeRequest(SPICE_MOUSE_MODE_CLIENT),s=new SpiceMiniData;s.build_msg(SPICE_MSGC_MAIN_MOUSE_MODE_REQUEST,i),this.send_msg(s)}this.inputs&&(this.inputs.mouse_mode=e)}
/* Shift current time to attempt to get a time matching that of the server */,SpiceMainConn.prototype.relative_now=function(){return Date.now()-this.our_mm_time+this.mm_time};
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
 ** Modifier Keystates
 **     These need to be tracked because focus in and out can get the keyboard
 **     out of sync.
 **------------------------------------------------------------------------*/
var Shift_state=-1,Ctrl_state=-1,Alt_state=-1,Meta_state=-1;
/*----------------------------------------------------------------------------
**  SpiceInputsConn
**      Drive the Spice Inputs channel (e.g. mouse + keyboard)
**--------------------------------------------------------------------------*/
function SpiceInputsConn(){SpiceConn.apply(this,arguments),this.mousex=void 0,this.mousey=void 0,this.button_state=0,this.waiting_for_ack=0}function handle_mousemove(e){var t,i=new SpiceMiniData;this.sc.mouse_mode==SPICE_MOUSE_MODE_CLIENT?(t=new SpiceMsgcMousePosition(this.sc,e),i.build_msg(SPICE_MSGC_INPUTS_MOUSE_POSITION,t)):(t=new SpiceMsgcMouseMotion(this.sc,e),i.build_msg(SPICE_MSGC_INPUTS_MOUSE_MOTION,t)),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&(this.sc.inputs.waiting_for_ack<2*SPICE_INPUT_MOTION_ACK_BUNCH?(this.sc.inputs.send_msg(i),this.sc.inputs.waiting_for_ack++):0<DEBUG&&this.sc.log_info("Discarding mouse motion")),this.sc&&this.sc.cursor&&this.sc.cursor.spice_simulated_cursor&&(this.sc.cursor.spice_simulated_cursor.style.display="block",this.sc.cursor.spice_simulated_cursor.style.left=e.pageX-this.sc.cursor.spice_simulated_cursor.spice_hot_x+"px",this.sc.cursor.spice_simulated_cursor.style.top=e.pageY-this.sc.cursor.spice_simulated_cursor.spice_hot_y+"px",e.preventDefault())}function handle_mousedown(e){var t=new SpiceMsgcMousePress(this.sc,e),i=new SpiceMiniData;i.build_msg(SPICE_MSGC_INPUTS_MOUSE_PRESS,t),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(i),e.preventDefault()}function handle_contextmenu(e){return e.preventDefault(),!1}function handle_mouseup(e){var t=new SpiceMsgcMouseRelease(this.sc,e),i=new SpiceMiniData;i.build_msg(SPICE_MSGC_INPUTS_MOUSE_RELEASE,t),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(i),e.preventDefault()}function handle_mousewheel(e){var t=new SpiceMsgcMousePress,i=new SpiceMsgcMouseRelease;e.deltaY<0?t.button=i.button=SPICE_MOUSE_BUTTON_UP:t.button=i.button=SPICE_MOUSE_BUTTON_DOWN,t.buttons_state=0,i.buttons_state=0;var s=new SpiceMiniData;s.build_msg(SPICE_MSGC_INPUTS_MOUSE_PRESS,t),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(s),s.build_msg(SPICE_MSGC_INPUTS_MOUSE_RELEASE,i),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(s),e.preventDefault()}function handle_keydown(e){var t=new SpiceMsgcKeyDown(e),i=new SpiceMiniData;check_and_update_modifiers(e,t.code,this.sc),i.build_msg(SPICE_MSGC_INPUTS_KEY_DOWN,t),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(i),e.preventDefault()}function handle_keyup(e){var t=new SpiceMsgcKeyUp(e),i=new SpiceMiniData;check_and_update_modifiers(e,t.code,this.sc),i.build_msg(SPICE_MSGC_INPUTS_KEY_UP,t),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(i),e.preventDefault()}function sendCtrlAltDel(){if(sc&&sc.inputs&&"ready"===sc.inputs.state){var e=new SpiceMsgcKeyDown,t=new SpiceMiniData;update_modifier(!0,KEY_LCtrl,sc),update_modifier(!0,KEY_Alt,sc),e.code=KEY_KP_Decimal,t.build_msg(SPICE_MSGC_INPUTS_KEY_DOWN,e),sc.inputs.send_msg(t),t.build_msg(SPICE_MSGC_INPUTS_KEY_UP,e),sc.inputs.send_msg(t),0==Ctrl_state&&update_modifier(!1,KEY_LCtrl,sc),0==Alt_state&&update_modifier(!1,KEY_Alt,sc)}}function update_modifier(e,t,i){var s,r=new SpiceMiniData;e?((s=new SpiceMsgcKeyDown).code=t,r.build_msg(SPICE_MSGC_INPUTS_KEY_DOWN,s)):((s=new SpiceMsgcKeyUp).code=128|t,r.build_msg(SPICE_MSGC_INPUTS_KEY_UP,s));i.inputs.send_msg(r)}function check_and_update_modifiers(e,t,i){-1===Shift_state&&(Shift_state=e.shiftKey,Ctrl_state=e.ctrlKey,Alt_state=e.altKey,Meta_state=e.metaKey),t===KEY_ShiftL?Shift_state=!0:t===KEY_Alt?Alt_state=!0:t===KEY_LCtrl?Ctrl_state=!0:57525===t?Meta_state=!0:t===(128|KEY_ShiftL)?Shift_state=!1:t===(128|KEY_Alt)?Alt_state=!1:t===(128|KEY_LCtrl)?Ctrl_state=!1:57525===t&&(Meta_state=!1),i&&i.inputs&&"ready"===i.inputs.state&&(Shift_state!=e.shiftKey&&(console.log("Shift state out of sync"),update_modifier(e.shiftKey,KEY_ShiftL,i),Shift_state=e.shiftKey),Alt_state!=e.altKey&&(console.log("Alt state out of sync"),update_modifier(e.altKey,KEY_Alt,i),Alt_state=e.altKey),Ctrl_state!=e.ctrlKey&&(console.log("Ctrl state out of sync"),update_modifier(e.ctrlKey,KEY_LCtrl,i),Ctrl_state=e.ctrlKey),Meta_state!=e.metaKey&&(console.log("Meta state out of sync"),update_modifier(e.metaKey,57525,i),Meta_state=e.metaKey))}SpiceInputsConn.prototype=Object.create(SpiceConn.prototype),SpiceInputsConn.prototype.process_channel_message=function(e){if(e.type==SPICE_MSG_INPUTS_INIT){var t=new SpiceMsgInputsInit(e.data);
// FIXME - We don't do anything with the keyboard modifiers...
return this.keyboard_modifiers=t.keyboard_modifiers,1<DEBUG&&console.log("MsgInputsInit - modifier "+this.keyboard_modifiers),!0}if(e.type!=SPICE_MSG_INPUTS_KEY_MODIFIERS)return e.type==SPICE_MSG_INPUTS_MOUSE_MOTION_ACK&&(1<DEBUG&&console.log("mouse motion ack"),this.waiting_for_ack-=SPICE_INPUT_MOTION_ACK_BUNCH,!0);var i=new SpiceMsgInputsKeyModifiers(e.data);
// FIXME - We don't do anything with the keyboard modifiers...
return this.keyboard_modifiers=i.keyboard_modifiers,1<DEBUG&&console.log("MsgInputsKeyModifiers - modifier "+this.keyboard_modifiers),!0};
/*
   Copyright (C) 2014 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  EBML identifiers
**--------------------------------------------------------------------------*/
var EBML_HEADER=[26,69,223,163],EBML_HEADER_VERSION=[66,134],EBML_HEADER_READ_VERSION=[66,247],EBML_HEADER_MAX_ID_LENGTH=[66,242],EBML_HEADER_MAX_SIZE_LENGTH=[66,243],EBML_HEADER_DOC_TYPE=[66,130],EBML_HEADER_DOC_TYPE_VERSION=[66,135],EBML_HEADER_DOC_TYPE_READ_VERSION=[66,133],WEBM_SEGMENT_HEADER=[24,83,128,103],WEBM_SEGMENT_INFORMATION=[21,73,169,102],WEBM_TIMECODE_SCALE=[42,215,177],WEBM_MUXING_APP=[77,128],WEBM_WRITING_APP=[87,65],WEBM_SEEK_HEAD=[17,77,155,116],WEBM_SEEK=[77,187],WEBM_SEEK_ID=[83,171],WEBM_SEEK_POSITION=[83,172],WEBM_TRACKS=[22,84,174,107],WEBM_TRACK_ENTRY=[174],WEBM_TRACK_NUMBER=[215],WEBM_TRACK_UID=[115,197],WEBM_TRACK_TYPE=[131],WEBM_FLAG_ENABLED=[185],WEBM_FLAG_DEFAULT=[136],WEBM_FLAG_FORCED=[85,170],WEBM_FLAG_LACING=[156],WEBM_MIN_CACHE=[109,231],WEBM_MAX_BLOCK_ADDITION_ID=[85,238],WEBM_CODEC_DECODE_ALL=[170],WEBM_SEEK_PRE_ROLL=[86,187],WEBM_CODEC_DELAY=[86,170],WEBM_CODEC_PRIVATE=[99,162],WEBM_CODEC_ID=[134],WEBM_VIDEO=[224],WEBM_PIXEL_WIDTH=[176],WEBM_PIXEL_HEIGHT=[186],WEBM_AUDIO=[225],WEBM_SAMPLING_FREQUENCY=[181],WEBM_CHANNELS=[159],WEBM_CLUSTER=[31,67,182,117],WEBM_TIME_CODE=[231],WEBM_SIMPLE_BLOCK=[163],CLUSTER_SIMPLEBLOCK_FLAG_KEYFRAME=128,OPUS_FREQUENCY=48e3,OPUS_CHANNELS=2,SPICE_PLAYBACK_CODEC='audio/webm; codecs="opus"',MAX_CLUSTER_TIME=1e3,EXPECTED_PACKET_DURATION=10,GAP_DETECTION_THRESHOLD=50,SPICE_VP8_CODEC='video/webm; codecs="vp8"';
/*----------------------------------------------------------------------------
**  EBML utility functions
**      These classes can create the binary representation of a webm file
**--------------------------------------------------------------------------*/
function EBML_write_u1_data_len(e,t,i){var s=128|e;return t.setUint8(i,s),i+1}function EBML_write_u8_value(e,t,i,s){return s=EBML_write_u1_data_len(1,i,s=EBML_write_array(e,i,s)),i.setUint8(s,t),s+1}function EBML_write_u32_value(e,t,i,s){return s=EBML_write_u1_data_len(4,i,s=EBML_write_array(e,i,s)),i.setUint32(s,t),s+4}function EBML_write_u16_value(e,t,i,s){return s=EBML_write_u1_data_len(2,i,s=EBML_write_array(e,i,s)),i.setUint16(s,t),s+2}function EBML_write_float_value(e,t,i,s){return s=EBML_write_u1_data_len(4,i,s=EBML_write_array(e,i,s)),i.setFloat32(s,t),s+4}function EBML_write_u64_data_len(e,t,i){
/* Javascript doesn't do 64 bit ints, so this cheats and
        just has a max of 32 bits.  Fine for our purposes */
t.setUint8(i++,1),t.setUint8(i++,0),t.setUint8(i++,0),t.setUint8(i++,0);for(var s=4294967295&e,r=24;0<=r;r-=8)t.setUint8(i++,s>>r);return i}function EBML_write_array(e,t,i){for(var s=0;s<e.length;s++)t.setUint8(i+s,e[s]);return i+e.length}function EBML_write_string(e,t,i){for(var s=0;s<e.length;s++)t.setUint8(i+s,e.charCodeAt(s));return i+e.length}function EBML_write_data(e,t,i,s){return s=EBML_write_array(e,i,s),s=t.length<127?EBML_write_u1_data_len(t.length,i,s):EBML_write_u64_data_len(t.length,i,s),s="string"==typeof t?EBML_write_string(t,i,s):EBML_write_array(t,i,s)}
/*----------------------------------------------------------------------------
**  Webm objects
**      These classes can create the binary representation of a webm file
**--------------------------------------------------------------------------*/function EBMLHeader(){this.id=EBML_HEADER,this.Version=1,this.ReadVersion=1,this.MaxIDLength=4,this.MaxSizeLength=8,this.DocType="webm",this.DocTypeVersion=2,/* Not well specified by the WebM guys, but functionally required for Firefox */
this.DocTypeReadVersion=2}function webm_Segment(){this.id=WEBM_SEGMENT_HEADER}function webm_SegmentInformation(){this.id=WEBM_SEGMENT_INFORMATION,this.timecode_scale=1e6,/* 1 ms */
this.muxing_app="spice",this.writing_app="spice-html5"}function webm_Audio(e){this.id=WEBM_AUDIO,this.sampling_frequency=e,this.channels=OPUS_CHANNELS}function webm_Video(e,t){this.id=WEBM_VIDEO,this.width=e,this.height=t}
/* ---------------------------
   SeekHead not currently used.  Hopefully not needed.
*/
function webm_Seek(e,t){this.id=WEBM_SEEK,this.pos=t,this.seekid=e}function webm_SeekHead(e,t){this.id=WEBM_SEEK_HEAD,this.info=new webm_Seek(WEBM_SEGMENT_INFORMATION,e),this.track=new webm_Seek(WEBM_TRACKS,t)}
/* -------------------------------
   End of Seek Head
*/
function webm_AudioTrackEntry(){this.id=WEBM_TRACK_ENTRY,this.number=1,this.uid=1,this.type=2,// Audio
this.flag_enabled=1,this.flag_default=1,this.flag_forced=1,this.flag_lacing=0,this.min_cache=0,// fixme - check
this.max_block_addition_id=0,this.codec_decode_all=0,// fixme - check
this.seek_pre_roll=0,// 80000000; // fixme - check
this.codec_delay=8e7,// Must match codec_private.preskip
this.codec_id="A_OPUS",this.audio=new webm_Audio(OPUS_FREQUENCY),
// See:  http://tools.ietf.org/html/draft-terriberry-oggopus-01
this.codec_private=[79,112,117,115,72,101,97,100,// OpusHead
1,// Version
OPUS_CHANNELS,0,15,// Preskip - 3840 samples - should be 8ms at 48kHz
128,187,0,0,// 48000
0,0,// Output gain
0]}function webm_VideoTrackEntry(e,t){this.id=WEBM_TRACK_ENTRY,this.number=1,this.uid=1,this.type=1,// Video
this.flag_enabled=1,this.flag_default=1,this.flag_forced=1,this.flag_lacing=0,this.min_cache=0,// fixme - check
this.max_block_addition_id=0,this.codec_decode_all=0,// fixme - check
this.seek_pre_roll=0,// 80000000; // fixme - check
this.codec_delay=8e7,// Must match codec_private.preskip
this.codec_id="V_VP8",this.video=new webm_Video(e,t)}function webm_Tracks(e){this.id=WEBM_TRACKS,this.track_entry=e}function webm_Cluster(e,t){this.id=WEBM_CLUSTER,this.timecode=e,this.data=t}function webm_SimpleBlock(e,t,i){this.id=WEBM_SIMPLE_BLOCK,this.timecode=e,this.data=t,this.keyframe=i}function webm_Header(){this.ebml=new EBMLHeader,this.segment=new webm_Segment,this.seek_head=new webm_SeekHead(0,0),this.seek_head.info.pos=this.segment.buffer_size()+this.seek_head.buffer_size(),this.info=new webm_SegmentInformation,this.seek_head.track.pos=this.seek_head.info.pos+this.info.buffer_size()}
/*
   Copyright (C) 2014 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  SpicePlaybackConn
**      Drive the Spice Playback channel (sound out)
**--------------------------------------------------------------------------*/
function SpicePlaybackConn(){SpiceConn.apply(this,arguments),this.queue=new Array,this.append_okay=!1,this.start_time=0}function handle_source_open(e){var t=this.spiceconn;t.source_buffer||(t.source_buffer=this.addSourceBuffer(SPICE_PLAYBACK_CODEC),t.source_buffer?(0<PLAYBACK_DEBUG&&playback_handle_event_debug.call(this,e),listen_for_audio_events(t),(t.source_buffer.spiceconn=t).source_buffer.mode="segments"):t.log_err("Codec "+SPICE_PLAYBACK_CODEC+" not available."))}function handle_source_ended(e){this.spiceconn.log_err("Audio source unexpectedly ended.")}function handle_source_closed(e){this.spiceconn.log_err("Audio source unexpectedly closed.")}function condense_playback_queue(e){if(1==e.length)return e.shift();var t=0,i=0;for(i=0;i<e.length;i++)t+=e[i].byteLength;var s=new ArrayBuffer(t),r=new Uint8Array(s);for(i=t=0;i<e.length;i++)r.set(new Uint8Array(e[i]),t),t+=e[i].byteLength;return e.length=0,s}function handle_append_buffer_done(e){var t=this.spiceconn;(1<PLAYBACK_DEBUG&&playback_handle_event_debug.call(this,e),0<t.queue.length)?playback_append_buffer(t,condense_playback_queue(t.queue)):t.append_okay=!0}function handle_sourcebuffer_error(e){this.spiceconn.log_err("source_buffer error "+e.message)}function playback_append_buffer(t,e){try{t.source_buffer.appendBuffer(e),t.append_okay=!1}catch(e){t.log_err("Error invoking appendBuffer: "+e.message)}}function playback_handle_event_debug(e){var t=this.spiceconn;t.audio&&(0<PLAYBACK_DEBUG||1<t.audio.buffered.len)&&console.log(t.audio.currentTime+": event "+e.type+dump_media_element(t.audio)),1<PLAYBACK_DEBUG&&t.media_source&&console.log("  media_source "+dump_media_source(t.media_source)),1<PLAYBACK_DEBUG&&t.source_buffer&&console.log("  source_buffer "+dump_source_buffer(t.source_buffer)),(0<PLAYBACK_DEBUG||1<t.queue.length)&&console.log("  queue len "+t.queue.length+"; append_okay: "+t.append_okay)}function playback_debug_listen_for_one_event(e){this.addEventListener(e,playback_handle_event_debug)}function listen_for_audio_events(e){["abort","error"].forEach(playback_debug_listen_for_one_event,e.audio),0<PLAYBACK_DEBUG&&["loadstart","suspend","emptied","stalled","loadedmetadata","loadeddata","canplay","canplaythrough","playing","waiting","seeking","seeked","ended","durationchange","timeupdate","play","pause","ratechange"].forEach(playback_debug_listen_for_one_event,e.audio),1<PLAYBACK_DEBUG&&["progress","resize","volumechange"].forEach(playback_debug_listen_for_one_event,e.audio)}EBMLHeader.prototype={to_buffer:function(e,t){t=t||0;var i=new DataView(e);return t=EBML_write_u64_data_len(31,i,t=EBML_write_array(this.id,i,t)),t=EBML_write_u8_value(EBML_HEADER_VERSION,this.Version,i,t),t=EBML_write_u8_value(EBML_HEADER_READ_VERSION,this.ReadVersion,i,t),t=EBML_write_u8_value(EBML_HEADER_MAX_ID_LENGTH,this.MaxIDLength,i,t),t=EBML_write_u8_value(EBML_HEADER_MAX_SIZE_LENGTH,this.MaxSizeLength,i,t),t=EBML_write_data(EBML_HEADER_DOC_TYPE,this.DocType,i,t),t=EBML_write_u8_value(EBML_HEADER_DOC_TYPE_VERSION,this.DocTypeVersion,i,t),t=EBML_write_u8_value(EBML_HEADER_DOC_TYPE_READ_VERSION,this.DocTypeReadVersion,i,t)},buffer_size:function(){return 39+this.id.length}},webm_Segment.prototype={to_buffer:function(e,t){t=t||0;var i=new DataView(e);return t=EBML_write_array(this.id,i,t),i.setUint8(t++,255),t},buffer_size:function(){return this.id.length+1}},webm_SegmentInformation.prototype={to_buffer:function(e,t){t=t||0;var i=new DataView(e);return t=EBML_write_array(this.id,i,t),t=EBML_write_u64_data_len(this.buffer_size()-8-this.id.length,i,t),t=EBML_write_u32_value(WEBM_TIMECODE_SCALE,this.timecode_scale,i,t),t=EBML_write_data(WEBM_MUXING_APP,this.muxing_app,i,t),t=EBML_write_data(WEBM_WRITING_APP,this.writing_app,i,t)},buffer_size:function(){return this.id.length+8+WEBM_TIMECODE_SCALE.length+1+4+WEBM_MUXING_APP.length+1+this.muxing_app.length+WEBM_WRITING_APP.length+1+this.writing_app.length}},webm_Audio.prototype={to_buffer:function(e,t){t=t||0;var i=new DataView(e);return t=EBML_write_array(this.id,i,t),t=EBML_write_u64_data_len(this.buffer_size()-8-this.id.length,i,t),t=EBML_write_u8_value(WEBM_CHANNELS,this.channels,i,t),t=EBML_write_float_value(WEBM_SAMPLING_FREQUENCY,this.sampling_frequency,i,t)},buffer_size:function(){return this.id.length+8+WEBM_SAMPLING_FREQUENCY.length+1+4+WEBM_CHANNELS.length+1+1}},webm_Video.prototype={to_buffer:function(e,t){t=t||0;var i=new DataView(e);return t=EBML_write_array(this.id,i,t),t=EBML_write_u64_data_len(this.buffer_size()-8-this.id.length,i,t),t=EBML_write_u16_value(WEBM_PIXEL_WIDTH,this.width,i,t),t=EBML_write_u16_value(WEBM_PIXEL_HEIGHT,this.height,i,t)},buffer_size:function(){return this.id.length+8+WEBM_PIXEL_WIDTH.length+1+2+WEBM_PIXEL_HEIGHT.length+1+2}},webm_Seek.prototype={to_buffer:function(e,t){t=t||0;var i=new DataView(e);return t=EBML_write_array(this.id,i,t),t=EBML_write_u1_data_len(this.buffer_size()-1-this.id.length,i,t),t=EBML_write_data(WEBM_SEEK_ID,this.seekid,i,t),t=EBML_write_u16_value(WEBM_SEEK_POSITION,this.pos,i,t)},buffer_size:function(){return this.id.length+1+WEBM_SEEK_ID.length+1+this.seekid.length+WEBM_SEEK_POSITION.length+1+2}},webm_SeekHead.prototype={to_buffer:function(e,t){t=t||0;var i=new DataView(e);return t=EBML_write_array(this.id,i,t),t=EBML_write_u64_data_len(this.buffer_size()-8-this.id.length,i,t),t=this.info.to_buffer(e,t),t=this.track.to_buffer(e,t)},buffer_size:function(){return this.id.length+8+this.info.buffer_size()+this.track.buffer_size()}},webm_AudioTrackEntry.prototype={to_buffer:function(e,t){t=t||0;var i=new DataView(e);return t=EBML_write_array(this.id,i,t),t=EBML_write_u64_data_len(this.buffer_size()-8-this.id.length,i,t),t=EBML_write_u8_value(WEBM_TRACK_NUMBER,this.number,i,t),t=EBML_write_u8_value(WEBM_TRACK_UID,this.uid,i,t),t=EBML_write_u8_value(WEBM_FLAG_ENABLED,this.flag_enabled,i,t),t=EBML_write_u8_value(WEBM_FLAG_DEFAULT,this.flag_default,i,t),t=EBML_write_u8_value(WEBM_FLAG_FORCED,this.flag_forced,i,t),t=EBML_write_u8_value(WEBM_FLAG_LACING,this.flag_lacing,i,t),t=EBML_write_data(WEBM_CODEC_ID,this.codec_id,i,t),t=EBML_write_u8_value(WEBM_MIN_CACHE,this.min_cache,i,t),t=EBML_write_u8_value(WEBM_MAX_BLOCK_ADDITION_ID,this.max_block_addition_id,i,t),t=EBML_write_u8_value(WEBM_CODEC_DECODE_ALL,this.codec_decode_all,i,t),t=EBML_write_u32_value(WEBM_CODEC_DELAY,this.codec_delay,i,t),t=EBML_write_u32_value(WEBM_SEEK_PRE_ROLL,this.seek_pre_roll,i,t),t=EBML_write_u8_value(WEBM_TRACK_TYPE,this.type,i,t),t=EBML_write_data(WEBM_CODEC_PRIVATE,this.codec_private,i,t),t=this.audio.to_buffer(e,t)},buffer_size:function(){return this.id.length+8+WEBM_TRACK_NUMBER.length+1+1+WEBM_TRACK_UID.length+1+1+WEBM_TRACK_TYPE.length+1+1+WEBM_FLAG_ENABLED.length+1+1+WEBM_FLAG_DEFAULT.length+1+1+WEBM_FLAG_FORCED.length+1+1+WEBM_FLAG_LACING.length+1+1+WEBM_MIN_CACHE.length+1+1+WEBM_MAX_BLOCK_ADDITION_ID.length+1+1+WEBM_CODEC_DECODE_ALL.length+1+1+WEBM_SEEK_PRE_ROLL.length+1+4+WEBM_CODEC_DELAY.length+1+4+WEBM_CODEC_ID.length+this.codec_id.length+1+WEBM_CODEC_PRIVATE.length+1+this.codec_private.length+this.audio.buffer_size()}},webm_VideoTrackEntry.prototype={to_buffer:function(e,t){t=t||0;var i=new DataView(e);return t=EBML_write_array(this.id,i,t),t=EBML_write_u64_data_len(this.buffer_size()-8-this.id.length,i,t),t=EBML_write_u8_value(WEBM_TRACK_NUMBER,this.number,i,t),t=EBML_write_u8_value(WEBM_TRACK_UID,this.uid,i,t),t=EBML_write_u8_value(WEBM_FLAG_ENABLED,this.flag_enabled,i,t),t=EBML_write_u8_value(WEBM_FLAG_DEFAULT,this.flag_default,i,t),t=EBML_write_u8_value(WEBM_FLAG_FORCED,this.flag_forced,i,t),t=EBML_write_u8_value(WEBM_FLAG_LACING,this.flag_lacing,i,t),t=EBML_write_data(WEBM_CODEC_ID,this.codec_id,i,t),t=EBML_write_u8_value(WEBM_MIN_CACHE,this.min_cache,i,t),t=EBML_write_u8_value(WEBM_MAX_BLOCK_ADDITION_ID,this.max_block_addition_id,i,t),t=EBML_write_u8_value(WEBM_CODEC_DECODE_ALL,this.codec_decode_all,i,t),t=EBML_write_u32_value(WEBM_CODEC_DELAY,this.codec_delay,i,t),t=EBML_write_u32_value(WEBM_SEEK_PRE_ROLL,this.seek_pre_roll,i,t),t=EBML_write_u8_value(WEBM_TRACK_TYPE,this.type,i,t),t=this.video.to_buffer(e,t)},buffer_size:function(){return this.id.length+8+WEBM_TRACK_NUMBER.length+1+1+WEBM_TRACK_UID.length+1+1+WEBM_FLAG_ENABLED.length+1+1+WEBM_FLAG_DEFAULT.length+1+1+WEBM_FLAG_FORCED.length+1+1+WEBM_FLAG_LACING.length+1+1+WEBM_CODEC_ID.length+this.codec_id.length+1+WEBM_MIN_CACHE.length+1+1+WEBM_MAX_BLOCK_ADDITION_ID.length+1+1+WEBM_CODEC_DECODE_ALL.length+1+1+WEBM_CODEC_DELAY.length+1+4+WEBM_SEEK_PRE_ROLL.length+1+4+WEBM_TRACK_TYPE.length+1+1+this.video.buffer_size()}},webm_Tracks.prototype={to_buffer:function(e,t){t=t||0;var i=new DataView(e);return t=EBML_write_array(this.id,i,t),t=EBML_write_u64_data_len(this.buffer_size()-8-this.id.length,i,t),t=this.track_entry.to_buffer(e,t)},buffer_size:function(){return this.id.length+8+this.track_entry.buffer_size()}},webm_Cluster.prototype={to_buffer:function(e,t){t=t||0;var i=new DataView(e);return t=EBML_write_array(this.id,i,t),i.setUint8(t++,255),t=EBML_write_u32_value(WEBM_TIME_CODE,this.timecode,i,t)},buffer_size:function(){return this.id.length+1+WEBM_TIME_CODE.length+1+4}},webm_SimpleBlock.prototype={to_buffer:function(e,t){t=t||0;var i=new DataView(e);t=EBML_write_array(this.id,i,t),t=EBML_write_u1_data_len(1,i,t=EBML_write_u64_data_len(this.data.byteLength+4,i,t)),// Track #
i.setUint16(t,this.timecode),t+=2,// timecode - relative to cluster
i.setUint8(t,this.keyframe?CLUSTER_SIMPLEBLOCK_FLAG_KEYFRAME:0),t+=1;for(// flags
// FIXME - There should be a better way to copy
var s=new Uint8Array(this.data),r=0;r<this.data.byteLength;r++)i.setUint8(t++,s[r]);return t},buffer_size:function(){return this.id.length+8+1+2+1+this.data.byteLength}},webm_Header.prototype={to_buffer:function(e,t){return t=t||0,t=this.ebml.to_buffer(e,t),t=this.segment.to_buffer(e,t),t=this.info.to_buffer(e,t)},buffer_size:function(){return this.ebml.buffer_size()+this.segment.buffer_size()+this.info.buffer_size()}},SpicePlaybackConn.prototype=Object.create(SpiceConn.prototype),SpicePlaybackConn.prototype.process_channel_message=function(e){if(!window.MediaSource)return this.log_err("MediaSource API is not available"),!1;if(e.type==SPICE_MSG_PLAYBACK_START){var t=new SpiceMsgPlaybackStart(e.data);if(0<PLAYBACK_DEBUG&&console.log("PlaybackStart; frequency "+t.frequency),t.frequency!=OPUS_FREQUENCY)return this.log_err("This player cannot handle frequency "+t.frequency),!1;if(t.channels!=OPUS_CHANNELS)return this.log_err("This player cannot handle "+t.channels+" channels"),!1;if(t.format!=SPICE_AUDIO_FMT_S16)return this.log_err("This player cannot format "+t.format),!1;if(!this.source_buffer)return this.media_source=new MediaSource,(this.media_source.spiceconn=this).audio=document.createElement("audio"),(this.audio.spiceconn=this).audio.setAttribute("autoplay",!0),this.audio.src=window.URL.createObjectURL(this.media_source),document.getElementById(this.parent.screen_id).appendChild(this.audio),this.media_source.addEventListener("sourceopen",handle_source_open,!1),this.media_source.addEventListener("sourceended",handle_source_ended,!1),this.media_source.addEventListener("sourceclosed",handle_source_closed,!1),!(this.bytes_written=0)}if(e.type==SPICE_MSG_PLAYBACK_DATA){var i=new SpiceMsgPlaybackData(e.data);return this.source_buffer&&(3<=this.audio.readyState&&1<this.audio.buffered.length&&this.audio.currentTime==this.audio.buffered.end(0)&&this.audio.currentTime<this.audio.buffered.start(this.audio.buffered.length-1)&&(console.log("Audio underrun: we appear to have fallen behind; advancing to "+this.audio.buffered.start(this.audio.buffered.length-1)),this.audio.currentTime=this.audio.buffered.start(this.audio.buffered.length-1))
/* Around version 45, Firefox started being very particular about the
           time stamps put into the Opus stream.  The time stamps from the Spice server are
           somewhat irregular.  They mostly arrive every 10 ms, but sometimes it is 11, or sometimes
           with two time stamps the same in a row.  The previous logic resulted in fuzzy and/or
           distorted audio streams in Firefox in a row.

           In theory, the sequence mode should be appropriate for us, but as of 09/27/2016,
           I was unable to make sequence mode work with Firefox.

           Thus, we end up with an inelegant hack.  Essentially, we force every packet to have
           a 10ms time delta, unless there is an obvious gap in time stream, in which case we
           will resync.
        */,0!=this.start_time&&i.time!=this.last_data_time+EXPECTED_PACKET_DURATION&&(Math.abs(i.time-(EXPECTED_PACKET_DURATION+this.last_data_time))<MAX_CLUSTER_TIME?(1<PLAYBACK_DEBUG&&console.log("Hacking time of "+i.time+" to "+(this.last_data_time+EXPECTED_PACKET_DURATION)),i.time=this.last_data_time+EXPECTED_PACKET_DURATION):1<PLAYBACK_DEBUG&&console.log("Apparent gap in audio time; now is "+i.time+" last was "+this.last_data_time)),this.last_data_time=i.time,1<PLAYBACK_DEBUG&&console.log("PlaybackData; time "+i.time+"; length "+i.data.byteLength),0==this.start_time?this.start_playback(i):i.time-this.cluster_time>=MAX_CLUSTER_TIME?this.new_cluster(i):this.simple_block(i,!1)),!0}if(e.type!=SPICE_MSG_PLAYBACK_MODE)return e.type==SPICE_MSG_PLAYBACK_STOP&&(0<PLAYBACK_DEBUG&&console.log("PlaybackStop"),this.source_buffer)?(document.getElementById(this.parent.screen_id).removeChild(this.audio),window.URL.revokeObjectURL(this.audio.src),delete this.source_buffer,delete this.media_source,delete this.audio,this.append_okay=!1,this.queue=new Array,!(this.start_time=0)):e.type==SPICE_MSG_PLAYBACK_VOLUME?(this.known_unimplemented(e.type,"Playback Volume"),!0):e.type==SPICE_MSG_PLAYBACK_MUTE?(this.known_unimplemented(e.type,"Playback Mute"),!0):e.type==SPICE_MSG_PLAYBACK_LATENCY&&(this.known_unimplemented(e.type,"Playback Latency"),!0);var s=new SpiceMsgPlaybackMode(e.data);return s.mode!=SPICE_AUDIO_DATA_MODE_OPUS&&(this.log_err("This player cannot handle mode "+s.mode),delete this.source_buffer),!0},SpicePlaybackConn.prototype.start_playback=function(e){this.start_time=e.time;var t=new webm_Header,i=new webm_Tracks(new webm_AudioTrackEntry),s=new ArrayBuffer(t.buffer_size()+i.buffer_size());this.bytes_written=t.to_buffer(s),this.bytes_written=i.to_buffer(s,this.bytes_written),this.source_buffer.addEventListener("error",handle_sourcebuffer_error,!1),this.source_buffer.addEventListener("updateend",handle_append_buffer_done,!1),playback_append_buffer(this,s),this.new_cluster(e)},SpicePlaybackConn.prototype.new_cluster=function(e){this.cluster_time=e.time;var t=new webm_Cluster(e.time-this.start_time),i=new ArrayBuffer(t.buffer_size());this.bytes_written+=t.to_buffer(i),this.append_okay?playback_append_buffer(this,i):this.queue.push(i),this.simple_block(e,!0)},SpicePlaybackConn.prototype.simple_block=function(e,t){var i=new webm_SimpleBlock(e.time-this.cluster_time,e.data,t),s=new ArrayBuffer(i.buffer_size());this.bytes_written+=i.to_buffer(s),this.append_okay?playback_append_buffer(this,s):this.queue.push(s)};
/*
   Copyright (C) 2013 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  SpiceSimulateCursor
**      Internet Explorer 10 does not support data uri's in cursor assignment.
**  This file provides a number of gimmicks to compensate.  First, if there
**  is a preloaded cursor available, we will use that.  Failing that, we will
**  simulate a cursor using an image that is moved around the screen.
**--------------------------------------------------------------------------*/
var dbits,SpiceSimulateCursor={cursors:new Array,unknown_cursors:new Array,warned:!1,add_cursor:function(e,t){SpiceSimulateCursor.cursors[e]=t},unknown_cursor:function(e,t){SpiceSimulateCursor.warned||(SpiceSimulateCursor.warned=!0,alert("Internet Explorer does not support dynamic cursors.  This page will now simulate cursors with images, which will be imperfect.  We recommend using Chrome or Firefox instead.  \n\nIf you need to use Internet Explorer, you can create a static cursor file for each cursor your application uses.  View the console log for more information on creating static cursors for your environment.")),SpiceSimulateCursor.unknown_cursors[e]||(SpiceSimulateCursor.unknown_cursors[e]=t,console.log("Unknown cursor.  Simulation required.  To avoid simulation for this cursor, create and include a custom javascript file, and add the following line:"),console.log('SpiceCursorSimulator.add_cursor("'+e+'"), "<your filename here>.cur");'),console.log("And then run following command, redirecting output into <your filename here>.cur:"),console.log("php -r \"echo urldecode('"+t+"');\""))},simulate_cursor:function(e,t,i,s){var r=hex_sha1(s+" "+t.header.hot_spot_x+" "+t.header.hot_spot_y);if(void 0!==SpiceSimulateCursor.cursors&&void 0!==SpiceSimulateCursor.cursors[r]){var _="url("+SpiceSimulateCursor.cursors[r]+"), default";i.style.cursor=_}"auto"==window.getComputedStyle(i,null).cursor?(SpiceSimulateCursor.unknown_cursor(r,SpiceSimulateCursor.create_icondir(t.header.width,t.header.height,t.data.byteLength,t.header.hot_spot_x,t.header.hot_spot_y)+s),document.getElementById(e.parent.screen_id).style.cursor="none",e.spice_simulated_cursor||(e.spice_simulated_cursor=document.createElement("img"),e.spice_simulated_cursor.style.position="absolute",e.spice_simulated_cursor.style.display="none",e.spice_simulated_cursor.style.overflow="hidden",e.spice_simulated_cursor.spice_screen=document.getElementById(e.parent.screen_id),e.spice_simulated_cursor.addEventListener("mousemove",SpiceSimulateCursor.handle_sim_mousemove),e.spice_simulated_cursor.spice_screen.appendChild(e.spice_simulated_cursor)),e.spice_simulated_cursor.src="data:image/png,"+s,e.spice_simulated_cursor.spice_hot_x=t.header.hot_spot_x,e.spice_simulated_cursor.spice_hot_y=t.header.hot_spot_y,e.spice_simulated_cursor.style.pointerEvents="none"):e.spice_simulated_cursor&&(e.spice_simulated_cursor.spice_screen.removeChild(e.spice_simulated_cursor),delete e.spice_simulated_cursor)},handle_sim_mousemove:function(e){var t=SpiceSimulateCursor.duplicate_mouse_event(e,this.spice_screen);return this.spice_screen.dispatchEvent(t)},duplicate_mouse_event:function(e,t){var i=document.createEvent("mouseevent");return i.initMouseEvent(e.type,!0,!0,e.view,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,e.relatedTarget),i},ICONDIR:function(){},ICONDIRENTRY:function(e,t,i,s,r){this.width=e,this.height=t,this.bytes=i,this.hot_x=s,this.hot_y=r},create_icondir:function(e,t,i,s,r){var _,n=new SpiceSimulateCursor.ICONDIR,a=new SpiceSimulateCursor.ICONDIRENTRY(e,t,i,s,r),o=new ArrayBuffer(n.buffer_size()+a.buffer_size()),c=n.to_buffer(o);c=a.to_buffer(o,c);var h=new Uint8Array(o),p="";for(_=0;_<c;_++)p+="%",h[_]<16&&(p+="0"),p+=h[_].toString(16);return p}};
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  SpiceCursorConn
**      Drive the Spice Cursor Channel
**--------------------------------------------------------------------------*/
function SpiceCursorConn(){SpiceConn.apply(this,arguments)}SpiceSimulateCursor.ICONDIR.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);return i.setUint16(t,0,!0),t+=2,i.setUint16(t,2,!0),t+=2,i.setUint16(t,1,!0),t+=2},buffer_size:function(){return 6}},SpiceSimulateCursor.ICONDIRENTRY.prototype={to_buffer:function(e,t){t=t||0;var i=new SpiceDataView(e);/* Offset to bytes */
return i.setUint8(t,this.width),t++,i.setUint8(t,this.height),t++,i.setUint8(t,0),t++,/* color palette count, unused */
i.setUint8(t,0),t++,/* reserved */
i.setUint16(t,this.hot_x,!0),t+=2,i.setUint16(t,this.hot_y,!0),t+=2,i.setUint32(t,this.bytes,!0),t+=4,i.setUint32(t,t+4,!0),t+=4},buffer_size:function(){return 16}},SpiceCursorConn.prototype=Object.create(SpiceConn.prototype),SpiceCursorConn.prototype.process_channel_message=function(e){if(e.type==SPICE_MSG_CURSOR_INIT){var t=new SpiceMsgCursorInit(e.data);
// FIXME - We don't handle most of the parameters here...
return 1<DEBUG&&console.log("SpiceMsgCursorInit"),this.parent&&this.parent.inputs&&this.parent.inputs.mouse_mode==SPICE_MOUSE_MODE_SERVER&&(
// FIXME - this imagines that the server actually
//          provides the current cursor position,
//          instead of 0,0.  As of May 11, 2012,
//          that assumption was false :-(.
this.parent.inputs.mousex=t.position.x,this.parent.inputs.mousey=t.position.y),!0}if(e.type!=SPICE_MSG_CURSOR_SET)return e.type==SPICE_MSG_CURSOR_MOVE?(this.known_unimplemented(e.type,"Cursor Move"),!0):e.type==SPICE_MSG_CURSOR_HIDE?(1<DEBUG&&console.log("SpiceMsgCursorHide"),document.getElementById(this.parent.screen_id).style.cursor="none",!0):e.type==SPICE_MSG_CURSOR_TRAIL?(this.known_unimplemented(e.type,"Cursor Trail"),!0):e.type==SPICE_MSG_CURSOR_RESET?(1<DEBUG&&console.log("SpiceMsgCursorReset"),document.getElementById(this.parent.screen_id).style.cursor="auto",!0):e.type==SPICE_MSG_CURSOR_INVAL_ONE?(this.known_unimplemented(e.type,"Cursor Inval One"),!0):e.type==SPICE_MSG_CURSOR_INVAL_ALL&&(1<DEBUG&&console.log("SpiceMsgCursorInvalAll"),!0);var i=new SpiceMsgCursorSet(e.data);return 1<DEBUG&&console.log("SpiceMsgCursorSet"),i.flags&SPICE_CURSOR_FLAGS_NONE?(document.getElementById(this.parent.screen_id).style.cursor="none",!0):(0<i.flags&&this.log_warn("FIXME: No support for cursor flags "+i.flags),i.cursor.header.type!=SPICE_CURSOR_TYPE_ALPHA?(this.log_warn("FIXME: No support for cursor type "+i.cursor.header.type),!1):(this.set_cursor(i.cursor),!0))},SpiceCursorConn.prototype.set_cursor=function(e){var t=create_rgba_png(e.header.height,e.header.width,e.data),i="url(data:image/png,"+t+") "+e.header.hot_spot_x+" "+e.header.hot_spot_y+", default",s=document.getElementById(this.parent.screen_id);s.style.cursor="auto",s.style.cursor=i,"auto"==window.getComputedStyle(s,null).cursor&&SpiceSimulateCursor.simulate_cursor(this,e,s,t)};
// JavaScript engine analysis
var canary=0xdeadbeefcafe,j_lm=15715070==(16777215&canary);
// (public) Constructor
function BigInteger(e,t,i){null!=e&&("number"==typeof e?this.fromNumber(e,t,i):null==t&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}
// return new, unset BigInteger
function nbi(){return new BigInteger(null)}
// am: Compute w_j += (x*this_i), propagate carries,
// c is initial carry, returns final carry.
// c < 3*dvalue, x < 2*dvalue, this_i < dvalue
// We need to select the fastest one that works in this environment.
// am1: use a single mult and divide to get the high bits,
// max digit bits should be 26 because
// max internal value = 2*dvalue^2-2*dvalue (< 2^53)
function am1(e,t,i,s,r,_){for(;0<=--_;){var n=t*this[e++]+i[s]+r;r=Math.floor(n/67108864),i[s++]=67108863&n}return r}
// am2 avoids a big mult-and-extract completely.
// Max digit bits should be <= 30 because we do bitwise ops
// on values up to 2*hdvalue^2-hdvalue-1 (< 2^31)
function am2(e,t,i,s,r,_){for(var n=32767&t,a=t>>15;0<=--_;){var o=32767&this[e],c=this[e++]>>15,h=a*o+c*n;r=((o=n*o+((32767&h)<<15)+i[s]+(1073741823&r))>>>30)+(h>>>15)+a*c+(r>>>30),i[s++]=1073741823&o}return r}
// Alternately, set max digit bits to 28 since some
// browsers slow down when dealing with 32-bit numbers.
function am3(e,t,i,s,r,_){for(var n=16383&t,a=t>>14;0<=--_;){var o=16383&this[e],c=this[e++]>>14,h=a*o+c*n;r=((o=n*o+((16383&h)<<14)+i[s]+r)>>28)+(h>>14)+a*c,i[s++]=268435455&o}return r}dbits=j_lm&&"Microsoft Internet Explorer"==navigator.appName?(BigInteger.prototype.am=am2,30):j_lm&&"Netscape"!=navigator.appName?(BigInteger.prototype.am=am1,26):(// Mozilla/Netscape seems to prefer am3
BigInteger.prototype.am=am3,28),BigInteger.prototype.DB=dbits,BigInteger.prototype.DM=(1<<dbits)-1,BigInteger.prototype.DV=1<<dbits;var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP),BigInteger.prototype.F1=BI_FP-dbits,BigInteger.prototype.F2=2*dbits-BI_FP;
// Digit conversions
var rr,vv,BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=new Array;for(rr="0".charCodeAt(0),vv=0;vv<=9;++vv)BI_RC[rr++]=vv;for(rr="a".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr++]=vv;for(rr="A".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr++]=vv;function int2char(e){return BI_RM.charAt(e)}function intAt(e,t){var i=BI_RC[e.charCodeAt(t)];return null==i?-1:i}
// (protected) copy this to r
function bnpCopyTo(e){for(var t=this.t-1;0<=t;--t)e[t]=this[t];e.t=this.t,e.s=this.s}
// (protected) set from integer value x, -DV <= x < DV
function bnpFromInt(e){this.t=1,this.s=e<0?-1:0,0<e?this[0]=e:e<-1?this[0]=e+DV:this.t=0}
// return bigint initialized to value
function nbv(e){var t=nbi();return t.fromInt(e),t}
// (protected) set from string and radix
function bnpFromString(e,t){var i;if(16==t)i=4;else if(8==t)i=3;else if(256==t)i=8;// byte array
else if(2==t)i=1;else if(32==t)i=5;else{if(4!=t)return void this.fromRadix(e,t);i=2}this.t=0,this.s=0;for(var s=e.length,r=!1,_=0;0<=--s;){var n=8==i?255&e[s]:intAt(e,s);n<0?"-"==e.charAt(s)&&(r=!0):(r=!1,0==_?this[this.t++]=n:_+i>this.DB?(this[this.t-1]|=(n&(1<<this.DB-_)-1)<<_,this[this.t++]=n>>this.DB-_):this[this.t-1]|=n<<_,(_+=i)>=this.DB&&(_-=this.DB))}8==i&&0!=(128&e[0])&&(this.s=-1,0<_&&(this[this.t-1]|=(1<<this.DB-_)-1<<_)),this.clamp(),r&&BigInteger.ZERO.subTo(this,this)}
// (protected) clamp off excess high words
function bnpClamp(){for(var e=this.s&this.DM;0<this.t&&this[this.t-1]==e;)--this.t}
// (public) return string representation in given radix
function bnToString(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(16==e)t=4;else if(8==e)t=3;else if(2==e)t=1;else if(32==e)t=5;else{if(4!=e)return this.toRadix(e);t=2}var i,s=(1<<t)-1,r=!1,_="",n=this.t,a=this.DB-n*this.DB%t;if(0<n--)for(a<this.DB&&0<(i=this[n]>>a)&&(r=!0,_=int2char(i));0<=n;)a<t?(i=(this[n]&(1<<a)-1)<<t-a,i|=this[--n]>>(a+=this.DB-t)):(i=this[n]>>(a-=t)&s,a<=0&&(a+=this.DB,--n)),0<i&&(r=!0),r&&(_+=int2char(i));return r?_:"0"}
// (public) -this
function bnNegate(){var e=nbi();return BigInteger.ZERO.subTo(this,e),e}
// (public) |this|
function bnAbs(){return this.s<0?this.negate():this}
// (public) return + if this > a, - if this < a, 0 if equal
function bnCompareTo(e){var t=this.s-e.s;if(0!=t)return t;var i=this.t;if(0!=(t=i-e.t))return t;for(;0<=--i;)if(0!=(t=this[i]-e[i]))return t;return 0}
// returns bit length of the integer x
function nbits(e){var t,i=1;return 0!=(t=e>>>16)&&(e=t,i+=16),0!=(t=e>>8)&&(e=t,i+=8),0!=(t=e>>4)&&(e=t,i+=4),0!=(t=e>>2)&&(e=t,i+=2),0!=(t=e>>1)&&(e=t,i+=1),i}
// (public) return the number of bits in "this"
function bnBitLength(){return this.t<=0?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)}
// (protected) r = this << n*DB
function bnpDLShiftTo(e,t){var i;for(i=this.t-1;0<=i;--i)t[i+e]=this[i];for(i=e-1;0<=i;--i)t[i]=0;t.t=this.t+e,t.s=this.s}
// (protected) r = this >> n*DB
function bnpDRShiftTo(e,t){for(var i=e;i<this.t;++i)t[i-e]=this[i];t.t=Math.max(this.t-e,0),t.s=this.s}
// (protected) r = this << n
function bnpLShiftTo(e,t){var i,s=e%this.DB,r=this.DB-s,_=(1<<r)-1,n=Math.floor(e/this.DB),a=this.s<<s&this.DM;for(i=this.t-1;0<=i;--i)t[i+n+1]=this[i]>>r|a,a=(this[i]&_)<<s;for(i=n-1;0<=i;--i)t[i]=0;t[n]=a,t.t=this.t+n+1,t.s=this.s,t.clamp()}
// (protected) r = this >> n
function bnpRShiftTo(e,t){t.s=this.s;var i=Math.floor(e/this.DB);if(i>=this.t)t.t=0;else{var s=e%this.DB,r=this.DB-s,_=(1<<s)-1;t[0]=this[i]>>s;for(var n=i+1;n<this.t;++n)t[n-i-1]|=(this[n]&_)<<r,t[n-i]=this[n]>>s;0<s&&(t[this.t-i-1]|=(this.s&_)<<r),t.t=this.t-i,t.clamp()}}
// (protected) r = this - a
function bnpSubTo(e,t){for(var i=0,s=0,r=Math.min(e.t,this.t);i<r;)s+=this[i]-e[i],t[i++]=s&this.DM,s>>=this.DB;if(e.t<this.t){for(s-=e.s;i<this.t;)s+=this[i],t[i++]=s&this.DM,s>>=this.DB;s+=this.s}else{for(s+=this.s;i<e.t;)s-=e[i],t[i++]=s&this.DM,s>>=this.DB;s-=e.s}t.s=s<0?-1:0,s<-1?t[i++]=this.DV+s:0<s&&(t[i++]=s),t.t=i,t.clamp()}
// (protected) r = this * a, r != this,a (HAC 14.12)
// "this" should be the larger one if appropriate.
function bnpMultiplyTo(e,t){var i=this.abs(),s=e.abs(),r=i.t;for(t.t=r+s.t;0<=--r;)t[r]=0;for(r=0;r<s.t;++r)t[r+i.t]=i.am(0,s[r],t,r,0,i.t);t.s=0,t.clamp(),this.s!=e.s&&BigInteger.ZERO.subTo(t,t)}
// (protected) r = this^2, r != this (HAC 14.16)
function bnpSquareTo(e){for(var t=this.abs(),i=e.t=2*t.t;0<=--i;)e[i]=0;for(i=0;i<t.t-1;++i){var s=t.am(i,t[i],e,2*i,0,1);(e[i+t.t]+=t.am(i+1,2*t[i],e,2*i+1,s,t.t-i-1))>=t.DV&&(e[i+t.t]-=t.DV,e[i+t.t+1]=1)}0<e.t&&(e[e.t-1]+=t.am(i,t[i],e,2*i,0,1)),e.s=0,e.clamp()}
// (protected) divide this by m, quotient and remainder to q, r (HAC 14.20)
// r != q, this != m.  q or r may be null.
function bnpDivRemTo(e,t,i){var s=e.abs();if(!(s.t<=0)){var r=this.abs();if(r.t<s.t)return null!=t&&t.fromInt(0),void(null!=i&&this.copyTo(i));null==i&&(i=nbi());var _=nbi(),n=this.s,a=e.s,o=this.DB-nbits(s[s.t-1]);// normalize modulus
0<o?(s.lShiftTo(o,_),r.lShiftTo(o,i)):(s.copyTo(_),r.copyTo(i));var c=_.t,h=_[c-1];if(0!=h){var p=h*(1<<this.F1)+(1<c?_[c-2]>>this.F2:0),u=this.FV/p,d=(1<<this.F1)/p,l=1<<this.F2,f=i.t,E=f-c,m=null==t?nbi():t;// "negative" y so we can replace sub with am later
for(_.dlShiftTo(E,m),0<=i.compareTo(m)&&(i[i.t++]=1,i.subTo(m,i)),BigInteger.ONE.dlShiftTo(c,m),m.subTo(_,_);_.t<c;)_[_.t++]=0;for(;0<=--E;){
// Estimate quotient digit
var S=i[--f]==h?this.DM:Math.floor(i[f]*u+(i[f-1]+l)*d);if((i[f]+=_.am(0,S,i,E,0,c))<S)for(// Try it out
_.dlShiftTo(E,m),i.subTo(m,i);i[f]<--S;)i.subTo(m,i)}null!=t&&(i.drShiftTo(c,t),n!=a&&BigInteger.ZERO.subTo(t,t)),i.t=c,i.clamp(),0<o&&i.rShiftTo(o,i),// Denormalize remainder
n<0&&BigInteger.ZERO.subTo(i,i)}}}
// (public) this mod a
function bnMod(e){var t=nbi();return this.abs().divRemTo(e,null,t),this.s<0&&0<t.compareTo(BigInteger.ZERO)&&e.subTo(t,t),t}
// Modular reduction using "classic" algorithm
function Classic(e){this.m=e}function cConvert(e){return e.s<0||0<=e.compareTo(this.m)?e.mod(this.m):e}function cRevert(e){return e}function cReduce(e){e.divRemTo(this.m,null,e)}function cMulTo(e,t,i){e.multiplyTo(t,i),this.reduce(i)}function cSqrTo(e,t){e.squareTo(t),this.reduce(t)}
// (protected) return "-1/this % 2^DB"; useful for Mont. reduction
// justification:
//         xy == 1 (mod m)
//         xy =  1+km
//   xy(2-xy) = (1+km)(1-km)
// x[y(2-xy)] = 1-k^2m^2
// x[y(2-xy)] == 1 (mod m^2)
// if y is 1/x mod m, then y(2-xy) is 1/x mod m^2
// should reduce x and y(2-xy) by m^2 at each step to keep size bounded.
// JS multiply "overflows" differently from C/C++, so care is needed here.
function bnpInvDigit(){if(this.t<1)return 0;var e=this[0];if(0==(1&e))return 0;var t=3&e;// y == 1/x mod 2^2
// y == 1/x mod 2^dbits
// we really want the negative inverse, and -DV < y < DV
return 0<(// y == 1/x mod 2^16
// last step - calculate inverse mod DV directly;
// assumes 16 < DB <= 32 and assumes ability to handle 48-bit ints
t=(// y == 1/x mod 2^8
t=(// y == 1/x mod 2^4
t=(t=t*(2-(15&e)*t)&15)*(2-(255&e)*t)&255)*(2-((65535&e)*t&65535))&65535)*(2-e*t%this.DV)%this.DV)?this.DV-t:-t}
// Montgomery reduction
function Montgomery(e){this.m=e,this.mp=e.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}
// xR mod m
function montConvert(e){var t=nbi();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&0<t.compareTo(BigInteger.ZERO)&&this.m.subTo(t,t),t}
// x/R mod m
function montRevert(e){var t=nbi();return e.copyTo(t),this.reduce(t),t}
// x = x/R mod m (HAC 14.32)
function montReduce(e){for(;e.t<=this.mt2;)// pad x so am has enough room later
e[e.t++]=0;for(var t=0;t<this.m.t;++t){
// faster way of calculating u0 = x[i]*mp mod DV
var i=32767&e[t],s=i*this.mpl+((i*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;
// propagate carry
for(e[
// use am to combine the multiply-shift-add into one call
i=t+this.m.t]+=this.m.am(0,s,e,t,0,this.m.t);e[i]>=e.DV;)e[i]-=e.DV,e[++i]++}e.clamp(),e.drShiftTo(this.m.t,e),0<=e.compareTo(this.m)&&e.subTo(this.m,e)}
// r = "x^2/R mod m"; x != r
function montSqrTo(e,t){e.squareTo(t),this.reduce(t)}
// r = "xy/R mod m"; x,y != r
function montMulTo(e,t,i){e.multiplyTo(t,i),this.reduce(i)}
// (protected) true iff this is even
function bnpIsEven(){return 0==(0<this.t?1&this[0]:this.s)}
// (protected) this^e, e < 2^32, doing sqr and mul with "r" (HAC 14.79)
function bnpExp(e,t){if(4294967295<e||e<1)return BigInteger.ONE;var i=nbi(),s=nbi(),r=t.convert(this),_=nbits(e)-1;for(r.copyTo(i);0<=--_;)if(t.sqrTo(i,s),0<(e&1<<_))t.mulTo(s,r,i);else{var n=i;i=s,s=n}return t.revert(i)}
// (public) this^e % m, 0 <= e < 2^32
function bnModPowInt(e,t){var i;return i=e<256||t.isEven()?new Classic(t):new Montgomery(t),this.exp(e,i)}
// protected
// Downloaded from http://www-cs-students.stanford.edu/~tjw/jsbn/ by Jeremy White on 6/1/2012
/*
 * Copyright (c) 2003-2005  Tom Wu
 * All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY
 * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
 *
 * IN NO EVENT SHALL TOM WU BE LIABLE FOR ANY SPECIAL, INCIDENTAL,
 * INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND, OR ANY DAMAGES WHATSOEVER
 * RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER OR NOT ADVISED OF
 * THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF LIABILITY, ARISING OUT
 * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * In addition, the following condition applies:
 *
 * All redistributions must retain an intact copy of this copyright notice
 * and disclaimer.
 */
// Depends on jsbn.js and rng.js
// Version 1.1: support utf-8 encoding in pkcs1pad2
// convert a (hex) string to a bignum object
function parseBigInt(e,t){return new BigInteger(e,t)}function linebrk(e,t){for(var i="",s=0;s+t<e.length;)i+=e.substring(s,s+t)+"\n",s+=t;return i+e.substring(s,e.length)}function byte2Hex(e){return e<16?"0"+e.toString(16):e.toString(16)}
// PKCS#1 (type 2, random) pad input string s to n bytes, and return a bigint
function pkcs1pad2(e,t){if(t<e.length+11)// TODO: fix for utf-8
return alert("Message too long for RSA"),null;for(var i=new Array,s=e.length-1;0<=s&&0<t;){var r=e.charCodeAt(s--);// encode using utf-8
i[--t]=r<128?r:127<r&&r<2048?(i[--t]=63&r|128,r>>6|192):(i[--t]=63&r|128,i[--t]=r>>6&63|128,r>>12|224)}i[--t]=0;for(var _=new SecureRandom,n=new Array;2<t;){for(// random non-zero pad
n[0]=0;0==n[0];)_.nextBytes(n);i[--t]=n[0]}return i[--t]=2,i[--t]=0,new BigInteger(i)}
// "empty" RSA key constructor
function RSAKey(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}
// Set the public key fields N and e from hex strings
function RSASetPublic(e,t){null!=e&&null!=t&&0<e.length&&0<t.length?(this.n=parseBigInt(e,16),this.e=parseInt(t,16)):alert("Invalid RSA public key")}
// Perform raw public operation on "x": return x^e (mod n)
function RSADoPublic(e){return e.modPowInt(this.e,this.n)}
// Return the PKCS#1 RSA encryption of "text" as an even-length hex string
function RSAEncrypt(e){var t=pkcs1pad2(e,this.n.bitLength()+7>>3);if(null==t)return null;var i=this.doPublic(t);if(null==i)return null;var s=i.toString(16);return 0==(1&s.length)?s:"0"+s}
// Return the PKCS#1 RSA encryption of "text" as a Base64-encoded string
//function RSAEncryptB64(text) {
//  var h = this.encrypt(text);
//  if(h) return hex2b64(h); else return null;
//}
// protected
// Downloaded from http://www-cs-students.stanford.edu/~tjw/jsbn/ by Jeremy White on 6/1/2012
/*
 * Copyright (c) 2003-2005  Tom Wu
 * All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY
 * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
 *
 * IN NO EVENT SHALL TOM WU BE LIABLE FOR ANY SPECIAL, INCIDENTAL,
 * INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND, OR ANY DAMAGES WHATSOEVER
 * RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER OR NOT ADVISED OF
 * THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF LIABILITY, ARISING OUT
 * OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * In addition, the following condition applies:
 *
 * All redistributions must retain an intact copy of this copyright notice
 * and disclaimer.
 */
// prng4.js - uses Arcfour as a PRNG
function Arcfour(){this.i=0,this.j=0,this.S=new Array}
// Initialize arcfour context from key, an array of ints, each from [0..255]
function ARC4init(e){var t,i,s;for(t=0;t<256;++t)this.S[t]=t;for(t=i=0;t<256;++t)i=i+this.S[t]+e[t%e.length]&255,s=this.S[t],this.S[t]=this.S[i],this.S[i]=s;this.i=0,this.j=0}function ARC4next(){var e;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,e=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=e,this.S[e+this.S[this.i]&255]}
// Plug in your RNG constructor here
function prng_newstate(){return new Arcfour}
// Pool size must be a multiple of 4 and greater than 32.
// An array of bytes the size of the pool will be passed to init()
Classic.prototype.convert=cConvert,Classic.prototype.revert=cRevert,Classic.prototype.reduce=cReduce,Classic.prototype.mulTo=cMulTo,Classic.prototype.sqrTo=cSqrTo,Montgomery.prototype.convert=montConvert,Montgomery.prototype.revert=montRevert,Montgomery.prototype.reduce=montReduce,Montgomery.prototype.mulTo=montMulTo,Montgomery.prototype.sqrTo=montSqrTo,BigInteger.prototype.copyTo=bnpCopyTo,BigInteger.prototype.fromInt=bnpFromInt,BigInteger.prototype.fromString=bnpFromString,BigInteger.prototype.clamp=bnpClamp,BigInteger.prototype.dlShiftTo=bnpDLShiftTo,BigInteger.prototype.drShiftTo=bnpDRShiftTo,BigInteger.prototype.lShiftTo=bnpLShiftTo,BigInteger.prototype.rShiftTo=bnpRShiftTo,BigInteger.prototype.subTo=bnpSubTo,BigInteger.prototype.multiplyTo=bnpMultiplyTo,BigInteger.prototype.squareTo=bnpSquareTo,BigInteger.prototype.divRemTo=bnpDivRemTo,BigInteger.prototype.invDigit=bnpInvDigit,BigInteger.prototype.isEven=bnpIsEven,BigInteger.prototype.exp=bnpExp,
// public
BigInteger.prototype.toString=bnToString,BigInteger.prototype.negate=bnNegate,BigInteger.prototype.abs=bnAbs,BigInteger.prototype.compareTo=bnCompareTo,BigInteger.prototype.bitLength=bnBitLength,BigInteger.prototype.mod=bnMod,BigInteger.prototype.modPowInt=bnModPowInt,
// "constants"
BigInteger.ZERO=nbv(0),BigInteger.ONE=nbv(1),RSAKey.prototype.doPublic=RSADoPublic,
// public
RSAKey.prototype.setPublic=RSASetPublic,RSAKey.prototype.encrypt=RSAEncrypt,Arcfour.prototype.init=ARC4init,Arcfour.prototype.next=ARC4next;var rng_state,rng_pool,rng_pptr,rng_psize=256;
// Mix in a 32-bit integer into the pool
function rng_seed_int(e){rng_pool[rng_pptr++]^=255&e,rng_pool[rng_pptr++]^=e>>8&255,rng_pool[rng_pptr++]^=e>>16&255,rng_pool[rng_pptr++]^=e>>24&255,rng_psize<=rng_pptr&&(rng_pptr-=rng_psize)}
// Mix in the current time (w/milliseconds) into the pool
function rng_seed_time(){rng_seed_int((new Date).getTime())}
// Initialize the pool with junk if needed.
if(null==rng_pool){var t;if(rng_pool=new Array,rng_pptr=0,"Netscape"==navigator.appName&&navigator.appVersion<"5"&&window.crypto){
// Extract entropy (256 bits) from NS4 RNG if available
var z=window.crypto.random(32);for(t=0;t<z.length;++t)rng_pool[rng_pptr++]=255&z.charCodeAt(t)}for(;rng_pptr<rng_psize;)// extract some randomness from Math.random()
t=Math.floor(65536*Math.random()),rng_pool[rng_pptr++]=t>>>8,rng_pool[rng_pptr++]=255&t;rng_pptr=0,rng_seed_time()}function rng_get_byte(){if(null==rng_state){for(rng_seed_time(),(rng_state=prng_newstate()).init(rng_pool),rng_pptr=0;rng_pptr<rng_pool.length;++rng_pptr)rng_pool[rng_pptr]=0;rng_pptr=0}
// TODO: allow reseeding after first request
return rng_state.next()}function rng_get_bytes(e){var t;for(t=0;t<e.length;++t)e[t]=rng_get_byte()}function SecureRandom(){}SecureRandom.prototype.nextBytes=rng_get_bytes;
/*
 * A JavaScript implementation of the Secure Hash Algorithm, SHA-1, as defined
 * in FIPS 180-1
 * Version 2.2 Copyright Paul Johnston 2000 - 2009.
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 * Distributed under the BSD License
 * See http://pajhome.org.uk/crypt/md5 for details.
 */
/* Downloaded 6/1/2012 from the above address by Jeremy White.
    License reproduce here for completeness:

Copyright (c) 1998 - 2009, Paul Johnston & Contributors
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

Neither the name of the author nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

 */
/*
 * Configurable variables. You may need to tweak these to be compatible with
 * the server-side, but the defaults work in most cases.
 */
var hexcase=0,b64pad="";/* hex output format. 0 - lowercase; 1 - uppercase        */ /* base-64 pad character. "=" for strict RFC compliance   */
/*
 * These are the functions you'll usually want to call
 * They take string arguments and return either hex or base-64 encoded strings
 */
function hex_sha1(e){return rstr2hex(rstr_sha1(str2rstr_utf8(e)))}function b64_sha1(e){return rstr2b64(rstr_sha1(str2rstr_utf8(e)))}function any_sha1(e,t){return rstr2any(rstr_sha1(str2rstr_utf8(e)),t)}function hex_hmac_sha1(e,t){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(e),str2rstr_utf8(t)))}function b64_hmac_sha1(e,t){return rstr2b64(rstr_hmac_sha1(str2rstr_utf8(e),str2rstr_utf8(t)))}function any_hmac_sha1(e,t,i){return rstr2any(rstr_hmac_sha1(str2rstr_utf8(e),str2rstr_utf8(t)),i)}
/*
 * Perform a simple self-test to see if the VM is working
 */function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}
/*
 * Calculate the SHA1 of a raw string
 */function rstr_sha1(e){return binb2rstr(binb_sha1(rstr2binb(e),8*e.length))}
/*
 * Calculate the HMAC-SHA1 of a key and some data (raw strings)
 */function rstr_hmac_sha1(e,t){var i=rstr2binb(e);16<i.length&&(i=binb_sha1(i,8*e.length));for(var s=Array(16),r=Array(16),_=0;_<16;_++)s[_]=909522486^i[_],r[_]=1549556828^i[_];var n=binb_sha1(s.concat(rstr2binb(t)),512+8*t.length);return binb2rstr(binb_sha1(r.concat(n),672))}
/*
 * Convert a raw string to a hex string
 */function rstr2hex(e){for(var t,i=hexcase?"0123456789ABCDEF":"0123456789abcdef",s="",r=0;r<e.length;r++)t=e.charCodeAt(r),s+=i.charAt(t>>>4&15)+i.charAt(15&t);return s}
/*
 * Convert a raw string to a base-64 string
 */function rstr2b64(e){for(var t="",i=e.length,s=0;s<i;s+=3)for(var r=e.charCodeAt(s)<<16|(s+1<i?e.charCodeAt(s+1)<<8:0)|(s+2<i?e.charCodeAt(s+2):0),_=0;_<4;_++)8*s+6*_>8*e.length?t+=b64pad:t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(r>>>6*(3-_)&63);return t}
/*
 * Convert a raw string to an arbitrary string encoding
 */function rstr2any(e,t){var i,s,r,_,n=t.length,a=Array(),o=Array(Math.ceil(e.length/2));for(i=0;i<o.length;i++)o[i]=e.charCodeAt(2*i)<<8|e.charCodeAt(2*i+1);
/*
   * Repeatedly perform a long division. The binary array forms the dividend,
   * the length of the encoding is the divisor. Once computed, the quotient
   * forms the dividend for the next step. We stop when the dividend is zero.
   * All remainders are stored for later use.
   */for(;0<o.length;){for(_=Array(),i=r=0;i<o.length;i++)r=(r<<16)+o[i],r-=(s=Math.floor(r/n))*n,(0<_.length||0<s)&&(_[_.length]=s);a[a.length]=r,o=_}
/* Convert the remainders to the output string */var c="";for(i=a.length-1;0<=i;i--)c+=t.charAt(a[i]);
/* Append leading zero equivalents */var h=Math.ceil(8*e.length/(Math.log(t.length)/Math.log(2)));for(i=c.length;i<h;i++)c=t[0]+c;return c}
/*
 * Encode a string as utf-8.
 * For efficiency, this assumes the input is valid utf-16.
 */function str2rstr_utf8(e){for(var t,i,s="",r=-1;++r<e.length;)
/* Decode utf-16 surrogate pairs */
t=e.charCodeAt(r),i=r+1<e.length?e.charCodeAt(r+1):0,55296<=t&&t<=56319&&56320<=i&&i<=57343&&(t=65536+((1023&t)<<10)+(1023&i),r++)
/* Encode output as utf-8 */,t<=127?s+=String.fromCharCode(t):t<=2047?s+=String.fromCharCode(192|t>>>6&31,128|63&t):t<=65535?s+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):t<=2097151&&(s+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return s}
/*
 * Encode a string as utf-16
 */function str2rstr_utf16le(e){for(var t="",i=0;i<e.length;i++)t+=String.fromCharCode(255&e.charCodeAt(i),e.charCodeAt(i)>>>8&255);return t}function str2rstr_utf16be(e){for(var t="",i=0;i<e.length;i++)t+=String.fromCharCode(e.charCodeAt(i)>>>8&255,255&e.charCodeAt(i));return t}
/*
 * Convert a raw string to an array of big-endian words
 * Characters >255 have their high-byte silently ignored.
 */function rstr2binb(e){for(var t=Array(e.length>>2),i=0;i<t.length;i++)t[i]=0;for(i=0;i<8*e.length;i+=8)t[i>>5]|=(255&e.charCodeAt(i/8))<<24-i%32;return t}
/*
 * Convert an array of big-endian words to a string
 */function binb2rstr(e){for(var t="",i=0;i<32*e.length;i+=8)t+=String.fromCharCode(e[i>>5]>>>24-i%32&255);return t}
/*
 * Calculate the SHA-1 of an array of big-endian words, and a bit length
 */function binb_sha1(e,t){
/* append padding */
e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var i=Array(80),s=1732584193,r=-271733879,_=-1732584194,n=271733878,a=-1009589776,o=0;o<e.length;o+=16){for(var c=s,h=r,p=_,u=n,d=a,l=0;l<80;l++){i[l]=l<16?e[o+l]:bit_rol(i[l-3]^i[l-8]^i[l-14]^i[l-16],1);var f=safe_add(safe_add(bit_rol(s,5),sha1_ft(l,r,_,n)),safe_add(safe_add(a,i[l]),sha1_kt(l)));a=n,n=_,_=bit_rol(r,30),r=s,s=f}s=safe_add(s,c),r=safe_add(r,h),_=safe_add(_,p),n=safe_add(n,u),a=safe_add(a,d)}return Array(s,r,_,n,a)}
/*
 * Perform the appropriate triplet combination function for the current
 * iteration
 */function sha1_ft(e,t,i,s){return e<20?t&i|~t&s:e<40?t^i^s:e<60?t&i|t&s|i&s:t^i^s}
/*
 * Determine the appropriate additive constant for the current iteration
 */function sha1_kt(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}
/*
 * Add integers, wrapping at 2^32. This uses 16-bit operations internally
 * to work around bugs in some JS interpreters.
 */function safe_add(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}
/*
 * Bitwise rotate a 32-bit number to the left.
 */function bit_rol(e,t){return e<<t|e>>>32-t}
/*
   Copyright (C) 2012 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
var SHA_DIGEST_LENGTH=20;
/*----------------------------------------------------------------------------
**  General ticket RSA encryption functions - just good enough to
**      support what we need to send back an encrypted ticket.
**--------------------------------------------------------------------------*/
/*----------------------------------------------------------------------------
**  OAEP padding functions.  Inspired by the OpenSSL implementation.
**--------------------------------------------------------------------------*/function MGF1(e,t){var i,s,r;for(r=i=0;r<e.length;i++){var _=new String;for(s=0;s<t.length;s++)_+=String.fromCharCode(t[s]);_+=String.fromCharCode(i>>24&255),_+=String.fromCharCode(i>>16&255),_+=String.fromCharCode(i>>8&255);var n=rstr_sha1(_+=String.fromCharCode(255&i));for(s=0;s<n.length&&r<e.length;s++,r++)e[r]=n.charCodeAt(s)}}function RSA_padding_add_PKCS1_OAEP(e,t,i){var s=new Array(SHA_DIGEST_LENGTH);(new SecureRandom).nextBytes(s);var r,_=e-1-s.length,n=new Array(_),a=_-t.length-1;if(void 0===i&&(i=""),a<SHA_DIGEST_LENGTH)return console.log("Error - data too large for key size."),null;for(r=0;r<a;r++)n[r]=0;var o=rstr_sha1(i);for(r=0;r<o.length;r++)n[r]=o.charCodeAt(r);for(n[a]=1,r=0;r<t.length;r++)n[r+a+1]=t.charCodeAt(r);var c=new Array(_);if(MGF1(c,s)<0)return null;for(r=0;r<c.length;r++)n[r]^=c[r];var h=Array(SHA_DIGEST_LENGTH);if(MGF1(h,n)<0)return null;for(r=0;r<h.length;r++)s[r]^=h[r];var p=new String;for(p+=String.fromCharCode(0),r=0;r<s.length;r++)p+=String.fromCharCode(s[r]);for(r=0;r<n.length;r++)p+=String.fromCharCode(n[r]);return p}function asn_get_length(e,t){var i=e[t++];if(128<i){if(129!=i)return console.log("Error:  we lazily don't support keys bigger than 255 bytes.  It'd be easy to fix."),null;i=e[t++]}return[t,i]}function find_sequence(e,t){return t=t||0,48!=e[t++]?(console.log("Error:  public key should start with a sequence flag."),null):asn_get_length(e,t)||null}
/*----------------------------------------------------------------------------
**  Extract an RSA key from a memory buffer
**--------------------------------------------------------------------------*/function create_rsa_from_mb(e,t){var i,s,r,_,n,a=new Uint8Array(e);if(!(
/* We have a sequence which contains a sequence followed by a bit string */
s=find_sequence(a,t)))return null;if(!(s=find_sequence(a,t=s[0])))return null;
/* Skip over the contained sequence */if(t=s[0]+s[1],3!=a[t++])return console.log("Error: expecting bit string next."),null;
/* Get the bit string, which is *itself* a sequence.  Having fun yet? */if(!(i=asn_get_length(a,t)))return null;if(0!=a[t=i[0]]&&48!=a[t+1])return console.log("Error: unexpected values in bit string."),null;
/* Okay, now we have a sequence of two binary values, we hope. */if(!(s=find_sequence(a,t+1)))return null;if(t=s[0],2!=a[t++])return console.log("Error: expecting integer n next."),null;if(!(i=asn_get_length(a,t)))return null;for(t=i[0],r=new Array(i[1]),_=0;_<i[1];_++)r[_]=a[t+_];if((n=new RSAKey).n=new BigInteger(r),t+=i[1],2!=a[t++])return console.log("Error: expecting integer e next."),null;if(!(i=asn_get_length(a,t)))return null;for(t=i[0],n.e=a[t++],_=1;_<i[1];_++)n.e<<=8,n.e|=a[t++];return n}function rsa_encrypt(e,t){var i,s=[],r=RSA_padding_add_PKCS1_OAEP(e.n.bitLength()+7>>3,t);if(!r)return null;var _=new Array(r.length);for(i=0;i<r.length;i++)_[i]=r.charCodeAt(i);var n=new BigInteger(_),a=e.doPublic(n).toString(16);for(0!=(1&a.length)&&(a="0"+a),i=0;i<a.length;i+=2)s[i/2]=parseInt(a.substring(i,i+2),16);return s}
/*
   Copyright (C) 2014 by Jeremy P. White <jwhite@codeweavers.com>

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
/*----------------------------------------------------------------------------
**  resize.js
**      This bit of Javascript is a set of logic to help with window
**  resizing, using the agent channel to request screen resizes.
**
**  It's a bit tricky, as we want to wait for resizing to settle down
**  before sending a size.  Further, while horizontal resizing to use the whole
**  browser width is fairly easy to arrange with css, resizing an element to use
**  the whole vertical space (or to force a middle div to consume the bulk of the browser
**  window size) is tricky, and the consensus seems to be that Javascript is
**  the only right way to do it.
**--------------------------------------------------------------------------*/
function resize_helper(e){var t=document.getElementById(e.screen_id).clientWidth,i=document.getElementById(e.message_id),s=window.innerHeight-20;
/* Screen height based on debug console visibility  */
"none"==window.getComputedStyle(i).getPropertyValue("display")?s-=parseInt(window.getComputedStyle(i).getPropertyValue("height"),10):
/* Show both div elements - spice-area and message-div */
s=s-i.offsetHeight-i.clientHeight
/* Xorg requires height be a multiple of 8; round up */;0<s%8&&(s+=8-s%8)
/* Xorg requires width be a multiple of 8; round up */,0<t%8&&(t+=8-t%8),e.resize_window(0,t,s,32,0,0),e.spice_resize_timer=void 0}function handle_resize(e){var t=window.spice_connection;t&&t.spice_resize_timer&&(window.clearTimeout(t.spice_resize_timer),t.spice_resize_timer=void 0),t.spice_resize_timer=window.setTimeout(resize_helper,200,t)}
/*
   Copyright (C) 2014 Red Hat, Inc.

   This file is part of spice-html5.

   spice-html5 is free software: you can redistribute it and/or modify
   it under the terms of the GNU Lesser General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   spice-html5 is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Lesser General Public License for more details.

   You should have received a copy of the GNU Lesser General Public License
   along with spice-html5.  If not, see <http://www.gnu.org/licenses/>.
*/
function SpiceFileXferTask(e,t){this.id=e,this.file=t}function handle_file_dragover(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}function handle_file_drop(e){var t=window.spice_connection,i=e.dataTransfer.files;e.stopPropagation(),e.preventDefault();for(var s=i.length-1;0<=s;s--)i[s].type&&// do not copy a directory
t.file_xfer_start(i[s])}SpiceFileXferTask.prototype.create_progressbar=function(){var e=this,t=document.createElement("input");this.progressbar_container=document.createElement("div"),this.progressbar=document.createElement("progress"),t.type="button",t.value="Cancel",t.style.float="right",t.onclick=function(){e.cancelled=!0,e.remove_progressbar()},this.progressbar.setAttribute("max",this.file.size),this.progressbar.setAttribute("value",0),this.progressbar.style.width="100%",this.progressbar.style.margin="4px auto",this.progressbar.style.display="inline-block",this.progressbar_container.style.width="90%",this.progressbar_container.style.margin="auto",this.progressbar_container.style.padding="4px",this.progressbar_container.textContent=this.file.name,this.progressbar_container.appendChild(t),this.progressbar_container.appendChild(this.progressbar),document.getElementById("spice-xfer-area").appendChild(this.progressbar_container)},SpiceFileXferTask.prototype.update_progressbar=function(e){this.progressbar.setAttribute("value",e)},SpiceFileXferTask.prototype.remove_progressbar=function(){this.progressbar_container&&this.progressbar_container.parentNode&&this.progressbar_container.parentNode.removeChild(this.progressbar_container)};